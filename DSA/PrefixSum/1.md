# Chapter 1: Foundations - Deep Dive

## 1.1 Prefix Sum Basics

### What is a Prefix Sum?

A **prefix sum** (also called cumulative sum) is a technique where we store the running total of elements from the beginning of an array up to each position. This allows us to calculate the sum of any subarray in constant time.

#### Formal Definition

Given an array `arr[]` of size `n`:
```
prefix[i] = arr[0] + arr[1] + arr[2] + ... + arr[i]
```

### Building a Prefix Sum Array

#### Example Array
```
arr = [3, 1, 4, 1, 5, 9, 2]
```

#### Visual Construction

```
Index:     0   1   2   3   4   5   6
Array:     3   1   4   1   5   9   2
           â†“   â†“   â†“   â†“   â†“   â†“   â†“
Prefix:    3   4   8   9  14  23  25

Calculation:
prefix[0] = 3
prefix[1] = 3 + 1 = 4
prefix[2] = 3 + 1 + 4 = 8
prefix[3] = 3 + 1 + 4 + 1 = 9
prefix[4] = 3 + 1 + 4 + 1 + 5 = 14
prefix[5] = 3 + 1 + 4 + 1 + 5 + 9 = 23
prefix[6] = 3 + 1 + 4 + 1 + 5 + 9 + 2 = 25
```

### Code Implementation

#### Method 1: Separate Prefix Array

```python
def build_prefix_sum(arr):
    """
    Build a prefix sum array from the input array.
    Time: O(n), Space: O(n)
    """
    n = len(arr)
    prefix = [0] * n
    
    prefix[0] = arr[0]
    for i in range(1, n):
        prefix[i] = prefix[i-1] + arr[i]
    
    return prefix

# Example
arr = [3, 1, 4, 1, 5, 9, 2]
prefix = build_prefix_sum(arr)
print(prefix)  # Output: [3, 4, 8, 9, 14, 23, 25]
```

#### Method 2: With Zero Padding (Recommended)

```python
def build_prefix_sum_padded(arr):
    """
    Build prefix sum with 0 at start to simplify calculations.
    prefix[0] = 0, prefix[i] = sum of first i elements
    Time: O(n), Space: O(n+1)
    """
    n = len(arr)
    prefix = [0] * (n + 1)  # Extra space at start
    
    for i in range(n):
        prefix[i+1] = prefix[i] + arr[i]
    
    return prefix

# Example
arr = [3, 1, 4, 1, 5, 9, 2]
prefix = build_prefix_sum_padded(arr)
print(prefix)  # Output: [0, 3, 4, 8, 9, 14, 23, 25]
```

**Why padding?** It eliminates edge cases when calculating range sums!

---

## 1.2 The Magic Formula: Range Sum in O(1)

### The Core Insight

Once we have the prefix sum array, we can calculate the sum of ANY subarray in **O(1) time**!

#### Formula
```
sum(left, right) = prefix[right] - prefix[left-1]
```

### Visual Explanation

Let's find `sum(2, 5)` in our array `[3, 1, 4, 1, 5, 9, 2]`

```
Original Array:
Index:     0   1   2   3   4   5   6
Array:     3   1   4   1   5   9   2
               |â†  Range  â†’|
               2   3   4   5

We want: arr[2] + arr[3] + arr[4] + arr[5] = 4 + 1 + 5 + 9 = 19

Using Prefix Sum:
prefix[5] = sum(0 to 5) = 3 + 1 + 4 + 1 + 5 + 9 = 23
prefix[1] = sum(0 to 1) = 3 + 1 = 4

sum(2, 5) = prefix[5] - prefix[1]
          = 23 - 4
          = 19 âœ“
```

#### Why Does This Work?

```
prefix[5] contains:    arr[0] + arr[1] + arr[2] + arr[3] + arr[4] + arr[5]
prefix[1] contains:    arr[0] + arr[1]
                       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
prefix[5] - prefix[1]: arr[2] + arr[3] + arr[4] + arr[5]
```

When we subtract, the common elements cancel out!

### Code Implementation

```python
def range_sum(prefix, left, right):
    """
    Calculate sum of elements from index left to right (inclusive).
    Assumes prefix array WITHOUT padding (standard method).
    Time: O(1)
    """
    if left == 0:
        return prefix[right]
    return prefix[right] - prefix[left-1]

# Example
arr = [3, 1, 4, 1, 5, 9, 2]
prefix = build_prefix_sum(arr)

print(range_sum(prefix, 0, 3))  # 3+1+4+1 = 9
print(range_sum(prefix, 2, 5))  # 4+1+5+9 = 19
print(range_sum(prefix, 1, 1))  # 1 = 1
```

#### With Padded Array (Cleaner!)

```python
def range_sum_padded(prefix, left, right):
    """
    Calculate sum using padded prefix array.
    No edge case handling needed!
    Time: O(1)
    """
    return prefix[right+1] - prefix[left]

# Example with padded array
arr = [3, 1, 4, 1, 5, 9, 2]
prefix = build_prefix_sum_padded(arr)

print(range_sum_padded(prefix, 0, 3))  # 3+1+4+1 = 9
print(range_sum_padded(prefix, 2, 5))  # 4+1+5+9 = 19
print(range_sum_padded(prefix, 1, 1))  # 1 = 1
```

---

## 1.3 Complete Example: Multiple Queries

### Problem
Given an array and Q queries, each query asks for sum of elements from index L to R.

#### Naive Approach - O(Q Ã— N)
```python
def naive_range_queries(arr, queries):
    """
    For each query, iterate through the range.
    Time: O(Q Ã— N) - too slow for large inputs!
    """
    results = []
    for left, right in queries:
        total = sum(arr[left:right+1])
        results.append(total)
    return results
```

#### Optimized with Prefix Sum - O(N + Q)
```python
def optimized_range_queries(arr, queries):
    """
    Build prefix sum once, answer queries in O(1) each.
    Time: O(N + Q) - much better!
    """
    # Build prefix sum - O(N)
    n = len(arr)
    prefix = [0] * (n + 1)
    for i in range(n):
        prefix[i+1] = prefix[i] + arr[i]
    
    # Answer queries - O(Q)
    results = []
    for left, right in queries:
        total = prefix[right+1] - prefix[left]
        results.append(total)
    
    return results

# Example
arr = [3, 1, 4, 1, 5, 9, 2]
queries = [
    (0, 3),  # sum from 0 to 3
    (2, 5),  # sum from 2 to 5
    (1, 6),  # sum from 1 to 6
]

results = optimized_range_queries(arr, queries)
print(results)  # [9, 19, 21]
```

---

## 1.4 Important Edge Cases and Notes

### Edge Case 1: Single Element Range
```python
# Query: sum(3, 3) - only arr[3]
arr = [3, 1, 4, 1, 5, 9, 2]
prefix = [0, 3, 4, 8, 9, 14, 23, 25]

result = prefix[3+1] - prefix[3]
       = prefix[4] - prefix[3]
       = 9 - 8
       = 1 âœ“
```

### Edge Case 2: Full Array
```python
# Query: sum(0, 6) - entire array
result = prefix[6+1] - prefix[0]
       = prefix[7] - prefix[0]
       = 25 - 0
       = 25 âœ“
```

### Edge Case 3: Empty Result (Invalid Query)
```python
# What if left > right? This is invalid!
# Always validate: assert left <= right
```

---

## 1.5 Common Pitfalls and How to Avoid Them

### âŒ Pitfall 1: Off-by-One Errors

**Wrong:**
```python
# Incorrect index calculation
sum_range = prefix[right] - prefix[left]  # Missing elements!
```

**Correct:**
```python
# With padding (recommended)
sum_range = prefix[right+1] - prefix[left]

# Without padding
if left == 0:
    sum_range = prefix[right]
else:
    sum_range = prefix[right] - prefix[left-1]
```

### âŒ Pitfall 2: Not Handling Left = 0

**Wrong:**
```python
# This will give index error when left = 0!
result = prefix[right] - prefix[left-1]  # left-1 = -1!
```

**Correct:**
```python
# Check for boundary
if left == 0:
    result = prefix[right]
else:
    result = prefix[right] - prefix[left-1]

# OR use padding to avoid this check entirely!
```

### âŒ Pitfall 3: Forgetting to Build Prefix Array

**Wrong:**
```python
def query(arr, left, right):
    # Directly using arr as if it's prefix sum
    return arr[right] - arr[left-1]  # WRONG!
```

**Correct:**
```python
def query(prefix, left, right):
    # Use properly built prefix array
    return prefix[right+1] - prefix[left]
```

---

## 1.6 Complexity Analysis

### Time Complexity
- **Building prefix sum:** O(n)
- **Range query:** O(1)
- **Q queries:** O(n + Q)

### Space Complexity
- **Prefix array:** O(n)

### When to Use Prefix Sum?
âœ… Multiple range sum queries on static array
âœ… Need O(1) query time
âœ… Array doesn't change frequently

âŒ Array updates frequently (use Segment Tree instead)
âŒ Need other operations like min/max (use different data structure)

---

## 1.7 Practice Problems

### Beginner
1. **Range Sum Query - Immutable** (LeetCode 303)
   - Perfect introduction to prefix sum
   
2. **Find Pivot Index** (LeetCode 724)
   - Use prefix sum to find balance point

### Intermediate
3. **Product of Array Except Self** (LeetCode 238)
   - Apply prefix concept to products
   
4. **Minimum Size Subarray Sum** (LeetCode 209)
   - Combine with sliding window

---

## 1.8 Key Takeaways

ðŸŽ¯ **Core Concept:** Prefix sum converts expensive range operations into O(1) lookups

ðŸ”‘ **Magic Formula:** `sum(L, R) = prefix[R] - prefix[L-1]`

ðŸ’¡ **Pro Tip:** Use padding (`prefix[0] = 0`) to eliminate edge cases

âš ï¸ **Watch Out:** Off-by-one errors are the most common mistake

ðŸš€ **Next Step:** Learn how HashMap combines with prefix sum for powerful pattern matching!