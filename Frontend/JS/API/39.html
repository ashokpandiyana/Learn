<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chapter 39: Page Visibility API</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); color: #e4e4e4; line-height: 1.7; padding: 40px 20px; min-height: 100vh; }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { font-size: 2.5rem; background: linear-gradient(90deg, #4ade80, #22d3ee, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
    .subtitle { color: #888; font-size: 1.1rem; margin-bottom: 40px; }
    h2 { color: #4ade80; font-size: 1.6rem; margin: 40px 0 20px; padding-bottom: 10px; border-bottom: 2px solid #22d3ee33; }
    h3 { color: #22d3ee; font-size: 1.2rem; margin: 25px 0 15px; }
    p { margin-bottom: 16px; color: #ccc; }
    .concept-box { background: linear-gradient(135deg, #1a3a2a 0%, #0f172a 100%); border-radius: 16px; padding: 25px; margin: 25px 0; border-left: 4px solid #4ade80; }
    .warning { background: linear-gradient(135deg, #4a2c2c 0%, #3d1f1f 100%); border-left-color: #ff6b6b; }
    .tip { background: linear-gradient(135deg, #1f4a2c 0%, #1f3d2a 100%); border-left-color: #4ade80; }
    .info { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); border-left-color: #22d3ee; }
    code { background: #0d1117; padding: 3px 8px; border-radius: 4px; font-family: 'Fira Code', monospace; font-size: 0.9em; color: #4ade80; }
    pre { background: #0d1117; border-radius: 12px; padding: 20px; overflow-x: auto; margin: 20px 0; border: 1px solid #ffffff15; }
    pre code { padding: 0; background: none; }
    .keyword { color: #c792ea; }
    .function { color: #82aaff; }
    .string { color: #c3e88d; }
    .comment { color: #676e95; }
    .number { color: #f78c6c; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ffffff15; }
    th { background: #4ade8033; color: #4ade80; }
    tr:hover { background: #ffffff08; }
    .interactive-demo { background: #0d1117; border-radius: 16px; padding: 25px; margin: 30px 0; border: 1px solid #22d3ee44; }
    button { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: #0f172a; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.2s; margin: 5px; }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px #4ade8055; }
    button.secondary { background: linear-gradient(135deg, #22d3ee, #0891b2); }
    button.tertiary { background: linear-gradient(135deg, #a78bfa, #7c3aed); color: white; }
    .visibility-display { background: linear-gradient(135deg, #1a3a2a, #0f172a); border-radius: 16px; padding: 30px; text-align: center; margin: 20px 0; border: 3px solid #4ade80; transition: all 0.3s; }
    .visibility-display.hidden { border-color: #ef4444; background: linear-gradient(135deg, #3d1f1f, #0f172a); }
    .visibility-icon { font-size: 5rem; margin-bottom: 20px; transition: all 0.3s; }
    .visibility-status { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
    .visibility-display.hidden .visibility-status { color: #ef4444; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
    .stat-card { background: #1a1a3e; padding: 20px; border-radius: 12px; text-align: center; }
    .stat-value { font-size: 2rem; font-weight: bold; color: #4ade80; font-family: monospace; }
    .stat-label { font-size: 0.85rem; color: #888; margin-top: 5px; }
    .log-output { background: #0a0a15; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.85rem; max-height: 200px; overflow-y: auto; margin: 15px 0; }
    .log-entry { padding: 5px 0; border-bottom: 1px solid #ffffff10; }
    .log-entry.visible { color: #4ade80; }
    .log-entry.hidden { color: #ef4444; }
    .use-case-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
    .use-case { background: linear-gradient(135deg, #1e1b4b, #0f172a); padding: 20px; border-radius: 12px; border: 1px solid #22d3ee33; }
    .use-case h4 { color: #22d3ee; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    .use-case p { font-size: 0.9rem; color: #aaa; margin: 0; }
    ul { margin-left: 25px; margin-bottom: 15px; }
    li { margin-bottom: 8px; color: #ccc; }
    .diagram { background: #0d1117; border-radius: 16px; padding: 30px; margin: 30px 0; }
    .state-flow { display: flex; justify-content: center; align-items: center; gap: 30px; flex-wrap: wrap; }
    .state-box { padding: 20px 30px; border-radius: 12px; text-align: center; min-width: 120px; }
    .state-box.visible { background: linear-gradient(135deg, #4ade80, #22c55e); color: #0f172a; }
    .state-box.hidden { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .state-arrow { font-size: 2rem; color: #22d3ee; }
    .timer-demo { background: #1a1a3e; border-radius: 12px; padding: 30px; text-align: center; margin: 20px 0; }
    .timer-value { font-size: 4rem; font-weight: bold; color: #4ade80; font-family: monospace; }
    .timer-status { font-size: 0.9rem; color: #888; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üëÅÔ∏è Chapter 39: Page Visibility API</h1>
    <p class="subtitle">Detecting When Your Page is Visible or Hidden</p>

    <h2>üéØ What is the Page Visibility API?</h2>
    <p>The <strong>Page Visibility API</strong> lets you know when a webpage is visible or hidden to the user. This happens when users switch tabs, minimize the browser, or lock their screen. It's essential for optimizing resource usage and improving user experience.</p>

    <div class="concept-box">
      <h3>üí° Why It Matters</h3>
      <ul style="margin-top: 10px; margin-left: 20px;">
        <li><strong>Save resources:</strong> Pause heavy operations when page isn't visible</li>
        <li><strong>Accurate analytics:</strong> Track actual time users spend viewing content</li>
        <li><strong>Better UX:</strong> Pause videos/audio when tab is switched</li>
        <li><strong>Battery life:</strong> Reduce CPU usage on hidden pages</li>
        <li><strong>Notifications:</strong> Show notifications when user returns</li>
      </ul>
    </div>

    <h2>üéÆ Live Visibility Demo</h2>
    <div class="interactive-demo">
      <p>Switch to another tab or minimize the browser to see this change:</p>
      
      <div class="visibility-display" id="visibility-box">
        <div class="visibility-icon" id="visibility-icon">üëÅÔ∏è</div>
        <div class="visibility-status" id="visibility-status">Page is VISIBLE</div>
        <div style="color: #888;" id="visibility-state">visibilityState: visible</div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="visible-time">0s</div>
          <div class="stat-label">Time Visible</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="hidden-time">0s</div>
          <div class="stat-label">Time Hidden</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="switch-count">0</div>
          <div class="stat-label">Tab Switches</div>
        </div>
      </div>
      
      <div class="log-output" id="visibility-log"></div>
    </div>

    <h2>üìù Basic Usage</h2>
    <pre><code><span class="comment">// Check current visibility state</span>
console.<span class="function">log</span>(document.visibilityState);  <span class="comment">// 'visible' or 'hidden'</span>
console.<span class="function">log</span>(document.hidden);           <span class="comment">// true or false</span>

<span class="comment">// Listen for visibility changes</span>
document.<span class="function">addEventListener</span>(<span class="string">'visibilitychange'</span>, () => {
    <span class="keyword">if</span> (document.hidden) {
        console.<span class="function">log</span>(<span class="string">'Page is now hidden'</span>);
        <span class="comment">// Pause operations, save state, etc.</span>
    } <span class="keyword">else</span> {
        console.<span class="function">log</span>(<span class="string">'Page is now visible'</span>);
        <span class="comment">// Resume operations, refresh data, etc.</span>
    }
});</code></pre>

    <h2>üìä Visibility States</h2>
    <div class="diagram">
      <div class="state-flow">
        <div class="state-box visible">
          <div style="font-size: 2rem; margin-bottom: 10px;">üëÅÔ∏è</div>
          <strong>visible</strong>
        </div>
        <div class="state-arrow">‚áÑ</div>
        <div class="state-box hidden">
          <div style="font-size: 2rem; margin-bottom: 10px;">üôà</div>
          <strong>hidden</strong>
        </div>
      </div>
    </div>

    <table>
      <tr><th>Property</th><th>Type</th><th>Description</th></tr>
      <tr><td><code>document.visibilityState</code></td><td>String</td><td>'visible' or 'hidden'</td></tr>
      <tr><td><code>document.hidden</code></td><td>Boolean</td><td>true if page is hidden</td></tr>
      <tr><td><code>'visibilitychange'</code></td><td>Event</td><td>Fired when visibility changes</td></tr>
    </table>

    <h2>‚è±Ô∏è Timer Pause Demo</h2>
    <div class="interactive-demo">
      <p>This timer automatically pauses when you switch tabs:</p>
      
      <div class="timer-demo">
        <div class="timer-value" id="timer-value">00:00</div>
        <div class="timer-status" id="timer-status">‚è∏Ô∏è Timer paused - Click Start</div>
      </div>
      
      <div style="text-align: center;">
        <button onclick="startTimer()">‚ñ∂Ô∏è Start</button>
        <button onclick="pauseTimer()" class="secondary">‚è∏Ô∏è Pause</button>
        <button onclick="resetTimer()" class="tertiary">üîÑ Reset</button>
      </div>
    </div>

    <h2>üéØ Common Use Cases</h2>
    <div class="use-case-grid">
      <div class="use-case">
        <h4>üé¨ Video Players</h4>
        <p>Automatically pause video when user switches tabs, resume when they return.</p>
      </div>
      <div class="use-case">
        <h4>üéÆ Games</h4>
        <p>Pause game loop and stop animations to save resources when tab is hidden.</p>
      </div>
      <div class="use-case">
        <h4>üìä Analytics</h4>
        <p>Track actual time users spend viewing your content, not just page open time.</p>
      </div>
      <div class="use-case">
        <h4>üîÑ Auto-Refresh</h4>
        <p>Refresh data when user returns to the page after being away.</p>
      </div>
      <div class="use-case">
        <h4>üîî Notifications</h4>
        <p>Show "Welcome back!" messages or update indicators when user returns.</p>
      </div>
      <div class="use-case">
        <h4>üíæ Auto-Save</h4>
        <p>Save draft content when user switches away from the page.</p>
      </div>
    </div>

    <h2>üõ†Ô∏è Practical Examples</h2>
    
    <h3>Example 1: Video Auto-Pause</h3>
    <pre><code><span class="keyword">const</span> video = document.<span class="function">querySelector</span>(<span class="string">'video'</span>);
<span class="keyword">let</span> wasPlaying = <span class="keyword">false</span>;

document.<span class="function">addEventListener</span>(<span class="string">'visibilitychange'</span>, () => {
    <span class="keyword">if</span> (document.hidden) {
        <span class="comment">// Page hidden - pause video</span>
        wasPlaying = !video.paused;
        <span class="keyword">if</span> (wasPlaying) {
            video.<span class="function">pause</span>();
        }
    } <span class="keyword">else</span> {
        <span class="comment">// Page visible - resume if was playing</span>
        <span class="keyword">if</span> (wasPlaying) {
            video.<span class="function">play</span>();
        }
    }
});</code></pre>

    <h3>Example 2: Analytics Time Tracking</h3>
    <pre><code><span class="keyword">class</span> <span class="function">TimeTracker</span> {
    <span class="function">constructor</span>() {
        <span class="keyword">this</span>.visibleTime = <span class="number">0</span>;
        <span class="keyword">this</span>.lastVisibleStart = Date.<span class="function">now</span>();
        <span class="keyword">this</span>.isVisible = !document.hidden;
        
        document.<span class="function">addEventListener</span>(<span class="string">'visibilitychange'</span>, () => {
            <span class="keyword">this</span>.<span class="function">handleVisibilityChange</span>();
        });
        
        <span class="comment">// Send data when page unloads</span>
        window.<span class="function">addEventListener</span>(<span class="string">'beforeunload'</span>, () => {
            <span class="keyword">this</span>.<span class="function">sendAnalytics</span>();
        });
    }
    
    <span class="function">handleVisibilityChange</span>() {
        <span class="keyword">if</span> (document.hidden) {
            <span class="comment">// Accumulate visible time</span>
            <span class="keyword">this</span>.visibleTime += Date.<span class="function">now</span>() - <span class="keyword">this</span>.lastVisibleStart;
            <span class="keyword">this</span>.isVisible = <span class="keyword">false</span>;
        } <span class="keyword">else</span> {
            <span class="comment">// Start new visible session</span>
            <span class="keyword">this</span>.lastVisibleStart = Date.<span class="function">now</span>();
            <span class="keyword">this</span>.isVisible = <span class="keyword">true</span>;
        }
    }
    
    <span class="function">getTotalVisibleTime</span>() {
        <span class="keyword">let</span> total = <span class="keyword">this</span>.visibleTime;
        <span class="keyword">if</span> (<span class="keyword">this</span>.isVisible) {
            total += Date.<span class="function">now</span>() - <span class="keyword">this</span>.lastVisibleStart;
        }
        <span class="keyword">return</span> total;
    }
    
    <span class="function">sendAnalytics</span>() {
        navigator.<span class="function">sendBeacon</span>(<span class="string">'/analytics'</span>, JSON.<span class="function">stringify</span>({
            visibleTime: <span class="keyword">this</span>.<span class="function">getTotalVisibleTime</span>(),
            pageUrl: location.href
        }));
    }
}

<span class="keyword">const</span> tracker = <span class="keyword">new</span> <span class="function">TimeTracker</span>();</code></pre>

    <h3>Example 3: Auto-Refresh on Return</h3>
    <pre><code><span class="keyword">let</span> lastHiddenTime = <span class="keyword">null</span>;
<span class="keyword">const</span> STALE_THRESHOLD = <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>;  <span class="comment">// 5 minutes</span>

document.<span class="function">addEventListener</span>(<span class="string">'visibilitychange'</span>, () => {
    <span class="keyword">if</span> (document.hidden) {
        <span class="comment">// Record when page was hidden</span>
        lastHiddenTime = Date.<span class="function">now</span>();
    } <span class="keyword">else</span> <span class="keyword">if</span> (lastHiddenTime) {
        <span class="comment">// Check if data is stale</span>
        <span class="keyword">const</span> timeAway = Date.<span class="function">now</span>() - lastHiddenTime;
        
        <span class="keyword">if</span> (timeAway > STALE_THRESHOLD) {
            console.<span class="function">log</span>(<span class="string">'Data is stale, refreshing...'</span>);
            <span class="function">refreshData</span>();
            <span class="function">showNotification</span>(<span class="string">'Welcome back! Data has been refreshed.'</span>);
        }
        
        lastHiddenTime = <span class="keyword">null</span>;
    }
});</code></pre>

    <h3>Example 4: Pause Animation Loop</h3>
    <pre><code><span class="keyword">class</span> <span class="function">AnimationController</span> {
    <span class="function">constructor</span>() {
        <span class="keyword">this</span>.isRunning = <span class="keyword">false</span>;
        <span class="keyword">this</span>.animationId = <span class="keyword">null</span>;
        
        document.<span class="function">addEventListener</span>(<span class="string">'visibilitychange'</span>, () => {
            <span class="keyword">if</span> (document.hidden) {
                <span class="keyword">this</span>.<span class="function">pause</span>();
            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.shouldResume) {
                <span class="keyword">this</span>.<span class="function">resume</span>();
            }
        });
    }
    
    <span class="function">start</span>() {
        <span class="keyword">this</span>.isRunning = <span class="keyword">true</span>;
        <span class="keyword">this</span>.shouldResume = <span class="keyword">true</span>;
        <span class="keyword">this</span>.<span class="function">loop</span>();
    }
    
    <span class="function">loop</span>() {
        <span class="keyword">if</span> (!<span class="keyword">this</span>.isRunning) <span class="keyword">return</span>;
        
        <span class="comment">// Animation logic here</span>
        <span class="keyword">this</span>.<span class="function">update</span>();
        <span class="keyword">this</span>.<span class="function">render</span>();
        
        <span class="keyword">this</span>.animationId = <span class="function">requestAnimationFrame</span>(() => <span class="keyword">this</span>.<span class="function">loop</span>());
    }
    
    <span class="function">pause</span>() {
        <span class="keyword">this</span>.isRunning = <span class="keyword">false</span>;
        <span class="keyword">if</span> (<span class="keyword">this</span>.animationId) {
            <span class="function">cancelAnimationFrame</span>(<span class="keyword">this</span>.animationId);
        }
    }
    
    <span class="function">resume</span>() {
        <span class="keyword">if</span> (!<span class="keyword">this</span>.isRunning) {
            <span class="keyword">this</span>.isRunning = <span class="keyword">true</span>;
            <span class="keyword">this</span>.<span class="function">loop</span>();
        }
    }
}</code></pre>

    <div class="concept-box tip">
      <h3>‚úÖ Best Practices</h3>
      <ul style="margin-left: 20px; margin-top: 10px;">
        <li>Always save state when page becomes hidden (user might close the tab)</li>
        <li>Don't rely solely on visibility API for critical operations</li>
        <li>Consider using <code>beforeunload</code> as a backup</li>
        <li>Use <code>navigator.sendBeacon()</code> for analytics to ensure delivery</li>
        <li>Remember: visible doesn't mean the user is looking‚Äîthey might be in another monitor</li>
      </ul>
    </div>

    <div class="concept-box warning">
      <h3>‚ö†Ô∏è Limitations</h3>
      <ul style="margin-left: 20px; margin-top: 10px;">
        <li>Can't detect if page is scrolled out of view</li>
        <li>Can't detect if page is behind another window</li>
        <li>Multi-monitor setups may show 'visible' even when not being viewed</li>
        <li>Some browsers may delay the event for performance optimization</li>
      </ul>
    </div>
  </div>

  <script>
    // Visibility tracking
    let visibleTime = 0;
    let hiddenTime = 0;
    let switchCount = 0;
    let lastChangeTime = Date.now();
    let isVisible = !document.hidden;
    
    const visBox = document.getElementById('visibility-box');
    const visIcon = document.getElementById('visibility-icon');
    const visStatus = document.getElementById('visibility-status');
    const visState = document.getElementById('visibility-state');
    const visLog = document.getElementById('visibility-log');
    
    function logVisibility(message, type) {
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + type;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      visLog.prepend(entry);
    }
    
    function updateStats() {
      document.getElementById('visible-time').textContent = Math.floor(visibleTime / 1000) + 's';
      document.getElementById('hidden-time').textContent = Math.floor(hiddenTime / 1000) + 's';
      document.getElementById('switch-count').textContent = switchCount;
    }
    
    document.addEventListener('visibilitychange', () => {
      const now = Date.now();
      const elapsed = now - lastChangeTime;
      
      if (document.hidden) {
        // Was visible, now hidden
        visibleTime += elapsed;
        switchCount++;
        
        visBox.classList.add('hidden');
        visIcon.textContent = 'üôà';
        visStatus.textContent = 'Page is HIDDEN';
        visState.textContent = 'visibilityState: hidden';
        
        logVisibility('Page became hidden', 'hidden');
      } else {
        // Was hidden, now visible
        hiddenTime += elapsed;
        switchCount++;
        
        visBox.classList.remove('hidden');
        visIcon.textContent = 'üëÅÔ∏è';
        visStatus.textContent = 'Page is VISIBLE';
        visState.textContent = 'visibilityState: visible';
        
        logVisibility('Page became visible', 'visible');
      }
      
      lastChangeTime = now;
      isVisible = !document.hidden;
      updateStats();
    });
    
    // Update stats every second
    setInterval(() => {
      if (isVisible) {
        visibleTime += 1000;
      } else {
        hiddenTime += 1000;
      }
      updateStats();
    }, 1000);
    
    // Timer demo
    let timerInterval = null;
    let timerSeconds = 0;
    let timerRunning = false;
    let timerWasRunning = false;
    
    function updateTimerDisplay() {
      const mins = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
      const secs = (timerSeconds % 60).toString().padStart(2, '0');
      document.getElementById('timer-value').textContent = `${mins}:${secs}`;
    }
    
    function startTimer() {
      if (timerRunning) return;
      timerRunning = true;
      document.getElementById('timer-status').textContent = '‚ñ∂Ô∏è Timer running';
      timerInterval = setInterval(() => {
        timerSeconds++;
        updateTimerDisplay();
      }, 1000);
    }
    
    function pauseTimer() {
      if (!timerRunning) return;
      timerRunning = false;
      timerWasRunning = false;
      document.getElementById('timer-status').textContent = '‚è∏Ô∏è Timer paused';
      clearInterval(timerInterval);
    }
    
    function resetTimer() {
      pauseTimer();
      timerSeconds = 0;
      updateTimerDisplay();
      document.getElementById('timer-status').textContent = '‚è∏Ô∏è Timer reset';
    }
    
    // Auto-pause timer when page hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        if (timerRunning) {
          timerWasRunning = true;
          clearInterval(timerInterval);
          timerRunning = false;
          document.getElementById('timer-status').textContent = '‚è∏Ô∏è Auto-paused (tab hidden)';
        }
      } else {
        if (timerWasRunning) {
          startTimer();
          document.getElementById('timer-status').textContent = '‚ñ∂Ô∏è Auto-resumed (tab visible)';
        }
      }
    });
  </script>
</body>
</html>
