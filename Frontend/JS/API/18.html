<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 18: Beacon API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 52%, #2BFF88 90%);
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 52%, #2BFF88 90%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        h2 {
            color: #2BD2FF;
            font-size: 2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #2BD2FF;
        }
        
        h3 {
            color: #FA8BFF;
            font-size: 1.5em;
            margin: 30px 0 15px 0;
        }
        
        .concept-box {
            background: #f8f9fa;
            border-left: 4px solid #2BD2FF;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .key-point {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .info-box {
            background: #cfe2ff;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .code-block .comment {
            color: #6272a4;
        }
        
        .code-block .keyword {
            color: #ff79c6;
        }
        
        .code-block .string {
            color: #f1fa8c;
        }
        
        .code-block .function {
            color: #50fa7b;
        }
        
        .code-block .number {
            color: #bd93f9;
        }
        
        .visual-diagram {
            background: #f8f9fa;
            border: 2px solid #2BD2FF;
            border-radius: 10px;
            padding: 30px;
            margin: 30px 0;
        }
        
        .beacon-flow {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .flow-box {
            background: white;
            border: 2px solid #2BD2FF;
            border-radius: 10px;
            padding: 20px;
            margin: 10px;
            min-width: 150px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .flow-arrow {
            font-size: 30px;
            color: #2BD2FF;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .comparison-table th {
            background: #2BD2FF;
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .comparison-table td {
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .comparison-table tr:hover {
            background: #f8f9fa;
        }
        
        .demo-section {
            background: linear-gradient(135deg, #e0f7ff 0%, #e0ffe8 100%);
            padding: 30px;
            border-radius: 10px;
            margin: 30px 0;
        }
        
        .demo-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        input, select {
            padding: 10px;
            border: 2px solid #2BD2FF;
            border-radius: 5px;
            font-size: 16px;
            flex: 1;
            min-width: 200px;
        }
        
        .output {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            min-height: 100px;
            border: 2px solid #2BD2FF;
            max-height: 400px;
            overflow-y: auto;
        }
        
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }
        
        .use-case-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .use-case-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #2BD2FF;
            transition: transform 0.3s;
        }
        
        .use-case-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .use-case-card h4 {
            color: #2BD2FF;
            margin-bottom: 10px;
        }
        
        .feature-box {
            background: white;
            border: 2px solid #2BD2FF;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .feature-box h4 {
            color: #2BD2FF;
            margin-bottom: 10px;
        }
        
        .pros-cons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .pros, .cons {
            padding: 20px;
            border-radius: 10px;
        }
        
        .pros {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .cons {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        .pros h4 {
            color: #28a745;
            margin-bottom: 10px;
        }
        
        .cons h4 {
            color: #dc3545;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° Chapter 18: Beacon API</h1>
            <p>Reliable Data Transmission Even on Page Unload</p>
        </div>
        
        <div class="content">
            
            <!-- Introduction -->
            <div class="section">
                <h2>üéØ What is the Beacon API?</h2>
                
                <div class="concept-box">
                    <p><strong>Beacon API</strong> allows web pages to send small amounts of data to a server asynchronously, with guaranteed delivery even if the page is unloading. It's specifically designed for analytics and diagnostics.</p>
                    
                    <p style="margin-top: 15px;"><strong>Key Characteristics:</strong></p>
                    <ul style="margin-left: 25px; margin-top: 10px;">
                        <li>üéØ <strong>Guaranteed Delivery:</strong> Data sent even when page closes</li>
                        <li>‚ö° <strong>Non-Blocking:</strong> Doesn't delay page unload</li>
                        <li>üìä <strong>Fire and Forget:</strong> No response needed</li>
                        <li>üîí <strong>Secure:</strong> Uses POST with CORS support</li>
                        <li>üì¶ <strong>Small Data:</strong> Optimized for small payloads</li>
                        <li>üöÄ <strong>Browser-Managed:</strong> Browser handles the request</li>
                    </ul>
                </div>
                
                <div class="visual-diagram">
                    <h3>The Problem Beacon Solves</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div style="text-align: center; padding: 20px; background: #f8d7da; border-radius: 10px;">
                            <h4 style="color: #dc3545;">‚ùå Without Beacon</h4>
                            <div style="margin-top: 15px; text-align: left;">
                                <div>1. User closes tab</div>
                                <div style="margin-top: 10px;">2. fetch() request starts</div>
                                <div style="margin-top: 10px;">3. ‚ö†Ô∏è Request cancelled!</div>
                                <div style="margin-top: 10px;">4. Data lost</div>
                            </div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: #d4edda; border-radius: 10px;">
                            <h4 style="color: #28a745;">‚úì With Beacon</h4>
                            <div style="margin-top: 15px; text-align: left;">
                                <div>1. User closes tab</div>
                                <div style="margin-top: 10px;">2. Beacon queued</div>
                                <div style="margin-top: 10px;">3. ‚úì Browser sends it</div>
                                <div style="margin-top: 10px;">4. Data delivered!</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <strong>üí° Perfect For:</strong>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Analytics (page views, session duration)</li>
                        <li>Error logging and crash reports</li>
                        <li>User behavior tracking</li>
                        <li>Performance metrics</li>
                        <li>A/B testing data</li>
                        <li>Last-gasp diagnostics</li>
                    </ul>
                </div>
            </div>
            
            <!-- Basic Usage -->
            <div class="section">
                <h2>üöÄ Basic Usage</h2>
                
                <h3>Simple Beacon</h3>
                <div class="code-block">
<span class="comment">// Send data using Beacon API</span>
<span class="keyword">const</span> success = navigator.<span class="function">sendBeacon</span>(
    <span class="string">'/api/analytics'</span>,
    <span class="string">'page=home&time=123'</span>
);

<span class="keyword">if</span> (success) {
    console.<span class="function">log</span>(<span class="string">'Beacon queued successfully'</span>);
} <span class="keyword">else</span> {
    console.<span class="function">error</span>(<span class="string">'Beacon failed (quota exceeded?)'</span>);
}

<span class="comment">// Returns: boolean</span>
<span class="comment">// true = queued successfully</span>
<span class="comment">// false = failed (usually quota exceeded)</span>
                </div>
                
                <h3>Sending Different Data Types</h3>
                <div class="code-block">
<span class="comment">// 1. String (URL-encoded)</span>
navigator.<span class="function">sendBeacon</span>(<span class="string">'/api/log'</span>, <span class="string">'event=click&button=submit'</span>);

<span class="comment">// 2. Blob</span>
<span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="function">Blob</span>(
    [JSON.<span class="function">stringify</span>({ event: <span class="string">'pageview'</span>, page: <span class="string">'/home'</span> })],
    { type: <span class="string">'application/json'</span> }
);
navigator.<span class="function">sendBeacon</span>(<span class="string">'/api/analytics'</span>, blob);

<span class="comment">// 3. FormData</span>
<span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="function">FormData</span>();
formData.<span class="function">append</span>(<span class="string">'event'</span>, <span class="string">'click'</span>);
formData.<span class="function">append</span>(<span class="string">'timestamp'</span>, Date.<span class="function">now</span>());
formData.<span class="function">append</span>(<span class="string">'userId'</span>, <span class="string">'123'</span>);
navigator.<span class="function">sendBeacon</span>(<span class="string">'/api/track'</span>, formData);

<span class="comment">// 4. URLSearchParams</span>
<span class="keyword">const</span> params = <span class="keyword">new</span> <span class="function">URLSearchParams</span>();
params.<span class="function">append</span>(<span class="string">'action'</span>, <span class="string">'submit'</span>);
params.<span class="function">append</span>(<span class="string">'form'</span>, <span class="string">'contact'</span>);
navigator.<span class="function">sendBeacon</span>(<span class="string">'/api/events'</span>, params);

<span class="comment">// 5. ArrayBuffer</span>
<span class="keyword">const</span> buffer = <span class="keyword">new</span> <span class="function">Uint8Array</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]).<span class="function">buffer</span>;
navigator.<span class="function">sendBeacon</span>(<span class="string">'/api/binary'</span>, buffer);
                </div>
                
                <div class="key-point">
                    <strong>üí° Content-Type Headers:</strong>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><strong>String:</strong> <code>text/plain;charset=UTF-8</code></li>
                        <li><strong>FormData:</strong> <code>multipart/form-data</code></li>
                        <li><strong>URLSearchParams:</strong> <code>application/x-www-form-urlencoded</code></li>
                        <li><strong>Blob:</strong> Uses the Blob's type property</li>
                    </ul>
                </div>
            </div>
            
            <!-- Common Use Cases -->
            <div class="section">
                <h2>üíº Common Use Cases</h2>
                
                <h3>1. Track Page Exit</h3>
                <div class="code-block">
<span class="comment">// Track when user leaves the page</span>
window.<span class="function">addEventListener</span>(<span class="string">'unload'</span>, () => {
    <span class="keyword">const</span> data = JSON.<span class="function">stringify</span>({
        event: <span class="string">'page_exit'</span>,
        page: window.location.pathname,
        duration: performance.<span class="function">now</span>(),
        timestamp: <span class="keyword">new</span> <span class="function">Date</span>().<span class="function">toISOString</span>()
    });
    
    <span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="function">Blob</span>([data], { type: <span class="string">'application/json'</span> });
    navigator.<span class="function">sendBeacon</span>(<span class="string">'/api/analytics'</span>, blob);
});

<span class="comment">// Also works with beforeunload</span>
window.<span class="function">addEventListener</span>(<span class="string">'beforeunload'</span>, () => {
    navigator.<span class="function">sendBeacon</span>(<span class="string">'/api/session-end'</span>, <span class="string">'session=xyz'</span>);
});
                </div>
                
                <h3>2. Session Duration Tracking</h3>
                <div class="code-block">
<span class="comment">// Track how long user stayed on page</span>
<span class="keyword">const</span> sessionStart = Date.<span class="function">now</span>();

window.<span class="function">addEventListener</span>(<span class="string">'visibilitychange'</span>, () => {
    <span class="keyword">if</span> (document.visibilityState === <span class="string">'hidden'</span>) {
        <span class="keyword">const</span> duration = Date.<span class="function">now</span>() - sessionStart;
        
        <span class="keyword">const</span> data = {
            event: <span class="string">'session_duration'</span>,
            page: window.location.pathname,
            duration: duration,
            timestamp: Date.<span class="function">now</span>()
        };
        
        navigator.<span class="function">sendBeacon</span>(
            <span class="string">'/api/analytics'</span>,
            JSON.<span class="function">stringify</span>(data)
        );
    }
});
                </div>
                
                <h3>3. Error Logging</h3>
                <div class="code-block">
<span class="comment">// Send error reports</span>
window.<span class="function">addEventListener</span>(<span class="string">'error'</span>, (event) => {
    <span class="keyword">const</span> errorData = {
        type: <span class="string">'javascript_error'</span>,
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        stack: event.error?.stack,
        userAgent: navigator.userAgent,
        url: window.location.href,
        timestamp: <span class="keyword">new</span> <span class="function">Date</span>().<span class="function">toISOString</span>()
    };
    
    <span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="function">Blob</span>(
        [JSON.<span class="function">stringify</span>(errorData)],
        { type: <span class="string">'application/json'</span> }
    );
    
    navigator.<span class="function">sendBeacon</span>(<span class="string">'/api/errors'</span>, blob);
});

<span class="comment">// Unhandled promise rejections</span>
window.<span class="function">addEventListener</span>(<span class="string">'unhandledrejection'</span>, (event) => {
    <span class="keyword">const</span> data = {
        type: <span class="string">'unhandled_rejection'</span>,
        reason: event.reason,
        promise: event.promise,
        timestamp: Date.<span class="function">now</span>()
    };
    
    navigator.<span class="function">sendBeacon</span>(
        <span class="string">'/api/errors'</span>,
        JSON.<span class="function">stringify</span>(data)
    );
});
                </div>
                
                <h3>4. Performance Metrics</h3>
                <div class="code-block">
<span class="comment">// Send performance data on page unload</span>
window.<span class="function">addEventListener</span>(<span class="string">'unload'</span>, () => {
    <span class="keyword">const</span> perfData = performance.<span class="function">getEntriesByType</span>(<span class="string">'navigation'</span>)[<span class="number">0</span>];
    
    <span class="keyword">const</span> metrics = {
        url: window.location.href,
        loadTime: perfData.loadEventEnd - perfData.fetchStart,
        domReady: perfData.domContentLoadedEventEnd - perfData.fetchStart,
        firstByte: perfData.responseStart - perfData.requestStart,
        dns: perfData.domainLookupEnd - perfData.domainLookupStart,
        tcp: perfData.connectEnd - perfData.connectStart,
        ttfb: perfData.responseStart - perfData.fetchStart
    };
    
    <span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="function">Blob</span>(
        [JSON.<span class="function">stringify</span>(metrics)],
        { type: <span class="string">'application/json'</span> }
    );
    
    navigator.<span class="function">sendBeacon</span>(<span class="string">'/api/performance'</span>, blob);
});
                </div>
                
                <h3>5. User Interactions</h3>
                <div class="code-block">
<span class="comment">// Batch and send user interactions</span>
<span class="keyword">let</span> interactions = [];

<span class="keyword">function</span> <span class="function">trackInteraction</span>(type, data) {
    interactions.<span class="function">push</span>({
        type,
        data,
        timestamp: Date.<span class="function">now</span>()
    });
}

<span class="comment">// Track clicks</span>
document.<span class="function">addEventListener</span>(<span class="string">'click'</span>, (e) => {
    <span class="function">trackInteraction</span>(<span class="string">'click'</span>, {
        target: e.target.tagName,
        id: e.target.id,
        class: e.target.className
    });
});

<span class="comment">// Send on page unload</span>
window.<span class="function">addEventListener</span>(<span class="string">'unload'</span>, () => {
    <span class="keyword">if</span> (interactions.length > <span class="number">0</span>) {
        navigator.<span class="function">sendBeacon</span>(
            <span class="string">'/api/interactions'</span>,
            JSON.<span class="function">stringify</span>(interactions)
        );
    }
});
                </div>
            </div>
            
            <!-- Advanced Patterns -->
            <div class="section">
                <h2>üéØ Advanced Patterns</h2>
                
                <h3>Pattern 1: Beacon Queue Manager</h3>
                <div class="code-block">
<span class="keyword">class</span> <span class="function">BeaconQueue</span> {
    <span class="keyword">constructor</span>(endpoint, options = {}) {
        <span class="keyword">this</span>.endpoint = endpoint;
        <span class="keyword">this</span>.maxSize = options.maxSize || <span class="number">64</span> * <span class="number">1024</span>; <span class="comment">// 64KB default</span>
        <span class="keyword">this</span>.queue = [];
        <span class="keyword">this</span>.<span class="function">setupUnloadListener</span>();
    }
    
    <span class="function">add</span>(data) {
        <span class="keyword">this</span>.queue.<span class="function">push</span>({
            ...data,
            timestamp: Date.<span class="function">now</span>()
        });
        
        <span class="comment">// Check if queue is too large</span>
        <span class="keyword">const</span> size = JSON.<span class="function">stringify</span>(<span class="keyword">this</span>.queue).length;
        <span class="keyword">if</span> (size > <span class="keyword">this</span>.maxSize) {
            <span class="keyword">this</span>.<span class="function">flush</span>();
        }
    }
    
    <span class="function">flush</span>() {
        <span class="keyword">if</span> (<span class="keyword">this</span>.queue.length === <span class="number">0</span>) <span class="keyword">return</span>;
        
        <span class="keyword">const</span> data = JSON.<span class="function">stringify</span>(<span class="keyword">this</span>.queue);
        <span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="function">Blob</span>([data], { type: <span class="string">'application/json'</span> });
        
        <span class="keyword">const</span> success = navigator.<span class="function">sendBeacon</span>(<span class="keyword">this</span>.endpoint, blob);
        
        <span class="keyword">if</span> (success) {
            <span class="keyword">this</span>.queue = [];
        }
        
        <span class="keyword">return</span> success;
    }
    
    <span class="function">setupUnloadListener</span>() {
        window.<span class="function">addEventListener</span>(<span class="string">'visibilitychange'</span>, () => {
            <span class="keyword">if</span> (document.visibilityState === <span class="string">'hidden'</span>) {
                <span class="keyword">this</span>.<span class="function">flush</span>();
            }
        });
        
        window.<span class="function">addEventListener</span>(<span class="string">'pagehide'</span>, () => {
            <span class="keyword">this</span>.<span class="function">flush</span>();
        });
    }
}

<span class="comment">// Usage</span>
<span class="keyword">const</span> analytics = <span class="keyword">new</span> <span class="function">BeaconQueue</span>(<span class="string">'/api/analytics'</span>);

analytics.<span class="function">add</span>({ event: <span class="string">'pageview'</span>, page: <span class="string">'/home'</span> });
analytics.<span class="function">add</span>({ event: <span class="string">'click'</span>, button: <span class="string">'submit'</span> });
                </div>
                
                <h3>Pattern 2: Fallback Handler</h3>
                <div class="code-block">
<span class="comment">// Fallback to fetch if beacon fails</span>
<span class="keyword">function</span> <span class="function">sendWithFallback</span>(url, data) {
    <span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="function">Blob</span>(
        [JSON.<span class="function">stringify</span>(data)],
        { type: <span class="string">'application/json'</span> }
    );
    
    <span class="comment">// Try beacon first</span>
    <span class="keyword">const</span> beaconSuccess = navigator.<span class="function">sendBeacon</span>(url, blob);
    
    <span class="keyword">if</span> (!beaconSuccess) {
        console.<span class="function">warn</span>(<span class="string">'Beacon failed, falling back to fetch'</span>);
        
        <span class="comment">// Fallback to fetch with keepalive</span>
        <span class="function">fetch</span>(url, {
            method: <span class="string">'POST'</span>,
            body: blob,
            keepalive: <span class="keyword">true</span>, <span class="comment">// Important!</span>
            headers: {
                <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>
            }
        }).<span class="function">catch</span>(err => {
            console.<span class="function">error</span>(<span class="string">'Both beacon and fetch failed:'</span>, err);
        });
    }
}

<span class="comment">// Usage</span>
window.<span class="function">addEventListener</span>(<span class="string">'unload'</span>, () => {
    <span class="function">sendWithFallback</span>(<span class="string">'/api/exit'</span>, { event: <span class="string">'page_exit'</span> });
});
                </div>
                
                <h3>Pattern 3: Conditional Sending</h3>
                <div class="code-block">
<span class="comment">// Only send beacon if certain conditions are met</span>
<span class="keyword">function</span> <span class="function">sendAnalytics</span>(data) {
    <span class="comment">// Don't send in development</span>
    <span class="keyword">if</span> (window.location.hostname === <span class="string">'localhost'</span>) {
        console.<span class="function">log</span>(<span class="string">'Dev mode - would send:'</span>, data);
        <span class="keyword">return</span>;
    }
    
    <span class="comment">// Don't send if user opted out</span>
    <span class="keyword">if</span> (localStorage.<span class="function">getItem</span>(<span class="string">'analytics-opt-out'</span>) === <span class="string">'true'</span>) {
        <span class="keyword">return</span>;
    }
    
    <span class="comment">// Don't send if Do Not Track is enabled</span>
    <span class="keyword">if</span> (navigator.doNotTrack === <span class="string">'1'</span>) {
        <span class="keyword">return</span>;
    }
    
    <span class="comment">// All checks passed, send beacon</span>
    <span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="function">Blob</span>(
        [JSON.<span class="function">stringify</span>(data)],
        { type: <span class="string">'application/json'</span> }
    );
    
    navigator.<span class="function">sendBeacon</span>(<span class="string">'/api/analytics'</span>, blob);
}
                </div>
            </div>
            
            <!-- Limitations -->
            <div class="section">
                <h2>‚ö†Ô∏è Limitations & Considerations</h2>
                
                <div class="pros-cons">
                    <div class="pros">
                        <h4>‚úÖ Advantages</h4>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Guaranteed delivery on page unload</li>
                            <li>Non-blocking, doesn't delay unload</li>
                            <li>Simple API, easy to use</li>
                            <li>Browser handles the request</li>
                            <li>No response needed (fire & forget)</li>
                            <li>CORS support</li>
                        </ul>
                    </div>
                    
                    <div class="cons">
                        <h4>‚ùå Limitations</h4>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>POST only, no other HTTP methods</li>
                            <li>No response data available</li>
                            <li>Size limits (~64KB typical)</li>
                            <li>Cannot set custom headers</li>
                            <li>No progress tracking</li>
                            <li>Browser support (IE not supported)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="warning-box">
                    <strong>‚ö†Ô∏è Important Notes:</strong>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><strong>Size Limit:</strong> Typically ~64KB, varies by browser</li>
                        <li><strong>POST Only:</strong> Always sends POST requests</li>
                        <li><strong>No Custom Headers:</strong> Cannot set Authorization, etc.</li>
                        <li><strong>No Response:</strong> Fire-and-forget, can't read response</li>
                        <li><strong>Queue Limit:</strong> Too many beacons may be dropped</li>
                        <li><strong>CORS:</strong> Server must allow cross-origin if needed</li>
                    </ul>
                </div>
            </div>
            
            <!-- Comparison -->
            <div class="section">
                <h2>‚öñÔ∏è Beacon vs fetch() with keepalive</h2>
                
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Beacon API</th>
                            <th>fetch() with keepalive</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Purpose</strong></td>
                            <td>Analytics & logging</td>
                            <td>General HTTP requests</td>
                        </tr>
                        <tr>
                            <td><strong>HTTP Method</strong></td>
                            <td>POST only</td>
                            <td>Any method</td>
                        </tr>
                        <tr>
                            <td><strong>Custom Headers</strong></td>
                            <td>‚ùå No</td>
                            <td>‚úì Yes</td>
                        </tr>
                        <tr>
                            <td><strong>Response</strong></td>
                            <td>‚ùå No response</td>
                            <td>‚úì Can read response</td>
                        </tr>
                        <tr>
                            <td><strong>Size Limit</strong></td>
                            <td>~64KB</td>
                            <td>~64KB (with keepalive)</td>
                        </tr>
                        <tr>
                            <td><strong>Unload Guarantee</strong></td>
                            <td>‚úì Yes</td>
                            <td>‚úì Yes (with keepalive)</td>
                        </tr>
                        <tr>
                            <td><strong>Simplicity</strong></td>
                            <td>Very simple</td>
                            <td>More complex</td>
                        </tr>
                        <tr>
                            <td><strong>Browser Support</strong></td>
                            <td>Modern browsers</td>
                            <td>Modern browsers</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3>When to Use Each</h3>
                <div class="feature-box">
                    <h4>Use Beacon When:</h4>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Sending analytics or diagnostic data</li>
                        <li>Don't need response data</li>
                        <li>Data is small (<64KB)</li>
                        <li>POST is acceptable</li>
                        <li>Simplicity is preferred</li>
                    </ul>
                </div>
                
                <div class="feature-box">
                    <h4>Use fetch() with keepalive When:</h4>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Need custom headers (Authorization, etc.)</li>
                        <li>Need response data</li>
                        <li>Need different HTTP methods</li>
                        <li>Need more control over request</li>
                    </ul>
                </div>
            </div>
            
            <!-- Interactive Demo -->
            <div class="section">
                <h2>üéÆ Interactive Demo</h2>
                
                <div class="demo-section">
                    <h3>Beacon API Simulator</h3>
                    <p style="margin-bottom: 15px;">Test sending beacons with different data types</p>
                    
                    <div class="demo-controls">
                        <select id="dataType">
                            <option value="string">String</option>
                            <option value="json">JSON (Blob)</option>
                            <option value="formdata">FormData</option>
                            <option value="urlparams">URLSearchParams</option>
                        </select>
                        <button onclick="sendBeacon()">Send Beacon</button>
                        <button onclick="simulateUnload()">Simulate Page Unload</button>
                        <button onclick="clearOutput()">Clear</button>
                    </div>
                    
                    <div class="output" id="output">Ready to send beacons...</div>
                </div>
            </div>
            
            <!-- Best Practices -->
            <div class="section">
                <h2>‚úÖ Best Practices</h2>
                
                <div class="key-point">
                    <h3 style="margin-top: 0;">DO ‚úì</h3>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Use for analytics and logging only</li>
                        <li>Keep payloads small (<64KB)</li>
                        <li>Send JSON using Blob for proper Content-Type</li>
                        <li>Check return value (false means queue full)</li>
                        <li>Use on <code>visibilitychange</code> and <code>pagehide</code></li>
                        <li>Batch multiple events together</li>
                        <li>Respect user privacy (Do Not Track)</li>
                        <li>Test in real browsers (not dev tools)</li>
                    </ul>
                </div>
                
                <div class="warning-box">
                    <h3 style="margin-top: 0;">DON'T ‚úó</h3>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Use for critical data that needs confirmation</li>
                        <li>Send large payloads (will fail)</li>
                        <li>Expect response data</li>
                        <li>Send too frequently (batch instead)</li>
                        <li>Use for authentication requests</li>
                        <li>Rely on it for financial transactions</li>
                        <li>Send sensitive unencrypted data</li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'color: #0d6efd;',
                success: 'color: #28a745;',
                error: 'color: #dc3545;',
                warning: 'color: #ffc107;'
            };
            output.innerHTML += `<div style="${colors[type]}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        function sendBeacon() {
            const dataType = document.getElementById('dataType').value;
            let data;
            let description;
            
            switch(dataType) {
                case 'string':
                    data = 'event=test&type=string&timestamp=' + Date.now();
                    description = 'String (URL-encoded)';
                    break;
                    
                case 'json':
                    const jsonData = {
                        event: 'test',
                        type: 'json',
                        timestamp: Date.now(),
                        user: { id: 123, name: 'Demo User' }
                    };
                    data = new Blob([JSON.stringify(jsonData)], { type: 'application/json' });
                    description = 'JSON (Blob)';
                    break;
                    
                case 'formdata':
                    data = new FormData();
                    data.append('event', 'test');
                    data.append('type', 'formdata');
                    data.append('timestamp', Date.now());
                    description = 'FormData';
                    break;
                    
                case 'urlparams':
                    data = new URLSearchParams();
                    data.append('event', 'test');
                    data.append('type', 'urlparams');
                    data.append('timestamp', Date.now());
                    description = 'URLSearchParams';
                    break;
            }
            
            log(`Attempting to send beacon (${description})...`, 'info');
            
            // Note: This will actually try to send, but will fail with CORS
            // In production, your server would handle this
            const success = navigator.sendBeacon('/api/demo', data);
            
            if (success) {
                log(`‚úì Beacon queued successfully!`, 'success');
                log(`  Type: ${description}`, 'info');
                log(`  Browser will send this request`, 'info');
            } else {
                log(`‚úó Beacon failed (quota exceeded or unavailable)`, 'error');
            }
        }
        
        function simulateUnload() {
            log('üì§ Simulating page unload event...', 'warning');
            
            const analyticsData = {
                event: 'page_unload',
                page: window.location.pathname,
                duration: Math.floor(Math.random() * 60000),
                interactions: Math.floor(Math.random() * 50),
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob(
                [JSON.stringify(analyticsData)],
                { type: 'application/json' }
            );
            
            const success = navigator.sendBeacon('/api/analytics', blob);
            
            if (success) {
                log('‚úì Unload analytics sent!', 'success');
                log(`  Duration: ${analyticsData.duration}ms`, 'info');
                log(`  Interactions: ${analyticsData.interactions}`, 'info');
            } else {
                log('‚úó Failed to send unload analytics', 'error');
            }
        }
        
        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }
        
        // Initialize
        window.addEventListener('load', () => {
            log('üëã Welcome to Beacon API Demo!', 'success');
            log('Beacon API ensures data delivery even when page closes', 'info');
            
            if ('sendBeacon' in navigator) {
                log('‚úì Beacon API is supported', 'success');
            } else {
                log('‚úó Beacon API not supported in this browser', 'error');
            }
        });
    </script>
</body>
</html>