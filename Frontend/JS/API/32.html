<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 32: Service Workers</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.2em; opacity: 0.95; }
        .content { padding: 40px; }
        .section { margin-bottom: 40px; }
        h2 { color: #f5576c; font-size: 2em; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #f5576c; }
        h3 { color: #f093fb; font-size: 1.5em; margin: 30px 0 15px 0; }
        .concept-box { background: #f8f9fa; border-left: 4px solid #f5576c; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .key-point { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .warning-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .info-box { background: #cfe2ff; border-left: 4px solid #0d6efd; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .code-block .comment { color: #6272a4; }
        .code-block .keyword { color: #ff79c6; }
        .code-block .string { color: #f1fa8c; }
        .code-block .function { color: #50fa7b; }
        .code-block .number { color: #bd93f9; }
        .visual-diagram {
            background: #f8f9fa;
            border: 2px solid #f5576c;
            border-radius: 10px;
            padding: 30px;
            margin: 30px 0;
        }
        .lifecycle-flow {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        .lifecycle-step {
            background: white;
            border: 2px solid #f5576c;
            border-radius: 10px;
            padding: 20px;
            position: relative;
        }
        .lifecycle-step h4 { color: #f5576c; margin-bottom: 10px; }
        .lifecycle-step::after {
            content: '‚Üì';
            display: block;
            text-align: center;
            font-size: 24px;
            color: #f5576c;
            margin-top: 10px;
        }
        .lifecycle-step:last-child::after { content: ''; }
        .demo-section { background: #ffe0e6; padding: 30px; border-radius: 10px; margin: 30px 0; }
        button {
            background: #f5576c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 600;
            margin: 5px;
        }
        button:hover { background: #f093fb; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .output { background: white; padding: 15px; border-radius: 5px; margin-top: 15px; min-height: 100px; border: 2px solid #f5576c; max-height: 400px; overflow-y: auto; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', monospace; color: #d63384; }
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .strategy-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #f5576c;
        }
        .strategy-card h4 { color: #f5576c; margin-bottom: 10px; }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin: 5px;
        }
        .status-active { background: #d4edda; color: #28a745; }
        .status-inactive { background: #f8d7da; color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Chapter 32: Service Workers</h1>
            <p>Offline-First Progressive Web Apps</p>
        </div>
        
        <div class="content">
            
            <div class="section">
                <h2>üéØ What are Service Workers?</h2>
                
                <div class="concept-box">
                    <p><strong>Service Workers</strong> are scripts that run in the background, separate from web pages. They act as network proxies, intercepting network requests and enabling offline functionality, push notifications, and background sync.</p>
                    
                    <p style="margin-top: 15px;"><strong>Key Characteristics:</strong></p>
                    <ul style="margin-left: 25px; margin-top: 10px;">
                        <li>üåê <strong>Network Proxy:</strong> Intercepts all network requests</li>
                        <li>üì¶ <strong>Caching:</strong> Enables offline functionality</li>
                        <li>üîî <strong>Push Notifications:</strong> Receive notifications when app is closed</li>
                        <li>üîÑ <strong>Background Sync:</strong> Sync data in background</li>
                        <li>üîí <strong>HTTPS Only:</strong> Security requirement</li>
                        <li>‚ö° <strong>Event-Driven:</strong> No direct DOM access</li>
                    </ul>
                </div>
                
                <div class="visual-diagram">
                    <h3>Service Worker Lifecycle</h3>
                    <div class="lifecycle-flow">
                        <div class="lifecycle-step">
                            <h4>1. üìù Registration</h4>
                            <p>Main thread registers service worker file</p>
                            <code>navigator.serviceWorker.register('/sw.js')</code>
                        </div>
                        <div class="lifecycle-step">
                            <h4>2. üì• Install</h4>
                            <p>Service worker downloads and installs</p>
                            <code>self.addEventListener('install', ...)</code>
                            <p style="margin-top: 10px;">Cache static assets here</p>
                        </div>
                        <div class="lifecycle-step">
                            <h4>3. ‚è≥ Waiting</h4>
                            <p>Waits if old service worker is active</p>
                            <p style="margin-top: 5px; font-size: 0.9em;">Can skip with skipWaiting()</p>
                        </div>
                        <div class="lifecycle-step">
                            <h4>4. ‚úÖ Activate</h4>
                            <p>Becomes active service worker</p>
                            <code>self.addEventListener('activate', ...)</code>
                            <p style="margin-top: 10px;">Clean up old caches here</p>
                        </div>
                        <div class="lifecycle-step">
                            <h4>5. üéØ Fetch</h4>
                            <p>Intercepts network requests</p>
                            <code>self.addEventListener('fetch', ...)</code>
                            <p style="margin-top: 10px;">Serve from cache or network</p>
                        </div>
                    </div>
                </div>
                
                <div class="warning-box">
                    <strong>‚ö†Ô∏è Requirements:</strong>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Must use HTTPS (except localhost)</li>
                        <li>Only works on same origin</li>
                        <li>No direct DOM access</li>
                        <li>Async APIs only (no localStorage)</li>
                    </ul>
                </div>
            </div>
            
            <div class="section">
                <h2>üìù Registration</h2>
                
                <h3>Registering Service Worker</h3>
                <div class="code-block">
<span class="comment">// main.js - Register service worker</span>
<span class="keyword">if</span> (<span class="string">'serviceWorker'</span> <span class="keyword">in</span> navigator) {
    window.<span class="function">addEventListener</span>(<span class="string">'load'</span>, <span class="keyword">async</span> () => {
        <span class="keyword">try</span> {
            <span class="keyword">const</span> registration = <span class="keyword">await</span> navigator.serviceWorker.<span class="function">register</span>(<span class="string">'/sw.js'</span>, {
                scope: <span class="string">'/'</span> <span class="comment">// Default: directory of sw.js</span>
            });
            
            console.<span class="function">log</span>(<span class="string">'Service Worker registered'</span>);
            console.<span class="function">log</span>(<span class="string">'Scope:'</span>, registration.scope);
            
            <span class="comment">// Check state</span>
            <span class="keyword">if</span> (registration.installing) {
                console.<span class="function">log</span>(<span class="string">'Service Worker installing'</span>);
            } <span class="keyword">else if</span> (registration.waiting) {
                console.<span class="function">log</span>(<span class="string">'Service Worker waiting'</span>);
            } <span class="keyword">else if</span> (registration.active) {
                console.<span class="function">log</span>(<span class="string">'Service Worker active'</span>);
            }
        } <span class="keyword">catch</span> (error) {
            console.<span class="function">error</span>(<span class="string">'Registration failed:'</span>, error);
        }
    });
} <span class="keyword">else</span> {
    console.<span class="function">log</span>(<span class="string">'Service Workers not supported'</span>);
}
                </div>
            </div>
            
            <div class="section">
                <h2>‚öôÔ∏è Service Worker Events</h2>
                
                <h3>1. Install Event</h3>
                <div class="code-block">
<span class="comment">// sw.js - Install event (cache assets)</span>
<span class="keyword">const</span> CACHE_NAME = <span class="string">'my-app-v1'</span>;
<span class="keyword">const</span> ASSETS = [
    <span class="string">'/'</span>,
    <span class="string">'/index.html'</span>,
    <span class="string">'/styles.css'</span>,
    <span class="string">'/app.js'</span>,
    <span class="string">'/offline.html'</span>
];

self.<span class="function">addEventListener</span>(<span class="string">'install'</span>, (event) => {
    console.<span class="function">log</span>(<span class="string">'Service Worker installing...'</span>);
    
    event.<span class="function">waitUntil</span>(
        caches.<span class="function">open</span>(CACHE_NAME)
            .<span class="function">then</span>(cache => {
                console.<span class="function">log</span>(<span class="string">'Caching app shell'</span>);
                <span class="keyword">return</span> cache.<span class="function">addAll</span>(ASSETS);
            })
    );
    
    <span class="comment">// Skip waiting and activate immediately</span>
    self.<span class="function">skipWaiting</span>();
});
                </div>
                
                <h3>2. Activate Event</h3>
                <div class="code-block">
<span class="comment">// sw.js - Activate event (cleanup old caches)</span>
self.<span class="function">addEventListener</span>(<span class="string">'activate'</span>, (event) => {
    console.<span class="function">log</span>(<span class="string">'Service Worker activating...'</span>);
    
    event.<span class="function">waitUntil</span>(
        caches.<span class="function">keys</span>().<span class="function">then</span>(cacheNames => {
            <span class="keyword">return</span> Promise.<span class="function">all</span>(
                cacheNames
                    .<span class="function">filter</span>(name => name !== CACHE_NAME)
                    .<span class="function">map</span>(name => {
                        console.<span class="function">log</span>(<span class="string">'Deleting old cache:'</span>, name);
                        <span class="keyword">return</span> caches.<span class="function">delete</span>(name);
                    })
            );
        })
    );
    
    <span class="comment">// Take control of all pages immediately</span>
    self.clients.<span class="function">claim</span>();
});
                </div>
                
                <h3>3. Fetch Event (Network Interception)</h3>
                <div class="code-block">
<span class="comment">// sw.js - Fetch event (intercept requests)</span>
self.<span class="function">addEventListener</span>(<span class="string">'fetch'</span>, (event) => {
    event.<span class="function">respondWith</span>(
        caches.<span class="function">match</span>(event.request)
            .<span class="function">then</span>(cached => {
                <span class="keyword">if</span> (cached) {
                    <span class="comment">// Return cached response</span>
                    <span class="keyword">return</span> cached;
                }
                
                <span class="comment">// Not in cache, fetch from network</span>
                <span class="keyword">return</span> <span class="function">fetch</span>(event.request);
            })
            .<span class="function">catch</span>(() => {
                <span class="comment">// Network failed, return offline page</span>
                <span class="keyword">return</span> caches.<span class="function">match</span>(<span class="string">'/offline.html'</span>);
            })
    );
});
                </div>
            </div>
            
            <div class="section">
                <h2>üéØ Caching Strategies</h2>
                
                <div class="strategy-grid">
                    <div class="strategy-card">
                        <h4>1. Cache First</h4>
                        <p>Fast but potentially stale</p>
                        <div class="code-block" style="margin-top: 10px;">
<span class="comment">// Try cache, fallback to network</span>
event.<span class="function">respondWith</span>(
    caches.<span class="function">match</span>(event.request)
        .<span class="function">then</span>(r => r || <span class="function">fetch</span>(event.request))
);
                        </div>
                    </div>
                    
                    <div class="strategy-card">
                        <h4>2. Network First</h4>
                        <p>Fresh but requires network</p>
                        <div class="code-block" style="margin-top: 10px;">
<span class="comment">// Try network, fallback to cache</span>
event.<span class="function">respondWith</span>(
    <span class="function">fetch</span>(event.request)
        .<span class="function">catch</span>(() => caches.<span class="function">match</span>(event.request))
);
                        </div>
                    </div>
                    
                    <div class="strategy-card">
                        <h4>3. Stale While Revalidate</h4>
                        <p>Fast and eventually fresh</p>
                        <div class="code-block" style="margin-top: 10px;">
<span class="comment">// Return cache, update in background</span>
event.<span class="function">respondWith</span>(
    caches.<span class="function">match</span>(event.request)
        .<span class="function">then</span>(cached => {
            <span class="keyword">const</span> fetch = <span class="function">fetch</span>(event.request)
                .<span class="function">then</span>(r => {
                    cache.<span class="function">put</span>(event.request, r.<span class="function">clone</span>());
                    <span class="keyword">return</span> r;
                });
            <span class="keyword">return</span> cached || fetch;
        })
);
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>üíº Complete PWA Example</h2>
                
                <div class="code-block">
<span class="comment">// sw.js - Production-ready service worker</span>
<span class="keyword">const</span> VERSION = <span class="string">'v1'</span>;
<span class="keyword">const</span> CACHE_NAME = <span class="string">`pwa-${VERSION}`</span>;
<span class="keyword">const</span> ASSETS = [<span class="string">'/'</span>, <span class="string">'/index.html'</span>, <span class="string">'/app.js'</span>, <span class="string">'/styles.css'</span>];

<span class="comment">// Install - cache assets</span>
self.<span class="function">addEventListener</span>(<span class="string">'install'</span>, (e) => {
    e.<span class="function">waitUntil</span>(
        caches.<span class="function">open</span>(CACHE_NAME)
            .<span class="function">then</span>(cache => cache.<span class="function">addAll</span>(ASSETS))
            .<span class="function">then</span>(() => self.<span class="function">skipWaiting</span>())
    );
});

<span class="comment">// Activate - cleanup</span>
self.<span class="function">addEventListener</span>(<span class="string">'activate'</span>, (e) => {
    e.<span class="function">waitUntil</span>(
        caches.<span class="function">keys</span>()
            .<span class="function">then</span>(names => Promise.<span class="function">all</span>(
                names
                    .<span class="function">filter</span>(n => n !== CACHE_NAME)
                    .<span class="function">map</span>(n => caches.<span class="function">delete</span>(n))
            ))
            .<span class="function">then</span>(() => self.clients.<span class="function">claim</span>())
    );
});

<span class="comment">// Fetch - serve from cache with network fallback</span>
self.<span class="function">addEventListener</span>(<span class="string">'fetch'</span>, (e) => {
    e.<span class="function">respondWith</span>(
        caches.<span class="function">match</span>(e.request)
            .<span class="function">then</span>(cached => cached || <span class="function">fetch</span>(e.request))
            .<span class="function">catch</span>(() => caches.<span class="function">match</span>(<span class="string">'/offline.html'</span>))
    );
});
                </div>
            </div>
            
            <div class="section">
                <h2>üéÆ Interactive Demo</h2>
                
                <div class="demo-section">
                    <h3>Service Worker Status</h3>
                    
                    <div id="swStatus">
                        <span class="status-badge status-inactive">Checking...</span>
                    </div>
                    
                    <div class="demo-controls" style="margin-top: 20px;">
                        <button onclick="checkStatus()">Check Status</button>
                        <button onclick="showInfo()">Show Info</button>
                    </div>
                    
                    <div class="output" id="output">Service Worker information will appear here...</div>
                </div>
            </div>
            
            <div class="section">
                <h2>‚úÖ Best Practices</h2>
                
                <div class="key-point">
                    <h3 style="margin-top: 0;">DO ‚úì</h3>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Version your caches</li>
                        <li>Clean up old caches on activate</li>
                        <li>Use appropriate caching strategies</li>
                        <li>Handle offline scenarios</li>
                        <li>Test update scenarios</li>
                        <li>Use skipWaiting carefully</li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const colors = { info: '#0d6efd', success: '#28a745', error: '#dc3545' };
            output.innerHTML += `<div style="color: ${colors[type]};">${message}</div>`;
        }
        
        function checkStatus() {
            const statusDiv = document.getElementById('swStatus');
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    statusDiv.innerHTML = '<span class="status-badge status-active">‚úì Active</span>';
                    log('‚úì Service Worker is active', 'success');
                });
            } else {
                statusDiv.innerHTML = '<span class="status-badge status-inactive">‚úó Not Supported</span>';
                log('‚ùå Service Workers not supported', 'error');
            }
        }
        
        function showInfo() {
            if ('serviceWorker' in navigator) {
                log('üîß Service Worker API is available', 'success');
                log('Note: Service Workers require HTTPS in production', 'info');
                log('They enable offline functionality and push notifications', 'info');
            } else {
                log('‚ùå Service Workers not available', 'error');
            }
        }
        
        window.addEventListener('load', () => {
            checkStatus();
            log('üëã Welcome to Service Workers explanation!', 'success');
        });
    </script>
</body>
</html>