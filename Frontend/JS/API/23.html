<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chapter 23: History API</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%); color: #e4e4e4; line-height: 1.7; padding: 40px 20px; min-height: 100vh; }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { font-size: 2.5rem; background: linear-gradient(90deg, #fbbf24, #f97316); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
    .subtitle { color: #888; font-size: 1.1rem; margin-bottom: 40px; }
    h2 { color: #fbbf24; font-size: 1.6rem; margin: 40px 0 20px; padding-bottom: 10px; border-bottom: 2px solid #f9731633; }
    h3 { color: #fb923c; font-size: 1.2rem; margin: 25px 0 15px; }
    p { margin-bottom: 16px; color: #ccc; }
    .concept-box { background: linear-gradient(135deg, #3d2a1a 0%, #1a1a2e 100%); border-radius: 16px; padding: 25px; margin: 25px 0; border-left: 4px solid #fbbf24; }
    .warning { background: linear-gradient(135deg, #4a2c2c 0%, #3d1f1f 100%); border-left-color: #ff6b6b; }
    .tip { background: linear-gradient(135deg, #1f4a2c 0%, #1f3d2a 100%); border-left-color: #4ade80; }
    .info { background: linear-gradient(135deg, #2a2a4a 0%, #1a1a2e 100%); border-left-color: #60a5fa; }
    code { background: #0d1117; padding: 3px 8px; border-radius: 4px; font-family: 'Fira Code', monospace; font-size: 0.9em; color: #fbbf24; }
    pre { background: #0d1117; border-radius: 12px; padding: 20px; overflow-x: auto; margin: 20px 0; border: 1px solid #ffffff15; }
    pre code { padding: 0; background: none; }
    .keyword { color: #c792ea; }
    .function { color: #82aaff; }
    .string { color: #c3e88d; }
    .comment { color: #676e95; }
    .number { color: #f78c6c; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ffffff15; }
    th { background: #fbbf2433; color: #fbbf24; }
    tr:hover { background: #ffffff08; }
    .diagram { background: #0d1117; border-radius: 16px; padding: 30px; margin: 30px 0; }
    .history-stack { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .history-entry { background: linear-gradient(135deg, #2a2a4a, #1a1a2e); padding: 15px 25px; border-radius: 10px; border: 2px solid #fbbf2444; width: 80%; max-width: 400px; text-align: center; transition: all 0.3s; }
    .history-entry.current { border-color: #fbbf24; background: linear-gradient(135deg, #3d3a1a, #2a2a1a); box-shadow: 0 0 20px #fbbf2444; }
    .history-entry .url { font-family: monospace; color: #fbbf24; font-size: 0.9rem; }
    .history-entry .state { font-size: 0.8rem; color: #888; margin-top: 5px; }
    .nav-arrows { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
    .nav-arrow { font-size: 2rem; color: #fbbf24; cursor: pointer; transition: transform 0.2s; }
    .nav-arrow:hover { transform: scale(1.2); }
    .interactive-demo { background: #0d1117; border-radius: 16px; padding: 25px; margin: 30px 0; border: 1px solid #fbbf2444; }
    button { background: linear-gradient(135deg, #fbbf24 0%, #f97316 100%); color: #1a1a2e; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.2s; margin: 5px; }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px #fbbf2455; }
    button.secondary { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; }
    button.danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .url-display { background: #1a1a2e; padding: 15px 20px; border-radius: 10px; font-family: monospace; margin: 15px 0; display: flex; align-items: center; gap: 10px; border: 1px solid #fbbf2433; }
    .url-display .protocol { color: #4ade80; }
    .url-display .host { color: #fbbf24; }
    .url-display .path { color: #60a5fa; }
    .state-display { background: #1a1a2e; padding: 15px; border-radius: 10px; font-family: monospace; font-size: 0.9rem; margin: 15px 0; }
    .log-output { background: #0a0a15; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.85rem; max-height: 150px; overflow-y: auto; margin-top: 15px; }
    .log-entry { padding: 5px 0; border-bottom: 1px solid #ffffff10; color: #fbbf24; }
    ul { margin-left: 25px; margin-bottom: 15px; }
    li { margin-bottom: 8px; color: #ccc; }
    .comparison-table { margin: 20px 0; }
    .spa-flow { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; align-items: center; margin: 20px 0; }
    .spa-box { background: linear-gradient(135deg, #f97316, #ea580c); padding: 15px 20px; border-radius: 10px; color: white; font-weight: 600; text-align: center; min-width: 120px; }
    .spa-arrow { color: #fbbf24; font-size: 1.5rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üï∞Ô∏è Chapter 23: History API</h1>
    <p class="subtitle">Managing Browser Navigation in Single-Page Applications</p>

    <h2>üéØ What is the History API?</h2>
    <p>The <strong>History API</strong> allows you to manipulate the browser's session history‚Äîthe pages visited in the current tab. This is fundamental to building Single-Page Applications (SPAs) where you want to update the URL and handle back/forward navigation without full page reloads.</p>

    <div class="concept-box">
      <h3>üí° Why It Matters</h3>
      <p>Without the History API, SPAs would have a poor user experience:</p>
      <ul style="margin-top: 10px; margin-left: 20px;">
        <li>The URL wouldn't change as users navigate</li>
        <li>Back/Forward buttons wouldn't work</li>
        <li>Users couldn't bookmark or share specific pages</li>
        <li>Browser history would be empty</li>
      </ul>
    </div>

    <h2>üìö Understanding the History Stack</h2>
    <p>The browser maintains a "stack" of visited URLs. The History API lets you add to this stack and navigate through it:</p>

    <div class="diagram">
      <div class="history-stack">
        <div class="history-entry">
          <div class="url">/products</div>
          <div class="state">{ category: 'all' }</div>
        </div>
        <div class="history-entry">
          <div class="url">/products/shoes</div>
          <div class="state">{ category: 'shoes' }</div>
        </div>
        <div class="history-entry current">
          <div class="url">/products/shoes/nike-air</div>
          <div class="state">{ id: 123, name: 'Nike Air' }</div>
        </div>
        <div style="color: #888; margin-top: 10px;">‚Üê Current Position</div>
      </div>
      <div class="nav-arrows">
        <span class="nav-arrow">‚¨ÖÔ∏è Back</span>
        <span class="nav-arrow">Forward ‚û°Ô∏è</span>
      </div>
    </div>

    <h2>üß≠ Basic Navigation Methods</h2>
    <pre><code><span class="comment">// Go back one page (like clicking the Back button)</span>
history.<span class="function">back</span>();

<span class="comment">// Go forward one page</span>
history.<span class="function">forward</span>();

<span class="comment">// Go to a specific point in history</span>
history.<span class="function">go</span>(-<span class="number">1</span>);   <span class="comment">// Same as back()</span>
history.<span class="function">go</span>(<span class="number">1</span>);    <span class="comment">// Same as forward()</span>
history.<span class="function">go</span>(-<span class="number">3</span>);   <span class="comment">// Go back 3 pages</span>
history.<span class="function">go</span>(<span class="number">0</span>);    <span class="comment">// Refresh the current page</span>

<span class="comment">// Check how many entries are in history</span>
console.<span class="function">log</span>(history.length);  <span class="comment">// e.g., 5</span></code></pre>

    <h2>üìù Adding History Entries</h2>

    <h3>pushState() - Add New Entry</h3>
    <p>Creates a new entry in the history stack:</p>
    <pre><code><span class="comment">// Syntax: pushState(state, title, url)</span>

history.<span class="function">pushState</span>(
    { page: <span class="string">'products'</span>, id: <span class="number">42</span> },  <span class="comment">// State object (can be any serializable data)</span>
    <span class="string">''</span>,                              <span class="comment">// Title (ignored by most browsers)</span>
    <span class="string">'/products/42'</span>                   <span class="comment">// New URL</span>
);

<span class="comment">// The URL changes immediately, but NO page reload occurs!</span>
<span class="comment">// You must update the page content yourself.</span></code></pre>

    <h3>replaceState() - Replace Current Entry</h3>
    <p>Modifies the current history entry without creating a new one:</p>
    <pre><code><span class="comment">// Replace current entry (doesn't add to history)</span>

history.<span class="function">replaceState</span>(
    { page: <span class="string">'products'</span>, id: <span class="number">42</span>, scrollPos: <span class="number">500</span> },
    <span class="string">''</span>,
    <span class="string">'/products/42'</span>
);

<span class="comment">// Use cases:</span>
<span class="comment">// - Storing scroll position</span>
<span class="comment">// - Updating state without creating new history entry</span>
<span class="comment">// - Fixing a URL without "polluting" history</span></code></pre>

    <div class="concept-box info">
      <h3>üìå Key Differences</h3>
      <table class="comparison-table">
        <tr>
          <th>pushState()</th>
          <th>replaceState()</th>
        </tr>
        <tr>
          <td>Creates new history entry</td>
          <td>Modifies current entry</td>
        </tr>
        <tr>
          <td>Back button goes to previous page</td>
          <td>Back button skips the replaced entry</td>
        </tr>
        <tr>
          <td>history.length increases</td>
          <td>history.length stays the same</td>
        </tr>
      </table>
    </div>

    <h2>üì° The popstate Event</h2>
    <p>This event fires when the user navigates through history (back/forward buttons, or <code>history.go()</code>):</p>

    <pre><code>window.<span class="function">addEventListener</span>(<span class="string">'popstate'</span>, (event) => {
    console.<span class="function">log</span>(<span class="string">'Navigation occurred!'</span>);
    console.<span class="function">log</span>(<span class="string">'New state:'</span>, event.state);
    console.<span class="function">log</span>(<span class="string">'Current URL:'</span>, location.href);
    
    <span class="comment">// Update your UI based on the new state</span>
    <span class="keyword">if</span> (event.state) {
        <span class="function">renderPage</span>(event.state);
    }
});</code></pre>

    <div class="concept-box warning">
      <h3>‚ö†Ô∏è Important: popstate Does NOT Fire for pushState/replaceState</h3>
      <p>The <code>popstate</code> event only fires when the user actually navigates (clicks back/forward or uses <code>history.go()</code>). It does NOT fire when you call <code>pushState()</code> or <code>replaceState()</code>. You must update your UI manually when using these methods.</p>
    </div>

    <h2>üéÆ Interactive Demo</h2>
    <div class="interactive-demo">
      <p>Experiment with the History API (watch the URL bar and state):</p>
      
      <div class="url-display">
        <span class="protocol">https://</span>
        <span class="host">example.com</span>
        <span class="path" id="current-path">/home</span>
      </div>
      
      <div style="margin: 15px 0;">
        <button onclick="navigateTo('/home', {page: 'home'})">üè† Home</button>
        <button onclick="navigateTo('/products', {page: 'products'})">üì¶ Products</button>
        <button onclick="navigateTo('/about', {page: 'about'})">‚ÑπÔ∏è About</button>
        <button onclick="navigateTo('/contact', {page: 'contact'})">üìß Contact</button>
      </div>
      
      <div style="margin: 15px 0;">
        <button onclick="goBack()" class="secondary">‚¨ÖÔ∏è Back</button>
        <button onclick="goForward()" class="secondary">Forward ‚û°Ô∏è</button>
        <button onclick="replaceCurrentState()" class="danger">Replace State</button>
      </div>
      
      <h4 style="color: #fbbf24; margin-top: 20px;">Current State:</h4>
      <div class="state-display" id="state-display">{ page: 'home' }</div>
      
      <h4 style="color: #fbbf24;">History Length: <span id="history-length">1</span></h4>
      
      <div class="log-output" id="history-log"></div>
    </div>

    <h2>üèóÔ∏è Building an SPA Router</h2>
    <p>Here's a complete example of a simple client-side router:</p>

    <pre><code><span class="keyword">class</span> <span class="function">Router</span> {
    <span class="function">constructor</span>(routes) {
        <span class="keyword">this</span>.routes = routes;
        
        <span class="comment">// Listen for back/forward navigation</span>
        window.<span class="function">addEventListener</span>(<span class="string">'popstate'</span>, (e) => {
            <span class="keyword">this</span>.<span class="function">handleRoute</span>(location.pathname, e.state);
        });
        
        <span class="comment">// Intercept link clicks</span>
        document.<span class="function">addEventListener</span>(<span class="string">'click'</span>, (e) => {
            <span class="keyword">const</span> link = e.target.<span class="function">closest</span>(<span class="string">'a[href^="/"]'</span>);
            <span class="keyword">if</span> (link) {
                e.<span class="function">preventDefault</span>();
                <span class="keyword">this</span>.<span class="function">navigate</span>(link.href);
            }
        });
        
        <span class="comment">// Handle initial route</span>
        <span class="keyword">this</span>.<span class="function">handleRoute</span>(location.pathname);
    }
    
    <span class="function">navigate</span>(url, state = {}) {
        <span class="keyword">const</span> path = <span class="keyword">new</span> <span class="function">URL</span>(url, location.origin).pathname;
        
        <span class="comment">// Add to history</span>
        history.<span class="function">pushState</span>(state, <span class="string">''</span>, path);
        
        <span class="comment">// Render the new route</span>
        <span class="keyword">this</span>.<span class="function">handleRoute</span>(path, state);
    }
    
    <span class="function">handleRoute</span>(path, state = {}) {
        <span class="comment">// Find matching route</span>
        <span class="keyword">const</span> route = <span class="keyword">this</span>.routes.<span class="function">find</span>(r => {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> r.path === <span class="string">'string'</span>) {
                <span class="keyword">return</span> r.path === path;
            }
            <span class="keyword">return</span> r.path.<span class="function">test</span>(path);  <span class="comment">// Regex match</span>
        });
        
        <span class="keyword">if</span> (route) {
            route.<span class="function">handler</span>(path, state);
        } <span class="keyword">else</span> {
            <span class="keyword">this</span>.<span class="function">notFound</span>(path);
        }
    }
    
    <span class="function">notFound</span>(path) {
        document.<span class="function">getElementById</span>(<span class="string">'app'</span>).innerHTML = <span class="string">'404 - Page Not Found'</span>;
    }
}

<span class="comment">// Usage</span>
<span class="keyword">const</span> router = <span class="keyword">new</span> <span class="function">Router</span>([
    {
        path: <span class="string">'/'</span>,
        handler: () => <span class="function">renderHome</span>()
    },
    {
        path: <span class="string">'/products'</span>,
        handler: () => <span class="function">renderProducts</span>()
    },
    {
        path: /^\/products\/(\d+)$/,  <span class="comment">// Dynamic route</span>
        handler: (path) => {
            <span class="keyword">const</span> id = path.<span class="function">match</span>(/(\d+)/)[<span class="number">1</span>];
            <span class="function">renderProduct</span>(id);
        }
    }
]);</code></pre>

    <h2>üíæ Working with State</h2>
    <p>The state object is powerful for preserving UI state across navigation:</p>

    <pre><code><span class="comment">// Store scroll position before navigating away</span>
<span class="keyword">function</span> <span class="function">saveScrollPosition</span>() {
    history.<span class="function">replaceState</span>(
        { ...history.state, scrollY: window.scrollY },
        <span class="string">''</span>
    );
}

<span class="comment">// Restore scroll position when returning</span>
window.<span class="function">addEventListener</span>(<span class="string">'popstate'</span>, (e) => {
    <span class="keyword">if</span> (e.state?.scrollY !== <span class="keyword">undefined</span>) {
        <span class="function">requestAnimationFrame</span>(() => {
            window.<span class="function">scrollTo</span>(<span class="number">0</span>, e.state.scrollY);
        });
    }
});

<span class="comment">// Store form data</span>
history.<span class="function">pushState</span>({
    formData: {
        name: <span class="string">'John'</span>,
        email: <span class="string">'john@example.com'</span>,
        step: <span class="number">2</span>
    }
}, <span class="string">''</span>, <span class="string">'/checkout/step-2'</span>);</code></pre>

    <div class="concept-box tip">
      <h3>‚úÖ State Best Practices</h3>
      <ul style="margin-left: 20px; margin-top: 10px;">
        <li><strong>Keep it serializable:</strong> State must be JSON-serializable (no functions, DOM elements)</li>
        <li><strong>Keep it small:</strong> There's a size limit (~640KB in most browsers)</li>
        <li><strong>Store essentials only:</strong> Page ID, scroll position, active tab, form step</li>
        <li><strong>Access via history.state:</strong> Read current state anytime with <code>history.state</code></li>
      </ul>
    </div>

    <h2>üîó SPA Navigation Flow</h2>
    <div class="diagram">
      <div class="spa-flow">
        <div class="spa-box">User Clicks Link</div>
        <span class="spa-arrow">‚Üí</span>
        <div class="spa-box">preventDefault()</div>
        <span class="spa-arrow">‚Üí</span>
        <div class="spa-box">pushState()</div>
        <span class="spa-arrow">‚Üí</span>
        <div class="spa-box">Update UI</div>
        <span class="spa-arrow">‚Üí</span>
        <div class="spa-box">Fetch Data (if needed)</div>
      </div>
    </div>

    <h2>‚ö†Ô∏è Common Gotchas</h2>

    <div class="concept-box warning">
      <h3>1. Same-Origin Restriction</h3>
      <p>You can only set URLs on the same origin. This will throw an error:</p>
      <pre style="margin-top:10px;"><code>history.<span class="function">pushState</span>({}, <span class="string">''</span>, <span class="string">'https://other-site.com'</span>);  <span class="comment">// SecurityError!</span></code></pre>
    </div>

    <div class="concept-box warning">
      <h3>2. Server Must Handle All Routes</h3>
      <p>If a user bookmarks <code>/products/42</code> and visits directly, your server must return the SPA HTML for all routes, not a 404.</p>
    </div>

    <div class="concept-box warning">
      <h3>3. Initial Page Load</h3>
      <p>On initial load, <code>history.state</code> is <code>null</code>. Always check for this:</p>
      <pre style="margin-top:10px;"><code><span class="keyword">const</span> state = history.state || { page: <span class="string">'home'</span> };  <span class="comment">// Default state</span></code></pre>
    </div>

    <h2>üéØ When to Use pushState vs replaceState</h2>
    <table>
      <tr>
        <th>Use pushState()</th>
        <th>Use replaceState()</th>
      </tr>
      <tr>
        <td>Navigating to a new "page"</td>
        <td>Updating state without new history entry</td>
      </tr>
      <tr>
        <td>User action that should be "undoable"</td>
        <td>Saving scroll position</td>
      </tr>
      <tr>
        <td>Opening a modal that changes URL</td>
        <td>Fixing/normalizing URLs</td>
      </tr>
      <tr>
        <td>Pagination</td>
        <td>Updating filters without cluttering history</td>
      </tr>
    </table>
  </div>

  <script>
    const pathEl = document.getElementById('current-path');
    const stateEl = document.getElementById('state-display');
    const lengthEl = document.getElementById('history-length');
    const logEl = document.getElementById('history-log');
    
    // Initialize with home state
    history.replaceState({ page: 'home' }, '', '/home');
    updateDisplay();
    
    function navigateTo(path, state) {
      history.pushState(state, '', path);
      updateDisplay();
      addLog(`pushState ‚Üí ${path}`);
    }
    
    function goBack() {
      history.back();
    }
    
    function goForward() {
      history.forward();
    }
    
    function replaceCurrentState() {
      const newState = { ...history.state, replaced: true, time: Date.now() };
      history.replaceState(newState, '');
      updateDisplay();
      addLog(`replaceState ‚Üí added timestamp`);
    }
    
    function updateDisplay() {
      pathEl.textContent = location.pathname;
      stateEl.textContent = JSON.stringify(history.state, null, 2);
      lengthEl.textContent = history.length;
    }
    
    function addLog(message) {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.prepend(entry);
    }
    
    // Listen for popstate (back/forward)
    window.addEventListener('popstate', (e) => {
      updateDisplay();
      addLog(`popstate ‚Üê ${location.pathname}`);
    });
  </script>
</body>
</html>
