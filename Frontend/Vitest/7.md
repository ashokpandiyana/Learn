# Chapter 7: Code Coverage - Complete Guide

## 7.1 Coverage Setup

### What is Code Coverage?

Code coverage measures which parts of your code are executed during tests. It helps identify untested code paths and improve test quality.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Coverage Metrics Explained                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   function calculateDiscount(price) {       â”‚
â”‚ âœ“   if (price > 100) {           â† Branch 1â”‚
â”‚ âœ“     return price * 0.9                    â”‚
â”‚ âœ—   } else {                     â† Branch 2â”‚
â”‚ âœ—     return price * 0.95                   â”‚
â”‚     }                                        â”‚
â”‚   }                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Lines Coverage:      75% (3/4 lines)      â”‚
â”‚   Branch Coverage:     50% (1/2 branches)   â”‚
â”‚   Function Coverage:   100% (1/1 function)  â”‚
â”‚   Statement Coverage:  75% (3/4 statements) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Installing Coverage Providers

```bash
# Option 1: V8 (recommended - faster)
npm install -D @vitest/coverage-v8

# Option 2: Istanbul (more accurate for some cases)
npm install -D @vitest/coverage-istanbul
```

### Basic Coverage Configuration

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    coverage: {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // PROVIDER
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      provider: 'v8', // or 'istanbul'
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // REPORTERS - How coverage is displayed
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      reporter: [
        'text',      // Console output
        'text-summary', // Brief summary
        'json',      // JSON file for tools
        'html',      // HTML report for browsers
        'lcov'       // LCOV for CI tools
      ],
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // OUTPUT
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      reportsDirectory: './coverage',
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // THRESHOLDS - Minimum coverage required
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 80,
        statements: 80
      }
    }
  }
})
```

### Running Coverage

```bash
# Run tests with coverage
vitest --coverage

# Run in CI mode
vitest run --coverage

# Watch mode with coverage (slow - not recommended)
vitest --coverage --watch

# Update coverage after changes
vitest --coverage --changed
```

---

## 7.2 Coverage Types Explained

### 1. Line Coverage

Measures which lines of code were executed.

```typescript
// calculator.ts
export function calculate(a: number, b: number, op: string): number {
  let result = 0                    // âœ“ Line 1 - Covered
  
  if (op === 'add') {               // âœ“ Line 2 - Covered
    result = a + b                  // âœ“ Line 3 - Covered
  } else if (op === 'subtract') {   // âœ“ Line 4 - Covered
    result = a - b                  // âœ— Line 5 - NOT Covered
  }
  
  return result                     // âœ“ Line 6 - Covered
}

// Test (incomplete)
it('should add numbers', () => {
  expect(calculate(5, 3, 'add')).toBe(8)
})

// Line Coverage: 83.3% (5/6 lines covered)
// Line 5 is not executed by any test
```

**How to improve:**
```typescript
// Add test for subtract
it('should subtract numbers', () => {
  expect(calculate(5, 3, 'subtract')).toBe(2)
})
// Now: 100% line coverage
```

### 2. Branch Coverage

Measures which decision paths (if/else, switch, ternary) were taken.

```typescript
// discount.ts
export function calculateDiscount(
  price: number,
  isPremium: boolean
): number {
  // Two branches: isPremium true/false
  if (isPremium) {           // âœ“ Branch 1 - Covered
    return price * 0.8       // âœ“ Executed
  } else {                   // âœ— Branch 2 - NOT Covered
    return price * 0.9       // âœ— Not executed
  }
}

// Test (incomplete)
it('should apply premium discount', () => {
  expect(calculateDiscount(100, true)).toBe(80)
})

// Branch Coverage: 50% (1/2 branches covered)
```

**Branch Coverage Examples:**

```typescript
// Example 1: If statement
function checkAge(age: number): string {
  if (age >= 18) {           // Branch 1: true
    return 'adult'
  } else {                   // Branch 2: false
    return 'minor'
  }
}
// Need 2 tests for 100% branch coverage

// Example 2: Nested branches
function getDiscount(price: number, isMember: boolean): number {
  if (price > 100) {                    // Branch A
    if (isMember) {                     // Branch B
      return price * 0.8                // Path A+B
    } else {                            // Branch !B
      return price * 0.9                // Path A+!B
    }
  } else {                              // Branch !A
    return price                        // Path !A
  }
}
// Need 3 tests for 100% branch coverage:
// 1. price > 100, isMember = true
// 2. price > 100, isMember = false
// 3. price <= 100

// Example 3: Switch statement
function getGrade(score: number): string {
  switch (true) {
    case score >= 90:        // Branch 1
      return 'A'
    case score >= 80:        // Branch 2
      return 'B'
    case score >= 70:        // Branch 3
      return 'C'
    default:                 // Branch 4
      return 'F'
  }
}
// Need 4 tests for 100% branch coverage
```

### 3. Function Coverage

Measures which functions were called.

```typescript
// utils.ts
export function add(a: number, b: number): number {      // âœ“ Called
  return a + b
}

export function subtract(a: number, b: number): number { // âœ“ Called
  return a - b
}

export function multiply(a: number, b: number): number { // âœ— Never called
  return a * b
}

export function divide(a: number, b: number): number {   // âœ— Never called
  if (b === 0) throw new Error('Division by zero')
  return a / b
}

// Test
describe('Math utils', () => {
  it('should add', () => expect(add(2, 3)).toBe(5))
  it('should subtract', () => expect(subtract(5, 3)).toBe(2))
})

// Function Coverage: 50% (2/4 functions called)
```

### 4. Statement Coverage

Measures which statements were executed (similar to line coverage but more granular).

```typescript
// validator.ts
export function validateUser(user: { name?: string; email?: string }) {
  if (!user.name) throw new Error('Name required')      // Statement 1 âœ“
  if (!user.email) throw new Error('Email required')    // Statement 2 âœ—
  if (!user.email.includes('@')) {                      // Statement 3 âœ—
    throw new Error('Invalid email')                    // Statement 4 âœ—
  }
  return true                                           // Statement 5 âœ—
}

// Test (incomplete)
it('should validate user name', () => {
  expect(() => validateUser({})).toThrow('Name required')
})

// Statement Coverage: 20% (1/5 statements)
```

### Coverage Visualization

```
Terminal Output:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ File            | % Stmts | % Branch | % Funcs | % Lines â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ All files       |   75.00 |    50.00 |   66.67 |   75.00 â”‚
â”‚  calculator.ts  |   83.33 |    50.00 |  100.00 |   83.33 â”‚
â”‚  discount.ts    |   66.67 |    50.00 |  100.00 |   66.67 â”‚
â”‚  utils.ts       |   50.00 |     N/A  |   50.00 |   50.00 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HTML Report:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ File: calculator.ts                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  âœ“ function calculate(a, b, op) {    â”‚
â”‚ 2  âœ“   let result = 0                  â”‚
â”‚ 3  âœ“   if (op === 'add') {             â”‚
â”‚ 4  âœ“     result = a + b                â”‚
â”‚ 5  âœ—   } else if (op === 'subtract') { â”‚  â† Not covered
â”‚ 6  âœ—     result = a - b                â”‚  â† Not covered
â”‚ 7  âœ“   }                                â”‚
â”‚ 8  âœ“   return result                   â”‚
â”‚ 9  âœ“ }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7.3 Coverage Best Practices

### Setting Realistic Thresholds

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    coverage: {
      thresholds: {
        // âŒ TOO STRICT - Hard to maintain
        // lines: 100,
        // branches: 100,
        // functions: 100,
        
        // âœ… REALISTIC - Industry standard
        lines: 80,
        branches: 75,
        functions: 80,
        statements: 80,
        
        // Per-file thresholds (advanced)
        perFile: true,
        
        // Glob-specific thresholds
        'src/utils/**/*.ts': {
          lines: 90,
          functions: 90
        },
        'src/components/**/*.tsx': {
          lines: 75,
          branches: 70
        }
      }
    }
  }
})
```

### What to Include/Exclude from Coverage

```typescript
export default defineConfig({
  test: {
    coverage: {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // INCLUDE - What to measure
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      include: [
        'src/**/*.{js,ts,jsx,tsx}',
        '!src/**/*.d.ts'
      ],
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // EXCLUDE - What to ignore
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      exclude: [
        // Dependencies
        'node_modules/**',
        
        // Build output
        'dist/**',
        'build/**',
        '.next/**',
        
        // Config files
        '**/*.config.{js,ts}',
        '**/vite.config.*',
        '**/vitest.config.*',
        
        // Test files
        '**/*.test.{js,ts,jsx,tsx}',
        '**/*.spec.{js,ts,jsx,tsx}',
        '**/test/**',
        '**/__tests__/**',
        
        // Mock data
        '**/mockData.ts',
        '**/__mocks__/**',
        
        // Type definitions
        '**/*.d.ts',
        
        // Generated code
        'src/generated/**',
        
        // Stories/docs
        '**/*.stories.{js,ts,jsx,tsx}',
        
        // Entry points (often just imports)
        'src/main.{js,ts,jsx,tsx}',
        'src/index.{js,ts,jsx,tsx}'
      ]
    }
  }
})
```

### Using Coverage Comments

```typescript
// Ignore entire function
/* istanbul ignore next */
export function debugHelper() {
  console.log('Debug info')
  // This function is excluded from coverage
}

// Ignore specific branch
export function processData(data: any) {
  if (data.special) {
    // Production code
    return processSpecial(data)
  } 
  /* istanbul ignore next */
  else {
    // Debug/development only
    console.warn('Development mode')
    return null
  }
}

// Ignore next statement
export function initialize() {
  setupDatabase()
  /* istanbul ignore next */
  if (process.env.DEBUG) console.log('Initialized')
}
```

**âš ï¸ Warning:** Use coverage comments sparingly! They should be for:
- Debug/logging code
- Defensive programming (error cases that "can't happen")
- Platform-specific code in cross-platform apps

### Real-World Example: API Service Coverage

```typescript
// api.ts
export class UserAPI {
  constructor(private baseUrl: string) {}
  
  async getUser(id: number): Promise<User> {
    try {
      const response = await fetch(`${this.baseUrl}/users/${id}`)
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }
      
      return await response.json()
    } catch (error) {
      /* istanbul ignore next - Network errors tested separately */
      if (error instanceof TypeError) {
        throw new Error('Network error')
      }
      throw error
    }
  }
  
  async createUser(data: CreateUserDto): Promise<User> {
    const response = await fetch(`${this.baseUrl}/users`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    
    if (!response.ok) {
      const error = await response.json()
      throw new Error(error.message)
    }
    
    return await response.json()
  }
}
```

```typescript
// api.test.ts - Comprehensive coverage
describe('UserAPI', () => {
  let api: UserAPI
  
  beforeEach(() => {
    api = new UserAPI('http://localhost:3000')
    global.fetch = vi.fn()
  })
  
  describe('getUser', () => {
    // âœ“ Covers: successful response, json parsing
    it('should fetch user successfully', async () => {
      vi.mocked(fetch).mockResolvedValue({
        ok: true,
        json: async () => ({ id: 1, name: 'John' })
      } as Response)
      
      const user = await api.getUser(1)
      expect(user).toEqual({ id: 1, name: 'John' })
    })
    
    // âœ“ Covers: !response.ok branch, error throwing
    it('should throw on 404', async () => {
      vi.mocked(fetch).mockResolvedValue({
        ok: false,
        status: 404
      } as Response)
      
      await expect(api.getUser(999)).rejects.toThrow('HTTP 404')
    })
    
    // âœ“ Covers: catch block, error re-throw
    it('should handle network errors', async () => {
      vi.mocked(fetch).mockRejectedValue(new Error('Failed'))
      
      await expect(api.getUser(1)).rejects.toThrow('Failed')
    })
  })
  
  describe('createUser', () => {
    // âœ“ Covers: POST request, successful response
    it('should create user', async () => {
      const userData = { name: 'Jane', email: 'jane@example.com' }
      
      vi.mocked(fetch).mockResolvedValue({
        ok: true,
        json: async () => ({ id: 2, ...userData })
      } as Response)
      
      const user = await api.createUser(userData)
      expect(user).toEqual({ id: 2, ...userData })
    })
    
    // âœ“ Covers: error response, error json parsing
    it('should handle validation errors', async () => {
      vi.mocked(fetch).mockResolvedValue({
        ok: false,
        json: async () => ({ message: 'Invalid email' })
      } as Response)
      
      await expect(
        api.createUser({ name: 'Jane', email: 'invalid' })
      ).rejects.toThrow('Invalid email')
    })
  })
})

// Result: ~95% coverage
// Missing: Only network TypeError branch (ignored with comment)
```

---

## 7.4 Coverage Reports

### Terminal Report (text)

```bash
vitest --coverage --reporter=text
```

```
----------------------------|---------|----------|---------|---------|-------------------
File                        | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
----------------------------|---------|----------|---------|---------|-------------------
All files                   |   85.71 |    83.33 |     100 |   85.71 |                   
 src/api                    |   90.00 |    87.50 |     100 |   90.00 |                   
  user.ts                   |   90.00 |    87.50 |     100 |   90.00 | 45-47             
 src/utils                  |   80.00 |    75.00 |     100 |   80.00 |                   
  validator.ts              |   80.00 |    75.00 |     100 |   80.00 | 12,23             
----------------------------|---------|----------|---------|---------|-------------------
```

### HTML Report

```bash
vitest --coverage --reporter=html
```

Opens `coverage/index.html` in browser with:
- Color-coded files (green = good coverage, red = poor)
- Line-by-line highlighting
- Branch visualization
- Interactive navigation

### JSON Report (for CI tools)

```bash
vitest --coverage --reporter=json
```

```json
{
  "total": {
    "lines": { "total": 100, "covered": 85, "skipped": 0, "pct": 85 },
    "statements": { "total": 100, "covered": 85, "skipped": 0, "pct": 85 },
    "functions": { "total": 25, "covered": 25, "skipped": 0, "pct": 100 },
    "branches": { "total": 40, "covered": 33, "skipped": 0, "pct": 82.5 }
  },
  "files": {
    "src/api/user.ts": {
      "lines": { "total": 30, "covered": 27, "skipped": 0, "pct": 90 },
      "statements": { "total": 30, "covered": 27, "skipped": 0, "pct": 90 },
      "functions": { "total": 5, "covered": 5, "skipped": 0, "pct": 100 },
      "branches": { "total": 8, "covered": 7, "skipped": 0, "pct": 87.5 }
    }
  }
}
```

### LCOV Report (for external tools)

```bash
vitest --coverage --reporter=lcov
```

Generates `coverage/lcov.info` for:
- Codecov
- Coveralls
- SonarQube
- GitHub Actions

### Custom Reporter

```typescript
// reporters/coverage-summary.ts
import type { Reporter } from 'vitest'

export default class CoverageSummaryReporter implements Reporter {
  onFinished(files: File[], errors: Error[]) {
    const coverage = this.calculateCoverage(files)
    
    console.log('\nğŸ“Š Coverage Summary:')
    console.log(`Lines: ${coverage.lines}%`)
    console.log(`Branches: ${coverage.branches}%`)
    console.log(`Functions: ${coverage.functions}%`)
    
    if (coverage.lines < 80) {
      console.error('âŒ Coverage below threshold!')
      process.exit(1)
    }
  }
}
```

---

## 7.5 Coverage in CI/CD

### GitHub Actions Example

```yaml
# .github/workflows/test.yml
name: Test & Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage
        run: npm run test:coverage
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: true
      
      - name: Check coverage thresholds
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            node scripts/check-coverage.js
          fi
      
      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: ./coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
```

### Coverage Threshold Script

```javascript
// scripts/check-coverage.js
const fs = require('fs')
const summary = require('../coverage/coverage-summary.json')

const THRESHOLDS = {
  lines: 80,
  statements: 80,
  functions: 80,
  branches: 75
}

const { total } = summary
let failed = false

for (const [key, threshold] of Object.entries(THRESHOLDS)) {
  const coverage = total[key].pct
  const passed = coverage >= threshold
  
  const symbol = passed ? 'âœ“' : 'âœ—'
  const color = passed ? '\x1b[32m' : '\x1b[31m'
  
  console.log(
    `${color}${symbol}\x1b[0m ${key}: ${coverage.toFixed(2)}% (threshold: ${threshold}%)`
  )
  
  if (!passed) failed = true
}

if (failed) {
  console.error('\nâŒ Coverage thresholds not met!')
  process.exit(1)
}

console.log('\nâœ… All coverage thresholds met!')
```

### GitLab CI Example

```yaml
# .gitlab-ci.yml
test:
  stage: test
  image: node:18
  script:
    - npm ci
    - npm run test:coverage
  coverage: '/Lines\s*:\s*(\d+\.?\d*)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days
```

---

## 7.6 Coverage Anti-Patterns

### 1. âŒ Chasing 100% Coverage

```typescript
// DON'T write tests just for coverage

// Bad - Testing implementation details
it('should have a name property', () => {
  const user = new User('John')
  expect(user).toHaveProperty('name')  // Meaningless test
})

// Good - Testing behavior
it('should return user name', () => {
  const user = new User('John')
  expect(user.getName()).toBe('John')  // Tests actual behavior
})
```

### 2. âŒ Testing for the Sake of Testing

```typescript
// Bad - No value added
it('should import module', () => {
  expect(myModule).toBeDefined()  // Useless test
})

// Bad - Testing getters/setters
it('should set and get value', () => {
  obj.value = 42
  expect(obj.value).toBe(42)  // Tests language feature
})
```

### 3. âŒ Ignoring Coverage on Important Code

```typescript
// Bad - Hiding poor test quality
export function processPayment(amount: number) {
  /* istanbul ignore next */
  if (amount < 0) {
    throw new Error('Invalid amount')  // Should be tested!
  }
  return chargeCard(amount)
}
```

### 4. âŒ Over-mocking to Boost Coverage

```typescript
// Bad - Mock everything
vi.mock('./validation')
vi.mock('./formatting')
vi.mock('./calculation')

// This gives 100% coverage but tests nothing!
```

### 5. âŒ Not Testing Error Paths

```typescript
// validator.ts
export function validateEmail(email: string): boolean {
  if (!email) return false              // âœ“ Tested
  if (!email.includes('@')) return false // âœ— Not tested
  if (email.length < 5) return false     // âœ— Not tested
  return true                            // âœ“ Tested
}

// Incomplete test - 60% branch coverage
it('validates email', () => {
  expect(validateEmail('test@example.com')).toBe(true)
  expect(validateEmail('')).toBe(false)
})
```

---

## 7.7 Coverage Best Practices Summary

### âœ… DO

1. **Aim for 80% coverage** as a baseline
2. **Focus on critical paths** (auth, payments, data validation)
3. **Test edge cases and error conditions**
4. **Review uncovered code** to understand why
5. **Use coverage to find gaps**, not as a goal
6. **Test behavior**, not implementation
7. **Track coverage trends** over time

### âŒ DON'T

1. **Don't chase 100%** - diminishing returns
2. **Don't test trivial code** (getters, constants)
3. **Don't ignore legitimate gaps** with coverage comments
4. **Don't sacrifice test quality** for coverage numbers
5. **Don't mock everything** to boost coverage
6. **Don't skip error paths** - they're often most important
7. **Don't commit without running coverage** in CI

### Coverage Guidelines by Code Type

```typescript
// HIGH priority (aim for 90%+)
- Authentication/Authorization
- Payment processing
- Data validation
- Security features
- Business logic

// MEDIUM priority (aim for 80%+)
- API endpoints
- Data transformations
- User interactions
- Form handling

// LOW priority (aim for 60%+)
- UI components (appearance)
- Formatting utilities
- Logging/monitoring code
- Debug helpers
```

---

## Summary: Chapter 7

### Key Takeaways

1. **Coverage Metrics**
   - **Lines**: Which lines executed
   - **Branches**: Which paths taken
   - **Functions**: Which functions called
   - **Statements**: Which statements executed

2. **Setup**
   - Use V8 provider (faster)
   - Set realistic thresholds (80% is good)
   - Exclude config/test files
   - Configure multiple reporters

3. **Best Practices**
   - Coverage finds gaps, not quality
   - Test behavior, not implementation
   - Don't ignore error paths
   - Review uncovered code carefully

4. **CI/CD Integration**
   - Run coverage in CI
   - Upload to coverage services
   - Fail builds below thresholds
   - Track trends over time

### Quick Reference

```typescript
// Configuration
coverage: {
  provider: 'v8',
  reporter: ['text', 'json', 'html'],
  thresholds: {
    lines: 80,
    branches: 75,
    functions: 80,
    statements: 80
  }
}

// Commands
vitest --coverage              # Run with coverage
vitest --coverage --reporter=html  # HTML report

// Coverage comments
/* istanbul ignore next */      # Ignore next statement/block
```

**Coverage is a tool, not a goal.** High coverage â‰  Good tests. Focus on testing the right things, and coverage will follow naturally.