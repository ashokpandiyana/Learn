# Chapter 6: Configuration & Optimization - Complete Guide

## 6.1 Configuration Deep Dive

### Understanding Vitest Configuration

Vitest configuration extends Vite's configuration, allowing you to leverage your existing build setup for testing.

```typescript
// vitest.config.ts - Complete configuration example
import { defineConfig } from 'vitest/config'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  // Vite plugins work in tests too
  plugins: [react()],
  
  // Resolve configuration (aliases, extensions)
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
      '@components': path.resolve(__dirname, './src/components'),
      '@utils': path.resolve(__dirname, './src/utils'),
      '@test': path.resolve(__dirname, './test')
    },
    extensions: ['.mjs', '.js', '.ts', '.jsx', '.tsx', '.json']
  },
  
  // Test-specific configuration
  test: {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GLOBAL SETTINGS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Make test functions globally available
    globals: true,
    
    // Test environment
    environment: 'happy-dom', // 'node' | 'jsdom' | 'happy-dom' | 'edge-runtime'
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FILE DISCOVERY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Test file patterns
    include: ['**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}'],
    
    // Files to exclude from testing
    exclude: [
      'node_modules',
      'dist',
      '.idea',
      '.git',
      '.cache',
      '**/node_modules/**',
      '**/dist/**',
      '**/cypress/**',
      '**/.{idea,git,cache,output,temp}/**'
    ],
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXECUTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Run tests in parallel using threads
    threads: true,
    
    // Maximum number of threads
    maxThreads: 4,
    
    // Minimum number of threads
    minThreads: 1,
    
    // Isolate test environment for each test file
    isolate: true,
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TIMEOUTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Default test timeout (ms)
    testTimeout: 5000,
    
    // Hook timeout (ms)
    hookTimeout: 10000,
    
    // Teardown timeout (ms)
    teardownTimeout: 10000,
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WATCH MODE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Enable watch mode
    watch: true,
    
    // Files to ignore in watch mode
    watchExclude: [
      '**/node_modules/**',
      '**/dist/**'
    ],
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SETUP & TEARDOWN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Setup files (runs before each test file)
    setupFiles: [
      './test/setup.ts'
    ],
    
    // Global setup (runs once before all tests)
    globalSetup: './test/globalSetup.ts',
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REPORTERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Test reporters
    reporters: ['default', 'json', 'html'],
    
    // Output files for reporters
    outputFile: {
      json: './test-results.json',
      html: './test-results.html'
    },
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COVERAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    coverage: {
      provider: 'v8', // or 'istanbul'
      
      // Coverage reporters
      reporter: ['text', 'json', 'html', 'lcov'],
      
      // Output directory
      reportsDirectory: './coverage',
      
      // Files to include in coverage
      include: ['src/**/*.{js,ts,jsx,tsx}'],
      
      // Files to exclude from coverage
      exclude: [
        'node_modules/',
        'test/',
        '**/*.d.ts',
        '**/*.config.*',
        '**/mockData.ts',
        '**/*.test.{js,ts,jsx,tsx}',
        '**/*.spec.{js,ts,jsx,tsx}'
      ],
      
      // Coverage thresholds
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 80,
        statements: 80
      },
      
      // Fail if coverage is below thresholds
      skipFull: false,
      
      // Clean coverage directory before running
      clean: true,
      
      // All coverage options
      all: true
    },
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BEHAVIOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Bail after first test failure
    bail: 1,
    
    // Retry failed tests
    retry: 0,
    
    // Silent mode (no console.log output)
    silent: false,
    
    // Hide passed tests in output
    hideSkippedTests: false,
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI MODE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ui: {
      enabled: true,
      open: true,
      port: 51204
    },
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BROWSER MODE (experimental)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // browser: {
    //   enabled: true,
    //   name: 'chrome',
    //   provider: 'playwright',
    //   headless: true
    // }
  }
})
```

### Configuration Strategies

#### Strategy 1: Separate Test Config

```typescript
// vite.config.ts - Application config
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  build: {
    outDir: 'dist'
  }
})
```

```typescript
// vitest.config.ts - Test-specific config
import { defineConfig, mergeConfig } from 'vitest/config'
import viteConfig from './vite.config'

export default mergeConfig(
  viteConfig,
  defineConfig({
    test: {
      globals: true,
      environment: 'happy-dom'
    }
  })
)
```

#### Strategy 2: Shared Config with Conditionals

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig(({ mode }) => {
  const isTest = mode === 'test'
  
  return {
    plugins: [react()],
    
    // Only include test config in test mode
    ...(isTest && {
      test: {
        globals: true,
        environment: 'happy-dom'
      }
    })
  }
})
```

#### Strategy 3: Environment-Based Config

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'

const isCI = process.env.CI === 'true'

export default defineConfig({
  test: {
    // Different settings for CI
    threads: isCI ? true : false,
    reporters: isCI ? ['json', 'default'] : ['default'],
    coverage: {
      enabled: isCI,
      thresholds: {
        lines: isCI ? 80 : 60
      }
    },
    retry: isCI ? 2 : 0
  }
})
```

---

## 6.2 Global Test Setup

### Understanding Setup Files

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Test Execution Flow                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   1. globalSetup (once)                     â”‚
â”‚      â†“                                       â”‚
â”‚   2. setupFiles (per test file)             â”‚
â”‚      â†“                                       â”‚
â”‚   3. beforeAll hooks                        â”‚
â”‚      â†“                                       â”‚
â”‚   4. beforeEach hooks                       â”‚
â”‚      â†“                                       â”‚
â”‚   5. Test execution                         â”‚
â”‚      â†“                                       â”‚
â”‚   6. afterEach hooks                        â”‚
â”‚      â†“                                       â”‚
â”‚   7. afterAll hooks                         â”‚
â”‚      â†“                                       â”‚
â”‚   8. globalTeardown (once)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### setupFiles - Per Test File Setup

```typescript
// test/setup.ts
import { expect, afterEach, beforeAll } from 'vitest'
import { cleanup } from '@testing-library/react'
import * as matchers from '@testing-library/jest-dom/matchers'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXTEND EXPECT WITH CUSTOM MATCHERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

expect.extend(matchers)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL CLEANUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

afterEach(() => {
  cleanup()
})

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOCK GLOBAL APIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Mock fetch
global.fetch = vi.fn()

// Mock window.matchMedia
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  }))
})

// Mock IntersectionObserver
global.IntersectionObserver = class IntersectionObserver {
  constructor() {}
  disconnect() {}
  observe() {}
  takeRecords() { return [] }
  unobserve() {}
}

// Mock ResizeObserver
global.ResizeObserver = class ResizeObserver {
  constructor() {}
  disconnect() {}
  observe() {}
  unobserve() {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOCK ENVIRONMENT VARIABLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

process.env.NODE_ENV = 'test'
process.env.API_URL = 'http://localhost:3000/api'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURE TEST UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Set test timeout
vi.setConfig({ testTimeout: 10000 })

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POLYFILLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// TextEncoder/TextDecoder for Node environment
if (typeof global.TextEncoder === 'undefined') {
  const { TextEncoder, TextDecoder } = require('util')
  global.TextEncoder = TextEncoder
  global.TextDecoder = TextDecoder
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSOLE OVERRIDES (optional)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Suppress specific console warnings in tests
const originalWarn = console.warn
console.warn = (...args: any[]) => {
  // Filter out React act() warnings
  if (args[0]?.includes?.('act()')) return
  originalWarn(...args)
}
```

### globalSetup - One-Time Setup

```typescript
// test/globalSetup.ts
import { chromium } from 'playwright'
import type { GlobalSetupContext } from 'vitest/node'

export default async function setup({ provide }: GlobalSetupContext) {
  console.log('ðŸš€ Global setup starting...')
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // START TEST DATABASE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const testDb = await startTestDatabase()
  await testDb.migrate()
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // START TEST SERVER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const server = await startTestServer({
    port: 3001
  })
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LAUNCH BROWSER (for E2E tests)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const browser = await chromium.launch()
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PROVIDE VALUES TO TESTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  provide('testDbUrl', testDb.url)
  provide('testServerUrl', server.url)
  
  console.log('âœ… Global setup complete')
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RETURN TEARDOWN FUNCTION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  return async () => {
    console.log('ðŸ§¹ Global teardown starting...')
    
    await browser.close()
    await server.close()
    await testDb.close()
    
    console.log('âœ… Global teardown complete')
  }
}
```

```typescript
// Using provided values in tests
import { inject } from 'vitest'

describe('API Tests', () => {
  const testServerUrl = inject('testServerUrl')
  
  it('should connect to test server', async () => {
    const response = await fetch(`${testServerUrl}/health`)
    expect(response.status).toBe(200)
  })
})
```

### Multiple Setup Files

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    setupFiles: [
      './test/setup.dom.ts',      // DOM-related setup
      './test/setup.api.ts',      // API mocking setup
      './test/setup.auth.ts',     // Authentication setup
      './test/setup.i18n.ts'      // Internationalization setup
    ]
  }
})
```

```typescript
// test/setup.dom.ts
import { cleanup } from '@testing-library/react'
import { afterEach } from 'vitest'

afterEach(() => {
  cleanup()
  document.body.innerHTML = ''
})
```

```typescript
// test/setup.api.ts
import { beforeAll, afterEach, afterAll } from 'vitest'
import { server } from '../mocks/server'

beforeAll(() => server.listen({ onUnhandledRequest: 'error' }))
afterEach(() => server.resetHandlers())
afterAll(() => server.close())
```

```typescript
// test/setup.auth.ts
import { vi } from 'vitest'

// Mock auth module globally
vi.mock('@/lib/auth', () => ({
  getCurrentUser: vi.fn().mockResolvedValue(null),
  isAuthenticated: vi.fn().mockReturnValue(false)
}))
```

---

## 6.3 Environment Configuration

### Available Environments

| Environment | Use Case | DOM APIs | Node APIs | Performance |
|-------------|----------|----------|-----------|-------------|
| **node** | Backend, Utils | âŒ | âœ… | âš¡âš¡âš¡ Fast |
| **happy-dom** | Frontend (light) | âœ… | âœ… | âš¡âš¡ Fast |
| **jsdom** | Frontend (full) | âœ… | âœ… | âš¡ Slower |
| **edge-runtime** | Edge functions | Limited | Limited | âš¡âš¡ Fast |

### Node Environment

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    environment: 'node'
  }
})
```

**Best for:**
- Pure functions
- Business logic
- API routes
- Database operations
- File system operations

```typescript
// utils.test.ts
import { describe, it, expect } from 'vitest'
import fs from 'fs/promises'

describe('File operations', () => {
  it('should read file', async () => {
    const content = await fs.readFile('test.txt', 'utf-8')
    expect(content).toBe('test content')
  })
})
```

### Happy-DOM Environment

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    environment: 'happy-dom'
  }
})
```

**Best for:**
- React/Vue/Svelte components
- DOM manipulation
- Most frontend testing
- Fast execution

**Pros:**
- âš¡ Fast (2-3x faster than jsdom)
- âœ… Supports most DOM APIs
- âœ… Good compatibility

**Cons:**
- âŒ Some edge cases not supported
- âŒ Less complete than jsdom

### jsdom Environment

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    environment: 'jsdom',
    environmentOptions: {
      jsdom: {
        url: 'http://localhost:3000',
        pretendToBeVisual: true,
        resources: 'usable'
      }
    }
  }
})
```

**Best for:**
- Complex DOM interactions
- Browser-specific APIs
- Canvas/WebGL
- Maximum compatibility

**Pros:**
- âœ… Most complete DOM implementation
- âœ… Handles edge cases
- âœ… Well-tested

**Cons:**
- âš ï¸ Slower than happy-dom
- âš ï¸ Higher memory usage

### Per-File Environment Override

```typescript
// component.test.tsx
// @vitest-environment happy-dom

import { render } from '@testing-library/react'

describe('Component', () => {
  // This file uses happy-dom
})
```

```typescript
// utils.test.ts
// @vitest-environment node

import { processData } from './utils'

describe('Utils', () => {
  // This file uses node environment
})
```

### Custom Environment Options

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    environment: 'jsdom',
    environmentOptions: {
      jsdom: {
        // Set URL
        url: 'http://localhost:3000',
        
        // Referrer
        referrer: 'http://localhost:3000',
        
        // Content type
        contentType: 'text/html',
        
        // Include node locations in DOM
        includeNodeLocations: true,
        
        // Storage quota
        storageQuota: 10000000,
        
        // Pretend to be visual (affects some APIs)
        pretendToBeVisual: true,
        
        // Run scripts
        runScripts: 'dangerously',
        
        // Resource loading
        resources: 'usable',
        
        // Before parse
        beforeParse(window: any) {
          window.customProperty = 'value'
        }
      }
    }
  }
})
```

---

## 6.4 TypeScript Configuration

### Basic TypeScript Setup

```typescript
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "jsx": "react-jsx",
    "strict": true,
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    
    // Path aliases
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "@components/*": ["./src/components/*"],
      "@test/*": ["./test/*"]
    },
    
    // Type checking
    "types": ["vitest/globals", "node"]
  },
  "include": ["src", "test"],
  "exclude": ["node_modules", "dist"]
}
```

### Vitest Type Definitions

```typescript
// vitest.d.ts
import type { Assertion, AsymmetricMatchersContaining } from 'vitest'

interface CustomMatchers<R = unknown> {
  toBeWithinRange(floor: number, ceiling: number): R
  toBeValidEmail(): R
}

declare module 'vitest' {
  interface Assertion<T = any> extends CustomMatchers<T> {}
  interface AsymmetricMatchersContaining extends CustomMatchers {}
}
```

### Type-Safe Test Context

```typescript
// test/types.ts
export interface TestContext {
  db: Database
  user: User
  cleanup: () => Promise<void>
}

// test.ts
import type { TestContext } from './types'

describe('Tests', () => {
  beforeEach<TestContext>(async (context) => {
    context.db = await createDatabase()
    context.user = await createUser()
    context.cleanup = async () => {
      await context.db.close()
    }
  })
  
  it<TestContext>('works', async ({ db, user }) => {
    // Fully typed!
    const result = await db.users.find(user.id)
  })
})
```

### Type Testing with test-d

```typescript
// types.test-d.ts
import { expectTypeOf } from 'vitest'
import { User, createUser } from './user'

describe('Type tests', () => {
  it('should have correct user type', () => {
    const user = createUser({ name: 'John' })
    
    expectTypeOf(user).toMatchTypeOf<User>()
    expectTypeOf(user.name).toBeString()
    expectTypeOf(user.id).toBeNumber()
    expectTypeOf(user.email).toEqualTypeOf<string | undefined>()
  })
  
  it('should infer return types correctly', () => {
    async function fetchUser(id: number) {
      return { id, name: 'John' }
    }
    
    expectTypeOf(fetchUser).returns.resolves.toEqualTypeOf<{
      id: number
      name: string
    }>()
  })
})
```

### Strict Null Checks in Tests

```typescript
// tsconfig.json
{
  "compilerOptions": {
    "strictNullChecks": true
  }
}
```

```typescript
// test.ts
describe('Null safety', () => {
  it('should handle optional values', () => {
    function getUser(id: number): User | null {
      return null
    }
    
    const user = getUser(1)
    
    // âœ… TypeScript enforces null check
    // user.name // Error: Object is possibly 'null'
    
    // Correct approach
    expect(user).toBeNull()
    // or
    if (user) {
      expect(user.name).toBe('John')
    }
  })
})
```

---

## 6.5 Path Aliases & Module Resolution

### Setting Up Path Aliases

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import path from 'path'

export default defineConfig({
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
      '@components': path.resolve(__dirname, './src/components'),
      '@utils': path.resolve(__dirname, './src/utils'),
      '@hooks': path.resolve(__dirname, './src/hooks'),
      '@types': path.resolve(__dirname, './src/types'),
      '@test': path.resolve(__dirname, './test'),
      '@mocks': path.resolve(__dirname, './test/mocks')
    }
  }
})
```

```typescript
// tsconfig.json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "@components/*": ["./src/components/*"],
      "@utils/*": ["./src/utils/*"],
      "@hooks/*": ["./src/hooks/*"],
      "@types/*": ["./src/types/*"],
      "@test/*": ["./test/*"],
      "@mocks/*": ["./test/mocks/*"]
    }
  }
}
```

### Using Aliases in Tests

```typescript
// Before (relative imports)
import { Button } from '../../../components/Button'
import { formatDate } from '../../../utils/date'
import { useAuth } from '../../../hooks/useAuth'

// After (with aliases)
import { Button } from '@components/Button'
import { formatDate } from '@utils/date'
import { useAuth } from '@hooks/useAuth'
```

### Testing Alias Resolution

```typescript
// test.ts
import { describe, it, expect } from 'vitest'
import { Button } from '@components/Button'
import { formatDate } from '@utils/date'

describe('Import resolution', () => {
  it('should resolve component imports', () => {
    expect(Button).toBeDefined()
  })
  
  it('should resolve utility imports', () => {
    expect(formatDate).toBeDefined()
  })
})
```

### Monorepo Setup

```typescript
// vitest.workspace.ts
import { defineWorkspace } from 'vitest/config'

export default defineWorkspace([
  {
    test: {
      name: 'unit',
      include: ['packages/*/src/**/*.test.ts'],
      environment: 'node'
    }
  },
  {
    test: {
      name: 'integration',
      include: ['packages/*/src/**/*.integration.test.ts'],
      environment: 'happy-dom'
    }
  },
  {
    test: {
      name: 'e2e',
      include: ['e2e/**/*.test.ts'],
      environment: 'node'
    }
  }
])
```

---

## 6.6 Performance Optimization

### Measuring Test Performance

```bash
# Run with verbose reporter
vitest --reporter=verbose

# Profile tests
vitest --reporter=verbose --coverage
```

### Optimization Strategies

#### 1. Parallel Execution

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    // Enable parallel execution
    threads: true,
    
    // Control thread count
    maxThreads: 8,
    minThreads: 1,
    
    // Use pooling strategy
    pool: 'threads', // 'threads' | 'forks' | 'vmThreads'
    
    // Pool options
    poolOptions: {
      threads: {
        singleThread: false,
        isolate: true
      }
    }
  }
})
```

#### 2. Test Isolation Control

```typescript
export default defineConfig({
  test: {
    // Faster but less isolated
    isolate: false,
    
    // Use for faster unit tests
    // Be careful with global state!
  }
})
```

#### 3. Selective Test Running

```typescript
export default defineConfig({
  test: {
    // Only run changed tests
    changed: true,
    
    // File dependencies
    deps: {
      inline: [/virtual:/],
      optimizer: {
        web: {
          enabled: true
        }
      }
    }
  }
})
```

#### 4. Mock Optimization

```typescript
// âŒ SLOW - Mock entire module
vi.mock('lodash')

// âœ… FAST - Mock only what you need
vi.mock('lodash', () => ({
  debounce: vi.fn((fn) => fn),
  throttle: vi.fn((fn) => fn)
}))

// âœ… FASTER - Don't mock at all if possible
import { debounce } from 'lodash'
// Use real implementation for simple functions
```

#### 5. Setup Optimization

```typescript
// âŒ SLOW - Setup in beforeEach
describe('Tests', () => {
  let heavyObject: HeavyObject
  
  beforeEach(async () => {
    heavyObject = await createHeavyObject() // Slow!
  })
  
  // 10 tests = 10 expensive setups
})

// âœ… FAST - Setup in beforeAll
describe('Tests', () => {
  let heavyObject: HeavyObject
  
  beforeAll(async () => {
    heavyObject = await createHeavyObject() // Once!
  })
  
  afterEach(() => {
    // Reset only what changed
    heavyObject.reset()
  })
  
  // 10 tests = 1 expensive setup
})
```

#### 6. Coverage Optimization

```typescript
export default defineConfig({
  test: {
    coverage: {
      // Use v8 (faster than istanbul)
      provider: 'v8',
      
      // Skip full coverage if not needed
      skipFull: true,
      
      // Process in parallel
      processingConcurrency: 4,
      
      // Exclude large files
      exclude: [
        'src/generated/**',
        'src/vendor/**'
      ]
    }
  }
})
```

### Performance Monitoring

```typescript
// test/performance.ts
import { describe, it, bench } from 'vitest'

describe('Performance tests', () => {
  bench('string concatenation', () => {
    let str = ''
    for (let i = 0; i < 1000; i++) {
      str += 'test'
    }
  })
  
  bench('array join', () => {
    const arr = []
    for (let i = 0; i < 1000; i++) {
      arr.push('test')
    }
    arr.join('')
  })
})
```

### Optimization Checklist

```typescript
// âœ… DO
- Run tests in parallel (threads: true)
- Use happy-dom instead of jsdom when possible
- Mock only external dependencies
- Use beforeAll for expensive setup
- Cache test data when safe
- Use --changed flag during development

// âŒ DON'T
- Don't mock internal functions
- Don't create new instances in beforeEach if possible
- Don't run coverage in watch mode
- Don't use jsdom if you don't need full DOM
- Don't run E2E tests with unit tests
```

---

## Summary: Chapter 6

### Key Configuration Takeaways

1. **Configuration Structure**
   - Extends Vite configuration
   - Test-specific settings in `test` block
   - Can merge multiple configs

2. **Setup Files**
   - `setupFiles`: Runs before each test file
   - `globalSetup`: Runs once before all tests
   - Perfect for mocks, utilities, and global state

3. **Environments**
   - `node`: Backend, utilities
   - `happy-dom`: Frontend (fast)
   - `jsdom`: Frontend (complete)
   - Choose based on needs

4. **TypeScript**
   - Built-in support
   - Type-safe contexts
   - Custom matcher types
   - Type testing with test-d

5. **Path Aliases**
   - Consistent with Vite config
   - Cleaner imports
   - Better maintainability

6. **Performance**
   - Parallel execution
   - Selective mocking
   - Smart setup strategies
   - Coverage optimization

### Production Configuration Example

```typescript
export default defineConfig({
  test: {
    globals: true,
    environment: 'happy-dom',
    setupFiles: './test/setup.ts',
    threads: true,
    maxThreads: 8,
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 80,
        statements: 80
      }
    },
    reporters: process.env.CI ? ['json', 'default'] : ['default']
  }
})
```

**You've completed Chapters 4-6!** You now understand:
- Advanced testing patterns (snapshots, context, concurrent, custom matchers, parameterized tests)
- Testing different technologies (React, Vue, Svelte, APIs, DOM)
- Configuration and optimization for production-grade test suites

These skills prepare you for both technical interviews and building robust test suites in real-world applications!