# Chapter 1: Fundamentals & Setup - Complete Guide

## 1.1 What is Vitest?

### Definition and Core Concept

Vitest is a blazingly fast unit testing framework specifically designed for Vite-powered projects. It's built by the same team that created Vite and shares the same configuration format, making it seamless to integrate.

**Key Characteristics:**

1. **Vite-Powered**: Uses Vite's transformation pipeline, giving you the same instant hot module replacement (HMR) experience in tests
2. **Jest-Compatible API**: If you know Jest, you already know most of Vitest's API
3. **Native ESM Support**: First-class support for ES modules without transformation overhead
4. **TypeScript First**: Built-in TypeScript support without additional configuration

### Why Vitest Over Jest?

```typescript
// Traditional Jest setup requires:
// - babel/ts-jest for TypeScript
// - Complex ESM configuration
// - Separate config from your build tool

// Vitest works out of the box with your Vite config:
// ✓ TypeScript support: automatic
// ✓ ESM support: native
// ✓ Path aliases: inherited from Vite
// ✓ HMR in tests: instant feedback
```

### Architecture Overview

```
┌─────────────────────────────────────┐
│         Your Test Files             │
│   (*.test.ts, *.spec.ts)            │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│          Vitest Core                │
│  - Test Runner                      │
│  - Assertion Library                │
│  - Mocking System                   │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│         Vite Transform              │
│  - TypeScript compilation           │
│  - Module resolution                │
│  - Plugin processing                │
└─────────────────────────────────────┘
```

### Performance Comparison

| Feature | Jest | Vitest |
|---------|------|--------|
| Cold Start | ~2-5s | ~500ms |
| Watch Mode HMR | Full restart | Instant |
| ESM Support | Via transform | Native |
| TypeScript | Requires ts-jest | Built-in |

---

## 1.2 Installation & Configuration

### Basic Installation

```bash
# Using npm
npm install -D vitest

# Using yarn
yarn add -D vitest

# Using pnpm
pnpm add -D vitest
```

### Project Structure

```
my-project/
├── src/
│   ├── utils/
│   │   ├── math.ts
│   │   └── math.test.ts          # Collocated test
│   └── components/
│       └── Button.tsx
├── test/
│   ├── setup.ts                  # Global test setup
│   └── helpers/
│       └── testUtils.ts
├── vitest.config.ts              # Vitest configuration
├── vite.config.ts                # Vite configuration
└── package.json
```

### Configuration File Setup

**Option 1: Separate Config (Recommended for complex projects)**

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  test: {
    // Test configuration options go here
    globals: true,
    environment: 'happy-dom',
    setupFiles: './test/setup.ts',
  },
})
```

**Option 2: Shared Config (Simple projects)**

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  // Regular Vite config
  resolve: {
    alias: {
      '@': '/src',
    },
  },
  // Add test configuration
  test: {
    globals: true,
    environment: 'happy-dom',
  },
})
```

### Essential Configuration Options Explained

```typescript
// vitest.config.ts - Comprehensive example
import { defineConfig } from 'vitest/config'
import path from 'path'

export default defineConfig({
  test: {
    // === GLOBALS ===
    // When true, no need to import describe, it, expect
    globals: true,
    
    // === ENVIRONMENT ===
    // Choose test environment based on your needs:
    // - 'node': No DOM APIs (for backend/utilities)
    // - 'happy-dom': Lightweight DOM (faster, good for most cases)
    // - 'jsdom': Full DOM implementation (more accurate, slower)
    environment: 'happy-dom',
    
    // === FILE PATTERNS ===
    // Where to find test files
    include: ['**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}'],
    exclude: ['node_modules', 'dist', '.idea', '.git', '.cache'],
    
    // === SETUP FILES ===
    // Runs before each test file
    setupFiles: ['./test/setup.ts'],
    
    // === COVERAGE ===
    coverage: {
      provider: 'v8', // or 'istanbul'
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'test/',
        '**/*.d.ts',
        '**/*.config.*',
        '**/mockData.ts',
      ],
    },
    
    // === THREADING ===
    // Run tests in parallel threads
    threads: true,
    
    // === WATCH MODE ===
    watch: false, // Default is true in dev, false in CI
  },
  
  // Inherit Vite config options
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
      '@test': path.resolve(__dirname, './test'),
    },
  },
})
```

### Package.json Scripts

```json
{
  "scripts": {
    "test": "vitest",
    "test:run": "vitest run",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "test:watch": "vitest --watch"
  },
  "devDependencies": {
    "vitest": "^1.0.0",
    "@vitest/ui": "^1.0.0",
    "@vitest/coverage-v8": "^1.0.0"
  }
}
```

### Setting Up Global Test Utilities

```typescript
// test/setup.ts
import { expect, afterEach } from 'vitest'
import { cleanup } from '@testing-library/react'
import * as matchers from '@testing-library/jest-dom/matchers'

// Extend Vitest's expect with Testing Library matchers
expect.extend(matchers)

// Cleanup after each test
afterEach(() => {
  cleanup()
})

// Mock global objects if needed
global.fetch = vi.fn()

// Set up test environment
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
})
```

---

## 1.3 Basic Test Structure

### Anatomy of a Test File

```typescript
// src/utils/math.test.ts

// 1. IMPORTS
import { describe, it, expect, beforeEach, afterEach } from 'vitest'
import { add, subtract, Calculator } from './math'

// 2. TEST SUITE (describe block)
describe('Math Utilities', () => {
  
  // 3. INDIVIDUAL TEST (it/test block)
  it('should add two numbers correctly', () => {
    // 4. ARRANGE - Set up test data
    const a = 5
    const b = 3
    
    // 5. ACT - Execute the function
    const result = add(a, b)
    
    // 6. ASSERT - Verify the result
    expect(result).toBe(8)
  })
  
  // Alternative: test() is alias for it()
  test('should subtract two numbers correctly', () => {
    expect(subtract(10, 4)).toBe(6)
  })
})
```

### Core Testing Functions

#### 1. `describe()` - Organizing Test Suites

```typescript
// Grouping related tests
describe('User Authentication', () => {
  describe('login', () => {
    it('should authenticate valid credentials', () => {
      // test implementation
    })
    
    it('should reject invalid credentials', () => {
      // test implementation
    })
  })
  
  describe('logout', () => {
    it('should clear session', () => {
      // test implementation
    })
  })
})

// Nested describes create hierarchy
describe('Calculator', () => {
  describe('Basic Operations', () => {
    describe('Addition', () => {
      it('should add positive numbers', () => {})
      it('should add negative numbers', () => {})
    })
  })
})
```

#### 2. `it()` / `test()` - Individual Test Cases

```typescript
// Both are identical - use whichever reads better
it('should calculate total price', () => {
  // Reads naturally: "it should calculate total price"
})

test('total price calculation', () => {
  // Reads naturally: "test total price calculation"
})

// Convention: Use 'it' for behavior, 'test' for functionality
describe('Shopping Cart', () => {
  it('should add items to cart', () => {}) // behavior-focused
  test('cart total calculation', () => {})  // function-focused
})
```

#### 3. `expect()` - Making Assertions

```typescript
// expect() returns an expectation object with matchers
const value = 42

// Basic assertions
expect(value).toBe(42)              // Strict equality (Object.is)
expect(value).toEqual(42)           // Deep equality
expect(value).not.toBe(43)          // Negation

// Chaining expectations
expect(value)
  .toBe(42)
  .and.toBeLessThan(50)
  .and.toBeGreaterThan(40)
```

### Real-World Example: Testing a Function

```typescript
// src/utils/string.ts
export function capitalize(str: string): string {
  if (!str) return ''
  return str.charAt(0).toUpperCase() + str.slice(1)
}

export function slugify(str: string): string {
  return str
    .toLowerCase()
    .trim()
    .replace(/[^\w\s-]/g, '')
    .replace(/[\s_-]+/g, '-')
    .replace(/^-+|-+$/g, '')
}
```

```typescript
// src/utils/string.test.ts
import { describe, it, expect } from 'vitest'
import { capitalize, slugify } from './string'

describe('String Utilities', () => {
  describe('capitalize', () => {
    it('should capitalize first letter of a word', () => {
      expect(capitalize('hello')).toBe('Hello')
    })
    
    it('should handle already capitalized words', () => {
      expect(capitalize('Hello')).toBe('Hello')
    })
    
    it('should return empty string for empty input', () => {
      expect(capitalize('')).toBe('')
    })
    
    it('should handle single character', () => {
      expect(capitalize('a')).toBe('A')
    })
  })
  
  describe('slugify', () => {
    it('should convert string to lowercase slug', () => {
      expect(slugify('Hello World')).toBe('hello-world')
    })
    
    it('should remove special characters', () => {
      expect(slugify('Hello @World!')).toBe('hello-world')
    })
    
    it('should handle multiple spaces', () => {
      expect(slugify('Hello    World')).toBe('hello-world')
    })
    
    it('should trim leading and trailing hyphens', () => {
      expect(slugify('  Hello World  ')).toBe('hello-world')
    })
  })
})
```

### Test File Naming Conventions

```typescript
// ✅ RECOMMENDED
src/utils/math.ts       → src/utils/math.test.ts
src/utils/math.ts       → src/utils/math.spec.ts
src/components/Button.tsx → src/components/Button.test.tsx

// ✅ ALTERNATIVE (separate test directory)
src/utils/math.ts       → tests/utils/math.test.ts
src/components/Button.tsx → tests/components/Button.test.tsx

// ❌ AVOID
src/utils/math.ts       → src/utils/mathTest.ts
src/utils/math.ts       → test-math.ts
```

---

## 1.4 Running Tests

### Watch Mode (Default)

```bash
# Start watch mode - monitors file changes
vitest

# What happens:
# 1. Runs all tests initially
# 2. Watches for file changes
# 3. Re-runs only affected tests
# 4. Shows interactive menu
```

**Watch Mode Features:**
- **Smart Re-run**: Only tests affected by changes
- **Interactive Menu**: Filter, run specific tests
- **Instant Feedback**: See results immediately

```
 ✓ src/utils/math.test.ts (4) 12ms
 ✓ src/components/Button.test.tsx (2) 45ms

 Test Files  2 passed (2)
      Tests  6 passed (6)
   Start at  10:30:15
   Duration  234ms

 PASS  Waiting for file changes...
       press h to show help, press q to quit

 Watch Usage
 › Press a to rerun all tests
 › Press f to rerun only failed tests
 › Press u to update snapshots
 › Press p to filter by a filename
 › Press t to filter by a test name pattern
 › Press q to quit
```

### Run Once Mode (CI/CD)

```bash
# Run all tests once and exit
vitest run

# Common CI usage
vitest run --coverage --reporter=json --reporter=default
```

```typescript
// package.json
{
  "scripts": {
    "test:ci": "vitest run --coverage --reporter=json --reporter=default"
  }
}
```

### UI Mode - Visual Test Interface

```bash
# Install UI package
npm install -D @vitest/ui

# Start UI mode
vitest --ui
```

**UI Mode Features:**
- Visual test tree
- Real-time test results
- Code coverage visualization
- Module graph explorer
- Test filtering and search
- Detailed error messages with stack traces

### Coverage Mode

```bash
# Install coverage provider
npm install -D @vitest/coverage-v8

# Run with coverage
vitest --coverage

# Output formats
vitest --coverage --reporter=html    # HTML report in ./coverage
vitest --coverage --reporter=text    # Terminal output
vitest --coverage --reporter=json    # JSON output
```

**Coverage Report Example:**
```
----------------------|---------|----------|---------|---------|
File                  | % Stmts | % Branch | % Funcs | % Lines |
----------------------|---------|----------|---------|---------|
All files             |   85.71 |    83.33 |     100 |   85.71 |
 src/utils            |   85.71 |    83.33 |     100 |   85.71 |
  math.ts             |     100 |      100 |     100 |     100 |
  string.ts           |   71.42 |    66.66 |     100 |   71.42 |
----------------------|---------|----------|---------|---------|
```

### Filtering Tests

```bash
# Run specific test file
vitest math.test.ts

# Run tests matching pattern
vitest -t "should add"              # Test name contains "should add"
vitest src/utils/                   # All tests in directory

# Run only changed tests (git integration)
vitest --changed

# Run tests related to specific files
vitest --related src/utils/math.ts
```

### Advanced Running Options

```bash
# Debugging
vitest --inspect-brk                # Debug with Chrome DevTools
vitest --no-threads                 # Disable threading (easier debugging)

# Reporters
vitest --reporter=verbose           # Detailed output
vitest --reporter=dot               # Minimal output
vitest --reporter=json              # JSON format

# Performance
vitest --threads                    # Use worker threads (default)
vitest --no-threads                 # Single thread
vitest --max-threads=4              # Limit threads

# Miscellaneous
vitest --silent                     # Suppress console.log
vitest --bail=1                     # Stop after 1 failure
vitest --retry=3                    # Retry failed tests 3 times
```

### Configuration in Code

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    // Watch mode behavior
    watch: true,
    
    // File watching options
    watchExclude: ['**/node_modules/**', '**/dist/**'],
    
    // Execution options
    threads: true,
    maxThreads: 4,
    minThreads: 1,
    
    // Reporters
    reporters: ['default', 'json'],
    outputFile: {
      json: './test-results.json'
    },
    
    // Behavior
    bail: 1,        // Stop after first failure
    retry: 3,       // Retry failed tests
    testTimeout: 5000, // 5 second timeout per test
  }
})
```

---

## Best Practices for Chapter 1

### ✅ DO

1. **Keep tests close to source code**
   ```
   src/
     components/
       Button.tsx
       Button.test.tsx  ← Test right next to component
   ```

2. **Use descriptive test names**
   ```typescript
   // ✅ Good
   it('should return error when email is invalid', () => {})
   
   // ❌ Bad
   it('test1', () => {})
   it('works', () => {})
   ```

3. **Start watch mode during development**
   ```bash
   npm test  # Keep running while you code
   ```

4. **Configure globals for cleaner test files**
   ```typescript
   // vitest.config.ts
   test: { globals: true }
   
   // No need to import in every file
   describe('test', () => {
     it('works', () => {
       expect(true).toBe(true)
     })
   })
   ```

### ❌ DON'T

1. **Don't commit test.only()**
   ```typescript
   // ❌ Dangerous - will skip other tests in CI
   it.only('my test', () => {})
   ```

2. **Don't ignore test failures**
   ```typescript
   // ❌ Bad practice
   it.skip('broken test', () => {}) // Fix it instead!
   ```

3. **Don't use try-catch to hide errors**
   ```typescript
   // ❌ Tests should fail loudly
   it('test', () => {
     try {
       riskyOperation()
     } catch(e) {
       // Silently swallowing errors
     }
   })
   ```

---

## Quick Reference Card

```typescript
// Essential imports
import { describe, it, expect, beforeEach, afterEach } from 'vitest'

// Basic structure
describe('Feature', () => {
  beforeEach(() => {
    // Setup before each test
  })
  
  it('should work', () => {
    expect(value).toBe(expected)
  })
  
  afterEach(() => {
    // Cleanup after each test
  })
})

// Running tests
vitest              // Watch mode
vitest run          // Run once
vitest --ui         // UI mode
vitest --coverage   // With coverage
```

---

## Summary

In Chapter 1, you learned:

1. **What Vitest is**: A fast, Vite-powered testing framework with Jest-compatible API
2. **Installation**: How to set up Vitest in your project with proper configuration
3. **Basic Structure**: How to write tests using `describe()`, `it()`, and `expect()`
4. **Running Tests**: Different modes (watch, run, UI, coverage) and when to use each

**Next Chapter Preview**: In Chapter 2, we'll dive deep into assertions, matchers, async testing, and lifecycle hooks to write more sophisticated tests.