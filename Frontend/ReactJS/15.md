# Chapter 15: Server-Side Rendering - In-Depth Explanation

## What is Server-Side Rendering (SSR)?

**SSR** means rendering React components on the server and sending HTML to the client, rather than sending JavaScript that renders in the browser.

**Traditional React (Client-Side Rendering):**
```
1. Browser requests page
2. Server sends HTML with <div id="root"></div>
3. Browser downloads JavaScript bundle
4. React renders in browser
5. User sees content

Total time: 2-5 seconds
SEO: Poor (crawlers see empty div)
```

**With SSR:**
```
1. Browser requests page
2. Server renders React to HTML
3. Server sends fully rendered HTML
4. User sees content immediately
5. JavaScript hydrates page

Total time: 0.5-1 second
SEO: Excellent (crawlers see full HTML)
```

**Why SSR?**
- ✅ Better SEO (search engines see content)
- ✅ Faster initial page load
- ✅ Better performance on slow devices
- ✅ Social media previews work
- ✅ Works without JavaScript

---

## 15.1 Next.js Fundamentals

### What is Next.js?

**Next.js** is a React framework that provides:
- Server-side rendering
- Static site generation
- File-based routing
- API routes
- Image optimization
- Built-in CSS support
- TypeScript support

**Installation:**
```bash
npx create-next-app@latest my-app
cd my-app
npm run dev
```

### Pages Router (Traditional)

**File Structure:**
```
pages/
├── index.js           → Route: /
├── about.js           → Route: /about
├── blog/
│   ├── index.js       → Route: /blog
│   └── [slug].js      → Route: /blog/post-title
├── users/
│   └── [id].js        → Route: /users/123
└── api/
    └── hello.js       → API Route: /api/hello
```

**Basic Page:**
```javascript
// pages/index.js
export default function Home() {
  return (
    <div>
      <h1>Welcome to Next.js!</h1>
      <p>This page is server-rendered</p>
    </div>
  );
}
```

**Navigation:**
```javascript
import Link from 'next/link';

export default function Navigation() {
  return (
    <nav>
      <Link href="/">Home</Link>
      <Link href="/about">About</Link>
      <Link href="/blog">Blog</Link>
      <Link href="/users/123">User 123</Link>
    </nav>
  );
}
```

### App Router (Next.js 13+, Modern)

**File Structure:**
```
app/
├── layout.js          → Root layout
├── page.js            → Route: /
├── loading.js         → Loading UI
├── error.js           → Error UI
├── about/
│   └── page.js        → Route: /about
├── blog/
│   ├── page.js        → Route: /blog
│   └── [slug]/
│       └── page.js    → Route: /blog/post-title
└── api/
    └── hello/
        └── route.js   → API Route: /api/hello
```

**Basic Page (App Router):**
```javascript
// app/page.js
export default function HomePage() {
  return (
    <div>
      <h1>Welcome to Next.js 13+</h1>
      <p>Using App Router</p>
    </div>
  );
}
```

**Root Layout:**
```javascript
// app/layout.js
export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>
        <header>
          <nav>{/* Navigation */}</nav>
        </header>
        <main>{children}</main>
        <footer>{/* Footer */}</footer>
      </body>
    </html>
  );
}
```

---

## 15.2 Data Fetching in Next.js

### Pages Router Data Fetching

#### getServerSideProps (SSR)

**Runs on every request** - Always fresh data

```javascript
// pages/users/[id].js
export async function getServerSideProps(context) {
  const { params, req, res, query } = context;
  
  // params.id from URL
  const userId = params.id;
  
  try {
    const response = await fetch(`https://api.example.com/users/${userId}`);
    const user = await response.json();
    
    return {
      props: {
        user
      }
    };
  } catch (error) {
    return {
      notFound: true  // Shows 404 page
    };
  }
}

export default function UserPage({ user }) {
  return (
    <div>
      <h1>{user.name}</h1>
      <p>{user.email}</p>
    </div>
  );
}

// URL: /users/123
// Server fetches user 123 on EVERY request
```

**When to Use:**
- User-specific data
- Data changes frequently
- Need request headers (cookies, auth)
- Real-time data

**Advanced getServerSideProps:**
```javascript
export async function getServerSideProps(context) {
  const { params, req, res, query, resolvedUrl } = context;
  
  // Access cookies
  const token = req.cookies.token;
  
  // Access query parameters
  const page = query.page || 1;
  const sort = query.sort || 'date';
  
  // Set response headers
  res.setHeader('Cache-Control', 'public, s-maxage=10, stale-while-revalidate=59');
  
  // Fetch data with authentication
  const response = await fetch(`https://api.example.com/posts?page=${page}&sort=${sort}`, {
    headers: {
      Authorization: `Bearer ${token}`
    }
  });
  
  if (!response.ok) {
    return {
      redirect: {
        destination: '/login',
        permanent: false
      }
    };
  }
  
  const posts = await response.json();
  
  return {
    props: {
      posts,
      page: parseInt(page),
      sort
    }
  };
}
```

#### getStaticProps (SSG)

**Runs at build time** - Static HTML generated

```javascript
// pages/blog/index.js
export async function getStaticProps() {
  const response = await fetch('https://api.example.com/posts');
  const posts = await response.json();
  
  return {
    props: {
      posts
    },
    revalidate: 60  // ISR: Regenerate every 60 seconds
  };
}

export default function BlogPage({ posts }) {
  return (
    <div>
      <h1>Blog Posts</h1>
      <ul>
        {posts.map(post => (
          <li key={post.id}>
            <Link href={`/blog/${post.slug}`}>{post.title}</Link>
          </li>
        ))}
      </ul>
    </div>
  );
}

// Runs at build time (npm run build)
// Generated static HTML
```

**When to Use:**
- Marketing pages
- Blog posts
- Documentation
- Product pages
- Data doesn't change often

#### getStaticPaths (For Dynamic Routes)

```javascript
// pages/blog/[slug].js

// 1. Define which paths to pre-render
export async function getStaticPaths() {
  const response = await fetch('https://api.example.com/posts');
  const posts = await response.json();
  
  // Generate paths for each post
  const paths = posts.map(post => ({
    params: { slug: post.slug }
  }));
  
  return {
    paths,
    fallback: 'blocking'  // or false, true
  };
}

// 2. Fetch data for each path
export async function getStaticProps({ params }) {
  const response = await fetch(`https://api.example.com/posts/${params.slug}`);
  const post = await response.json();
  
  if (!post) {
    return {
      notFound: true
    };
  }
  
  return {
    props: {
      post
    },
    revalidate: 60  // ISR
  };
}

export default function PostPage({ post }) {
  return (
    <article>
      <h1>{post.title}</h1>
      <div>{post.content}</div>
    </article>
  );
}
```

**Fallback Options:**

```javascript
// fallback: false
// Only pre-rendered paths work, others 404
paths: ['/blog/post-1', '/blog/post-2']
// /blog/post-1 ✅ works
// /blog/post-3 ❌ 404

// fallback: true
// Non-pre-rendered paths show fallback, then fetch data
paths: ['/blog/post-1']
// /blog/post-1 ✅ instant
// /blog/post-2 ⚠️ shows fallback UI, then loads

// fallback: 'blocking'
// Non-pre-rendered paths wait for SSR
paths: ['/blog/post-1']
// /blog/post-1 ✅ instant
// /blog/post-2 ⏳ waits for server render, then shows
```

**Using Fallback:**
```javascript
import { useRouter } from 'next/router';

export default function PostPage({ post }) {
  const router = useRouter();
  
  // Show loading state for fallback: true
  if (router.isFallback) {
    return <div>Loading...</div>;
  }
  
  return (
    <article>
      <h1>{post.title}</h1>
    </article>
  );
}
```

---

## 15.3 SSR vs SSG vs ISR

### Server-Side Rendering (SSR)

**How it works:**
```
User requests /product/123
  ↓
Server runs getServerSideProps
  ↓
Server fetches data from database
  ↓
Server renders React to HTML
  ↓
Sends HTML to browser
  ↓
User sees page immediately
```

**Characteristics:**
- ✅ Always fresh data
- ✅ Dynamic per request
- ❌ Slower (renders per request)
- ❌ More server load

**Use Cases:**
- User dashboards
- Personalized content
- Real-time data
- Authentication-based pages

### Static Site Generation (SSG)

**How it works:**
```
Build time (npm run build)
  ↓
getStaticProps runs once
  ↓
Fetches data
  ↓
Generates static HTML files
  ↓
Deployed to CDN

User requests page
  ↓
CDN serves pre-built HTML
  ↓
Instant load!
```

**Characteristics:**
- ✅ Fastest possible load time
- ✅ CDN cacheable
- ✅ No server needed
- ❌ Data can be stale
- ❌ Rebuild needed for updates

**Use Cases:**
- Marketing pages
- Blog posts
- Documentation
- About/Contact pages

### Incremental Static Regeneration (ISR)

**Best of both worlds** - Static with background updates

```javascript
export async function getStaticProps() {
  const posts = await fetchPosts();
  
  return {
    props: { posts },
    revalidate: 60  // Regenerate every 60 seconds
  };
}
```

**How ISR works:**
```
User 1 requests page at t=0
  ↓
Serves static HTML (instant)

User 2 requests page at t=70 (after 60s revalidate)
  ↓
Serves stale HTML (instant)
  ↓
Triggers regeneration in background
  ↓
Next request gets fresh HTML
```

**Characteristics:**
- ✅ Fast like SSG
- ✅ Fresh like SSR
- ✅ Low server load
- ⚠️ First user after revalidate gets stale data

**Use Cases:**
- E-commerce product pages
- News articles
- Blog posts
- Most dynamic content

### Comparison Table

| Feature | SSR | SSG | ISR |
|---------|-----|-----|-----|
| **Build Time** | Fast | Slow (if many pages) | Slow initially |
| **Request Time** | Slow | Instant | Instant |
| **Data Freshness** | Always fresh | Stale until rebuild | Fresh (with delay) |
| **Server Load** | High | None | Low |
| **CDN Cacheable** | ❌ | ✅ | ✅ |
| **Best For** | User data | Static content | Dynamic content |
| **Cost** | High | Low | Low |

**Visual Comparison:**
```
SSR (getServerSideProps):
Request → Server Render → Response (500ms)
Request → Server Render → Response (500ms)
Request → Server Render → Response (500ms)

SSG (getStaticProps):
Build → Generate HTML → Deploy
Request → Serve HTML → Response (10ms)
Request → Serve HTML → Response (10ms)
Request → Serve HTML → Response (10ms)

ISR (getStaticProps + revalidate):
Build → Generate HTML → Deploy
Request → Serve HTML → Response (10ms)
Request (after 60s) → Serve HTML + Trigger Regen → Response (10ms)
Next Request → Serve Fresh HTML → Response (10ms)
```

---

## 15.4 App Router (Next.js 13+)

### Server Components vs Client Components

**Server Components (Default):**
```javascript
// app/page.js - Server Component by default
async function HomePage() {
  // Can fetch data directly
  const posts = await fetch('https://api.example.com/posts').then(r => r.json());
  
  return (
    <div>
      <h1>Blog Posts</h1>
      <ul>
        {posts.map(post => (
          <li key={post.id}>{post.title}</li>
        ))}
      </ul>
    </div>
  );
}

export default HomePage;

// Benefits:
// - Smaller bundle (doesn't send to client)
// - Direct database access
// - Automatic code splitting
// - No useEffect needed for data fetching
```

**Client Components:**
```javascript
'use client';  // Directive to mark as client component

import { useState } from 'react';

export default function Counter() {
  const [count, setCount] = useState(0);
  
  return (
    <div>
      <p>Count: {count}</p>
      <button onClick={() => setCount(count + 1)}>Increment</button>
    </div>
  );
}

// Use when you need:
// - useState, useEffect, other hooks
// - Event handlers (onClick, onChange)
// - Browser APIs (window, localStorage)
// - Interactive components
```

**When to Use Which:**

| Feature | Server Component | Client Component |
|---------|-----------------|------------------|
| Fetch data | ✅ | ❌ (use SWR/React Query) |
| Access backend | ✅ | ❌ |
| Event handlers | ❌ | ✅ |
| useState/hooks | ❌ | ✅ |
| Browser APIs | ❌ | ✅ |
| Bundle size | Small | Larger |

### Data Fetching in App Router

**Server Component (Direct Fetch):**
```javascript
// app/posts/page.js
async function PostsPage() {
  // Fetch directly in component
  const posts = await fetch('https://api.example.com/posts', {
    cache: 'force-cache'  // Static behavior
    // cache: 'no-store'  // SSR behavior
  }).then(r => r.json());
  
  return (
    <ul>
      {posts.map(post => (
        <li key={post.id}>{post.title}</li>
      ))}
    </ul>
  );
}

export default PostsPage;
```

**Revalidation:**
```javascript
// Revalidate every 60 seconds
async function PostsPage() {
  const posts = await fetch('https://api.example.com/posts', {
    next: { revalidate: 60 }  // ISR
  }).then(r => r.json());
  
  return <ul>{/* posts */}</ul>;
}

// Or set for entire route
export const revalidate = 60;
```

**Dynamic Routes:**
```javascript
// app/blog/[slug]/page.js
async function BlogPost({ params }) {
  const post = await fetch(`https://api.example.com/posts/${params.slug}`)
    .then(r => r.json());
  
  return (
    <article>
      <h1>{post.title}</h1>
      <div>{post.content}</div>
    </article>
  );
}

export default BlogPost;

// Generate static params (like getStaticPaths)
export async function generateStaticParams() {
  const posts = await fetch('https://api.example.com/posts').then(r => r.json());
  
  return posts.map(post => ({
    slug: post.slug
  }));
}
```

### Loading and Error States

**Loading UI:**
```javascript
// app/loading.js (Route segment loading)
export default function Loading() {
  return (
    <div>
      <div className="spinner" />
      <p>Loading...</p>
    </div>
  );
}

// Automatically shown while page loads
```

**Error UI:**
```javascript
// app/error.js (Route segment error boundary)
'use client';  // Must be client component

export default function Error({ error, reset }) {
  return (
    <div>
      <h2>Something went wrong!</h2>
      <p>{error.message}</p>
      <button onClick={() => reset()}>Try again</button>
    </div>
  );
}
```

---

## 15.5 Routing in Next.js

### Dynamic Routes

**Pages Router:**
```javascript
// pages/posts/[id].js
import { useRouter } from 'next/router';

export default function Post() {
  const router = useRouter();
  const { id } = router.query;
  
  return <div>Post ID: {id}</div>;
}

// URLs:
// /posts/1 → id = "1"
// /posts/abc → id = "abc"
```

**App Router:**
```javascript
// app/posts/[id]/page.js
export default function Post({ params }) {
  return <div>Post ID: {params.id}</div>;
}

// Same URL behavior
```

### Catch-All Routes

```javascript
// pages/docs/[...slug].js
export default function Docs() {
  const router = useRouter();
  const { slug } = router.query;
  
  // /docs/a → slug = ["a"]
  // /docs/a/b → slug = ["a", "b"]
  // /docs/a/b/c → slug = ["a", "b", "c"]
  
  return <div>Path: {slug.join('/')}</div>;
}

// Optional catch-all: [[...slug]].js
// /docs → slug = undefined
// /docs/a → slug = ["a"]
```

### Programmatic Navigation

```javascript
import { useRouter } from 'next/router';

function Component() {
  const router = useRouter();
  
  const handleClick = () => {
    // Navigate to route
    router.push('/about');
    
    // With query params
    router.push({
      pathname: '/search',
      query: { q: 'react' }
    });
    // URL: /search?q=react
    
    // Replace (don't add to history)
    router.replace('/login');
    
    // Go back
    router.back();
    
    // Go forward
    router.forward();
    
    // Reload current route
    router.reload();
  };
  
  return <button onClick={handleClick}>Navigate</button>;
}
```

---

## 15.6 API Routes

### Creating API Endpoints

**Pages Router:**
```javascript
// pages/api/users.js
export default function handler(req, res) {
  if (req.method === 'GET') {
    // Handle GET
    const users = [
      { id: 1, name: 'John' },
      { id: 2, name: 'Jane' }
    ];
    
    res.status(200).json(users);
  } else if (req.method === 'POST') {
    // Handle POST
    const newUser = req.body;
    
    // Save to database
    // ...
    
    res.status(201).json({ id: 3, ...newUser });
  } else {
    res.status(405).json({ message: 'Method not allowed' });
  }
}

// Access: /api/users
```

**Dynamic API Routes:**
```javascript
// pages/api/users/[id].js
export default function handler(req, res) {
  const { id } = req.query;
  
  if (req.method === 'GET') {
    // Get user by ID
    const user = getUserById(id);
    res.status(200).json(user);
  } else if (req.method === 'DELETE') {
    // Delete user
    deleteUser(id);
    res.status(204).end();
  }
}

// /api/users/123
```

**App Router:**
```javascript
// app/api/users/route.js
import { NextResponse } from 'next/server';

export async function GET(request) {
  const users = [
    { id: 1, name: 'John' },
    { id: 2, name: 'Jane' }
  ];
  
  return NextResponse.json(users);
}

export async function POST(request) {
  const body = await request.json();
  
  // Save to database
  const newUser = { id: 3, ...body };
  
  return NextResponse.json(newUser, { status: 201 });
}

// Dynamic routes: app/api/users/[id]/route.js
export async function GET(request, { params }) {
  const user = getUserById(params.id);
  return NextResponse.json(user);
}
```

---

## 15.7 Image Optimization

### next/image Component

```javascript
import Image from 'next/image';

export default function ProfilePage() {
  return (
    <div>
      {/* Optimized image */}
      <Image
        src="/profile.jpg"
        alt="Profile picture"
        width={500}
        height={500}
        priority  // Load immediately (above fold)
      />
      
      {/* Remote image */}
      <Image
        src="https://example.com/image.jpg"
        alt="Remote image"
        width={800}
        height={600}
        quality={75}  // 1-100 (default: 75)
      />
      
      {/* Responsive image */}
      <Image
        src="/banner.jpg"
        alt="Banner"
        fill  // Fill parent container
        style={{ objectFit: 'cover' }}
      />
    </div>
  );
}

// Benefits:
// - Automatic lazy loading
// - Responsive sizes
// - WebP format
// - Blur placeholder
// - No CLS (Cumulative Layout Shift)
```

**Image Domains (next.config.js):**
```javascript
module.exports = {
  images: {
    domains: ['example.com', 'cdn.example.com'],
    // Or use remotePatterns (Next.js 13+)
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**.example.com'
      }
    ]
  }
};
```

---

## 15.8 Metadata and SEO

### Pages Router (Head)

```javascript
import Head from 'next/head';

export default function AboutPage() {
  return (
    <>
      <Head>
        <title>About Us | My Site</title>
        <meta name="description" content="Learn about our company" />
        <meta property="og:title" content="About Us" />
        <meta property="og:description" content="Learn about our company" />
        <meta property="og:image" content="/og-image.jpg" />
        <link rel="canonical" href="https://example.com/about" />
      </Head>
      
      <div>
        <h1>About Us</h1>
        <p>Content here...</p>
      </div>
    </>
  );
}
```

### App Router (Metadata)

```javascript
// app/about/page.js
export const metadata = {
  title: 'About Us | My Site',
  description: 'Learn about our company',
  openGraph: {
    title: 'About Us',
    description: 'Learn about our company',
    images: ['/og-image.jpg']
  },
  twitter: {
    card: 'summary_large_image',
    title: 'About Us',
    description: 'Learn about our company'
  }
};

export default function AboutPage() {
  return (
    <div>
      <h1>About Us</h1>
    </div>
  );
}

// Dynamic metadata
export async function generateMetadata({ params }) {
  const post = await fetchPost(params.slug);
  
  return {
    title: post.title,
    description: post.excerpt,
    openGraph: {
      images: [post.image]
    }
  };
}
```

---

## 15.9 Middleware

```javascript
// middleware.js
import { NextResponse } from 'next/server';

export function middleware(request) {
  const token = request.cookies.get('token');
  
  // Redirect if not authenticated
  if (!token && request.nextUrl.pathname.startsWith('/dashboard')) {
    return NextResponse.redirect(new URL('/login', request.url));
  }
  
  // Add custom header
  const response = NextResponse.next();
  response.headers.set('x-custom-header', 'value');
  
  return response;
}

// Configure which routes middleware runs on
export const config = {
  matcher: ['/dashboard/:path*', '/admin/:path*']
};
```

---

## 15.10 Environment Variables

```bash
# .env.local
DATABASE_URL=postgresql://localhost:5432/mydb
API_KEY=secret123
NEXT_PUBLIC_API_URL=https://api.example.com

# NEXT_PUBLIC_ prefix = available in browser
# No prefix = server-side only
```

```javascript
// Server-side only
const dbUrl = process.env.DATABASE_URL;
const apiKey = process.env.API_KEY;

// Available in browser
const apiUrl = process.env.NEXT_PUBLIC_API_URL;
```

---

## Summary of Chapter 15

**Key Concepts:**

1. **SSR** - Server-Side Rendering (getServerSideProps)
2. **SSG** - Static Site Generation (getStaticProps)
3. **ISR** - Incremental Static Regeneration (revalidate)
4. **Pages Router** - Traditional Next.js routing
5. **App Router** - Modern Next.js 13+ routing
6. **Server Components** - Render on server, smaller bundle
7. **Client Components** - Interactive components ('use client')
8. **API Routes** - Backend API in same project
9. **Image Optimization** - next/image component
10. **Metadata** - SEO and social sharing

**Data Fetching Methods (Pages Router):**

```javascript
// SSR - Dynamic, per request
export async function getServerSideProps(context) {
  return { props: { data } };
}

// SSG - Static, at build time
export async function getStaticProps() {
  return { props: { data } };
}

// SSG with dynamic routes
export async function getStaticPaths() {
  return { paths: [...], fallback: 'blocking' };
}
```

**When to Use What:**

| Use Case | Method |
|----------|--------|
| User dashboard | SSR (getServerSideProps) |
| Blog post | SSG (getStaticProps) |
| Product page | ISR (getStaticProps + revalidate) |
| Marketing page | SSG (getStaticProps) |
| Real-time data | SSR or Client-side fetch |
| News article | ISR |

**Best Practices:**

```javascript
// ✅ Use ISR for most dynamic content
export async function getStaticProps() {
  return {
    props: { data },
    revalidate: 60  // Regenerate every 60 seconds
  };
}

// ✅ Use Server Components when possible
// Default in App Router - smaller bundle

// ✅ Use 'use client' only when needed
'use client';  // Only for interactive components

// ✅ Optimize images with next/image
<Image src="/photo.jpg" width={500} height={500} alt="Photo" />

// ✅ Set proper metadata for SEO
export const metadata = {
  title: 'Page Title',
  description: 'Page description'
};
```

**Pages Router vs App Router:**

| Feature | Pages Router | App Router |
|---------|-------------|------------|
| Routing | pages/ folder | app/ folder |
| Data Fetching | getServerSideProps, getStaticProps | async components, fetch |
| Server Components | ❌ | ✅ |
| Layouts | Manual | Built-in (layout.js) |
| Loading States | Manual | loading.js |
| Error Handling | Manual | error.js |
| Status | Stable | Stable (as of Next.js 14) |
| Use For | Existing projects | New projects |

**Interview Focus:**
- Explain SSR vs SSG vs ISR
- When to use each approach
- Next.js data fetching methods
- Server vs Client components
- Performance benefits of SSR