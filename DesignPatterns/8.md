# Chapter 8: Module Pattern

## 8.1 Classic Module Pattern (IIFE)

### What is the Module Pattern?

The Module Pattern uses **closures** to create private and public encapsulation. It's one of the most important patterns in JavaScript for organizing code and preventing global namespace pollution.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MODULE PATTERN                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    MODULE (IIFE)                    â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚             PRIVATE SCOPE                     â”‚  â”‚   â”‚
â”‚   â”‚  â”‚                                               â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Private variables                          â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Private functions                          â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Internal state                             â”‚  â”‚   â”‚
â”‚   â”‚  â”‚                                               â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                        â”‚                            â”‚   â”‚
â”‚   â”‚                        â–¼                            â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚             PUBLIC API (Returned)             â”‚  â”‚   â”‚
â”‚   â”‚  â”‚                                               â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Exposed methods                            â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Controlled access to private data          â”‚  â”‚   â”‚
â”‚   â”‚  â”‚                                               â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Basic IIFE Module

```javascript
// IIFE - Immediately Invoked Function Expression
const CounterModule = (function() {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PRIVATE - Only accessible inside this function
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let count = 0;
  const maxCount = 100;
  const minCount = 0;
  
  function validateCount(newCount) {
    return newCount >= minCount && newCount <= maxCount;
  }
  
  function logChange(action, value) {
    console.log(`[Counter] ${action}: ${value}, Total: ${count}`);
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PUBLIC - Returned and accessible from outside
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  return {
    increment(amount = 1) {
      const newCount = count + amount;
      if (validateCount(newCount)) {
        count = newCount;
        logChange('Incremented', amount);
        return count;
      }
      throw new Error(`Cannot exceed ${maxCount}`);
    },
    
    decrement(amount = 1) {
      const newCount = count - amount;
      if (validateCount(newCount)) {
        count = newCount;
        logChange('Decremented', amount);
        return count;
      }
      throw new Error(`Cannot go below ${minCount}`);
    },
    
    getCount() {
      return count;
    },
    
    reset() {
      count = 0;
      logChange('Reset', 0);
      return count;
    }
  };
})();

// Usage
console.log(CounterModule.getCount()); // 0
CounterModule.increment(5);             // [Counter] Incremented: 5, Total: 5
CounterModule.decrement(2);             // [Counter] Decremented: 2, Total: 3
console.log(CounterModule.getCount()); // 3

// Private members are NOT accessible
console.log(CounterModule.count);       // undefined
console.log(CounterModule.validateCount); // undefined
```

### Revealing Module Pattern

A variation that defines all functions privately and only "reveals" the ones we want public.

```javascript
const UserModule = (function() {
  // Private state
  const users = [];
  let nextId = 1;
  
  // Private functions - ALL logic is here
  function findUserById(id) {
    return users.find(user => user.id === id);
  }
  
  function findUserByEmail(email) {
    return users.find(user => user.email === email);
  }
  
  function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }
  
  function validateUser(userData) {
    if (!userData.name || userData.name.length < 2) {
      throw new Error('Name must be at least 2 characters');
    }
    if (!validateEmail(userData.email)) {
      throw new Error('Invalid email format');
    }
    if (findUserByEmail(userData.email)) {
      throw new Error('Email already exists');
    }
    return true;
  }
  
  function createUser(userData) {
    validateUser(userData);
    
    const user = {
      id: nextId++,
      name: userData.name,
      email: userData.email,
      createdAt: new Date(),
      active: true
    };
    
    users.push(user);
    return { ...user }; // Return copy
  }
  
  function getUserById(id) {
    const user = findUserById(id);
    return user ? { ...user } : null;
  }
  
  function getAllUsers() {
    return users.map(user => ({ ...user })); // Return copies
  }
  
  function updateUser(id, updates) {
    const user = findUserById(id);
    if (!user) {
      throw new Error('User not found');
    }
    
    if (updates.email && updates.email !== user.email) {
      if (!validateEmail(updates.email)) {
        throw new Error('Invalid email format');
      }
      if (findUserByEmail(updates.email)) {
        throw new Error('Email already exists');
      }
    }
    
    Object.assign(user, updates, { updatedAt: new Date() });
    return { ...user };
  }
  
  function deleteUser(id) {
    const index = users.findIndex(user => user.id === id);
    if (index === -1) {
      throw new Error('User not found');
    }
    users.splice(index, 1);
    return true;
  }
  
  function getUserCount() {
    return users.length;
  }
  
  // Reveal public API - map private functions to public names
  return {
    create: createUser,
    get: getUserById,
    getAll: getAllUsers,
    update: updateUser,
    delete: deleteUser,
    count: getUserCount
  };
})();

// Usage
const user1 = UserModule.create({ name: 'Alice', email: 'alice@example.com' });
const user2 = UserModule.create({ name: 'Bob', email: 'bob@example.com' });

console.log(UserModule.count()); // 2
console.log(UserModule.get(1));  // { id: 1, name: 'Alice', ... }

UserModule.update(1, { name: 'Alice Smith' });
console.log(UserModule.getAll());

// Cannot access internal functions or data
console.log(UserModule.findUserById);   // undefined
console.log(UserModule.users);          // undefined
console.log(UserModule.validateEmail);  // undefined
```

### Module with Dependencies (Import)

```javascript
// Dependency injection into modules
const APIModule = (function($, config) {
  // Private
  const baseURL = config.apiURL;
  const timeout = config.timeout || 5000;
  
  async function request(endpoint, options = {}) {
    const url = baseURL + endpoint;
    
    try {
      const response = await $.ajax({
        url,
        timeout,
        ...options
      });
      return response;
    } catch (error) {
      console.error(`API Error: ${error.message}`);
      throw error;
    }
  }
  
  // Public API
  return {
    get: (endpoint) => request(endpoint, { method: 'GET' }),
    post: (endpoint, data) => request(endpoint, { method: 'POST', data }),
    put: (endpoint, data) => request(endpoint, { method: 'PUT', data }),
    delete: (endpoint) => request(endpoint, { method: 'DELETE' })
  };
})(jQuery, { apiURL: 'https://api.example.com', timeout: 10000 });
```

### Augmenting Modules

```javascript
// Original module
const MyModule = (function() {
  const privateData = [];
  
  return {
    add(item) {
      privateData.push(item);
    },
    get() {
      return [...privateData];
    }
  };
})();

// Augment with new functionality (loose augmentation)
const MyModule = (function(module) {
  // Add new public method
  module.remove = function(item) {
    // Note: Can't access original privateData!
    // This is a limitation of augmentation
    console.log('Remove called for:', item);
  };
  
  module.clear = function() {
    console.log('Clear called');
  };
  
  return module;
})(MyModule || {});
```

---

## 8.2 ES6 Modules

### Import/Export Syntax

ES6 modules are the **modern standard** for JavaScript modularity. They're statically analyzed, support tree shaking, and are natively supported in browsers and Node.js.

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// mathUtils.js - Named exports
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export const PI = 3.14159265359;
export const E = 2.71828182845;

export function add(a, b) {
  return a + b;
}

export function subtract(a, b) {
  return a - b;
}

export function multiply(a, b) {
  return a * b;
}

export function divide(a, b) {
  if (b === 0) throw new Error('Division by zero');
  return a / b;
}

// Private - not exported
function validateNumber(n) {
  return typeof n === 'number' && !isNaN(n);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// calculator.js - Default export
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export default class Calculator {
  constructor() {
    this.result = 0;
  }
  
  add(n) {
    this.result += n;
    return this;
  }
  
  subtract(n) {
    this.result -= n;
    return this;
  }
  
  multiply(n) {
    this.result *= n;
    return this;
  }
  
  divide(n) {
    if (n === 0) throw new Error('Division by zero');
    this.result /= n;
    return this;
  }
  
  clear() {
    this.result = 0;
    return this;
  }
  
  getResult() {
    return this.result;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// app.js - Importing
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Named imports
import { add, subtract, PI } from './mathUtils.js';

// Import all as namespace
import * as MathUtils from './mathUtils.js';

// Default import (can use any name)
import Calculator from './calculator.js';

// Mixed import
import Calculator, { PI, E } from './calculator.js';

// Rename imports
import { add as addition, subtract as subtraction } from './mathUtils.js';

// Usage
console.log(add(2, 3));           // 5
console.log(MathUtils.multiply(4, 5)); // 20
console.log(PI);                   // 3.14159265359

const calc = new Calculator();
console.log(calc.add(10).multiply(2).subtract(5).getResult()); // 15
```

### Dynamic Imports

```javascript
// Dynamic import - loaded on demand
async function loadModule(moduleName) {
  try {
    const module = await import(`./modules/${moduleName}.js`);
    return module;
  } catch (error) {
    console.error(`Failed to load module: ${moduleName}`);
    throw error;
  }
}

// Conditional loading
async function initializeApp(userRole) {
  // Always load core
  const { init } = await import('./core.js');
  init();
  
  // Conditionally load based on role
  if (userRole === 'admin') {
    const adminModule = await import('./admin.js');
    adminModule.setupAdminPanel();
  }
  
  // Lazy load heavy features
  document.getElementById('charts-btn').addEventListener('click', async () => {
    const { renderCharts } = await import('./charts.js');
    renderCharts();
  });
}

// Dynamic import with destructuring
async function loadAnalytics() {
  const { 
    trackEvent, 
    trackPageView, 
    setUser 
  } = await import('./analytics.js');
  
  trackPageView('/home');
}
```

### Re-exporting (Barrel Exports)

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// models/user.js
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export class User { /* ... */ }
export function createUser(data) { /* ... */ }
export function validateUser(user) { /* ... */ }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// models/product.js
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export class Product { /* ... */ }
export function createProduct(data) { /* ... */ }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// models/order.js
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export class Order { /* ... */ }
export function createOrder(data) { /* ... */ }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// models/index.js - Barrel file (re-exports everything)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export * from './user.js';
export * from './product.js';
export * from './order.js';

// Or selective re-exports with renaming
export { User, createUser } from './user.js';
export { Product as ProductModel } from './product.js';
export { Order, createOrder as newOrder } from './order.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// app.js - Clean import from barrel
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
import { User, Product, Order, createUser, createOrder } from './models/index.js';
// Or simply:
import { User, Product, Order } from './models';
```

---

## 8.3 CommonJS vs ES Modules

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CommonJS vs ES Modules                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  CommonJS (CJS)              â”‚  ES Modules (ESM)            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                              â”‚                              â”‚
â”‚  // Exporting                â”‚  // Exporting                â”‚
â”‚  module.exports = {...}      â”‚  export default ...          â”‚
â”‚  exports.foo = ...           â”‚  export const foo = ...      â”‚
â”‚                              â”‚                              â”‚
â”‚  // Importing                â”‚  // Importing                â”‚
â”‚  const mod = require('./m')  â”‚  import mod from './m.js'    â”‚
â”‚  const {foo} = require('./m')â”‚  import {foo} from './m.js'  â”‚
â”‚                              â”‚                              â”‚
â”‚  // Characteristics          â”‚  // Characteristics          â”‚
â”‚  â€¢ Synchronous loading       â”‚  â€¢ Async loading possible    â”‚
â”‚  â€¢ Dynamic (runtime)         â”‚  â€¢ Static (compile-time)     â”‚
â”‚  â€¢ Copies values             â”‚  â€¢ Live bindings             â”‚
â”‚  â€¢ Node.js default           â”‚  â€¢ Browser native            â”‚
â”‚  â€¢ .js or .cjs extension     â”‚  â€¢ .js or .mjs extension     â”‚
â”‚                              â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CommonJS Example

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// logger.cjs (CommonJS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fs = require('fs');
const path = require('path');

class Logger {
  constructor(logPath) {
    this.logPath = logPath;
  }
  
  log(message) {
    const timestamp = new Date().toISOString();
    const logEntry = `[${timestamp}] ${message}\n`;
    fs.appendFileSync(this.logPath, logEntry);
    console.log(logEntry);
  }
}

// Multiple ways to export
module.exports = Logger;

// Or export multiple things
module.exports = {
  Logger,
  createLogger: (path) => new Logger(path),
  defaultLogger: new Logger('./app.log')
};

// Or add to exports object
exports.Logger = Logger;
exports.version = '1.0.0';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// app.cjs (CommonJS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Logger = require('./logger.cjs');
const { createLogger, version } = require('./logger.cjs');

const logger = new Logger('./my-app.log');
logger.log('Application started');
```

### Key Differences in Behavior

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE BINDINGS (ESM) vs VALUE COPY (CJS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// counter.mjs (ES Module)
export let count = 0;
export function increment() {
  count++;
}

// main.mjs
import { count, increment } from './counter.mjs';
console.log(count);  // 0
increment();
console.log(count);  // 1 â† Live binding updates!

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// counter.cjs (CommonJS)
let count = 0;
function increment() {
  count++;
}
module.exports = { count, increment };

// main.cjs
const { count, increment } = require('./counter.cjs');
console.log(count);  // 0
increment();
console.log(count);  // 0 â† Still 0! Value was copied at require time

// To get updated value in CJS:
const counter = require('./counter.cjs');
counter.increment();
console.log(counter.count); // Still 0 - need to export getter
```

### Interoperability

```javascript
// package.json configuration
{
  "name": "my-package",
  "type": "module",  // Treat .js files as ES modules
  // OR
  "type": "commonjs"  // Treat .js files as CommonJS (default)
}

// File extensions override package.json:
// .mjs â†’ Always ES Module
// .cjs â†’ Always CommonJS

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Importing CJS from ESM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// myModule.cjs
module.exports = {
  hello: () => 'Hello from CJS'
};

// app.mjs
import cjsModule from './myModule.cjs';
console.log(cjsModule.hello()); // Works!

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Importing ESM from CJS (requires async)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// myModule.mjs
export const hello = () => 'Hello from ESM';

// app.cjs
// Cannot use require() for ESM!
// Must use dynamic import:
async function main() {
  const esmModule = await import('./myModule.mjs');
  console.log(esmModule.hello());
}
main();
```

---

## 8.4 Production Module Architecture

### Directory Structure

```
src/
â”œâ”€â”€ index.js                 # Application entry point
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ index.js            # Config barrel export
â”‚   â”œâ”€â”€ database.js
â”‚   â””â”€â”€ server.js
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ index.js            # Models barrel export
â”‚   â”œâ”€â”€ User.js
â”‚   â”œâ”€â”€ Product.js
â”‚   â””â”€â”€ Order.js
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ AuthService.js
â”‚   â”œâ”€â”€ UserService.js
â”‚   â””â”€â”€ PaymentService.js
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ AuthController.js
â”‚   â””â”€â”€ UserController.js
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ auth.js
â”‚   â”œâ”€â”€ validation.js
â”‚   â””â”€â”€ errorHandler.js
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ helpers.js
â”‚   â””â”€â”€ constants.js
â””â”€â”€ types/
    â””â”€â”€ index.d.ts          # TypeScript declarations
```

### Handling Circular Dependencies

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âŒ PROBLEM: Circular dependency
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// user.js
import { Order } from './order.js';  // Imports Order
export class User {
  getOrders() {
    return Order.findByUser(this.id);
  }
}

// order.js
import { User } from './user.js';  // Imports User - CIRCULAR!
export class Order {
  getUser() {
    return User.findById(this.userId);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âœ… SOLUTION 1: Dependency Injection
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// user.js
export class User {
  constructor(orderService) {
    this.orderService = orderService;
  }
  getOrders() {
    return this.orderService.findByUser(this.id);
  }
}

// order.js
export class Order {
  constructor(userService) {
    this.userService = userService;
  }
  getUser() {
    return this.userService.findById(this.userId);
  }
}

// app.js - Wire up dependencies
import { User } from './user.js';
import { Order } from './order.js';
// Inject services, not classes

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âœ… SOLUTION 2: Extract shared code to third module
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// relationships.js - Handles cross-model relationships
import { User } from './user.js';
import { Order } from './order.js';

export function getUserOrders(userId) {
  return Order.findByUser(userId);
}

export function getOrderUser(order) {
  return User.findById(order.userId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âœ… SOLUTION 3: Lazy imports (dynamic import)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// user.js
export class User {
  async getOrders() {
    const { Order } = await import('./order.js');
    return Order.findByUser(this.id);
  }
}
```

### Code Splitting Strategies

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Route-based splitting
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const routes = {
  '/': () => import('./pages/Home.js'),
  '/dashboard': () => import('./pages/Dashboard.js'),
  '/settings': () => import('./pages/Settings.js'),
  '/admin': () => import('./pages/Admin.js'),
};

async function loadRoute(path) {
  const loader = routes[path];
  if (!loader) {
    const NotFound = await import('./pages/NotFound.js');
    return NotFound.default;
  }
  const module = await loader();
  return module.default;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Feature-based splitting
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class FeatureManager {
  static #loadedFeatures = new Map();
  
  static async load(featureName) {
    if (this.#loadedFeatures.has(featureName)) {
      return this.#loadedFeatures.get(featureName);
    }
    
    let feature;
    switch (featureName) {
      case 'charts':
        feature = await import('./features/charts/index.js');
        break;
      case 'export':
        feature = await import('./features/export/index.js');
        break;
      case 'analytics':
        feature = await import('./features/analytics/index.js');
        break;
      default:
        throw new Error(`Unknown feature: ${featureName}`);
    }
    
    this.#loadedFeatures.set(featureName, feature);
    return feature;
  }
}

// Usage
document.getElementById('export-btn').addEventListener('click', async () => {
  const exportFeature = await FeatureManager.load('export');
  exportFeature.exportToPDF(data);
});
```

---

## Key Takeaways

1. **IIFE Module Pattern**: Classic approach using closures for privacy
2. **Revealing Module Pattern**: Define private, reveal public - cleaner API
3. **ES6 Modules**: Modern standard with static analysis and tree shaking
4. **Named vs Default Exports**: Named for utilities, default for main export
5. **Barrel Exports (index.js)**: Simplify imports with re-exports
6. **CommonJS vs ESM**: Know the differences for Node.js development
7. **Handle Circular Dependencies**: Use DI, shared modules, or lazy imports
8. **Code Splitting**: Load features on demand for better performance

> ğŸ’¡ **Interview Tip:** Be ready to explain the difference between CommonJS and ES Modules, especially live bindings vs value copies, and how to handle circular dependencies.

> ğŸ­ **Production Note:** Use ES Modules for new projects. They support tree shaking, have better static analysis, and are the future of JavaScript.
