# Chapter 12: OpenAPI, Documentation & Client Generation

## Introduction to OpenAPI

FastAPI automatically generates OpenAPI (formerly Swagger) documentation from your code, providing:
- Interactive API documentation
- API schema in standard format
- Client code generation
- API validation and testing

---

## Automatic Documentation

### Accessing Built-in Docs

```python
from fastapi import FastAPI

app = FastAPI(
    title="My API",
    description="A comprehensive API with great documentation",
    version="1.0.0"
)

@app.get("/items")
async def list_items():
    """List all items"""
    return {"items": []}

# Access documentation:
# Swagger UI: http://localhost:8000/docs
# ReDoc: http://localhost:8000/redoc
# OpenAPI JSON: http://localhost:8000/openapi.json
```

### Customizing OpenAPI Metadata

```python
from fastapi import FastAPI

app = FastAPI(
    title="E-Commerce API",
    description="""
# E-Commerce API

This API provides comprehensive e-commerce functionality.

## Features

* **Users** - User management and authentication
* **Products** - Product catalog management
* **Orders** - Order processing and tracking
* **Payments** - Payment processing

## Authentication

Use Bearer token authentication:
```
Authorization: Bearer <your_token>
```
    """,
    version="2.0.0",
    terms_of_service="https://example.com/terms",
    contact={
        "name": "API Support",
        "url": "https://example.com/support",
        "email": "support@example.com"
    },
    license_info={
        "name": "MIT",
        "url": "https://opensource.org/licenses/MIT"
    }
)
```

### Custom OpenAPI URL

```python
app = FastAPI(
    title="My API",
    # Customize docs URLs
    docs_url="/documentation",  # Default: /docs
    redoc_url="/redocumentation",  # Default: /redoc
    openapi_url="/api/openapi.json"  # Default: /openapi.json
)

# Disable documentation in production
app_production = FastAPI(
    title="Production API",
    docs_url=None,  # Disable Swagger UI
    redoc_url=None,  # Disable ReDoc
    openapi_url=None  # Disable OpenAPI schema
)
```

---

## Documenting Endpoints

### Basic Endpoint Documentation

```python
from fastapi import FastAPI, Path, Query
from typing import Optional

app = FastAPI()

@app.get(
    "/items/{item_id}",
    summary="Get an item",
    description="Retrieve a specific item by its ID",
    response_description="The requested item"
)
async def get_item(
    item_id: int = Path(..., description="The ID of the item to get", ge=1),
    q: Optional[str] = Query(None, description="Optional search query")
):
    """
    Retrieve an item with all its information:
    
    - **item_id**: Required item identifier
    - **q**: Optional query for filtering
    """
    return {"item_id": item_id, "q": q}
```

### Documenting with Examples

```python
from pydantic import BaseModel, Field

class Item(BaseModel):
    name: str = Field(..., example="Laptop")
    description: str = Field(..., example="High-performance laptop")
    price: float = Field(..., example=999.99, gt=0)
    tax: Optional[float] = Field(None, example=99.99)
    
    model_config = {
        "json_schema_extra": {
            "examples": [
                {
                    "name": "MacBook Pro",
                    "description": "Apple laptop",
                    "price": 1999.99,
                    "tax": 199.99
                },
                {
                    "name": "Dell XPS",
                    "description": "Windows laptop",
                    "price": 1499.99,
                    "tax": 149.99
                }
            ]
        }
    }

@app.post("/items")
async def create_item(item: Item):
    """Create a new item"""
    return item
```

### Response Examples

```python
from fastapi import FastAPI
from fastapi.responses import JSONResponse

@app.get(
    "/items/{item_id}",
    responses={
        200: {
            "description": "Successful Response",
            "content": {
                "application/json": {
                    "example": {
                        "id": 1,
                        "name": "Item Name",
                        "price": 29.99
                    }
                }
            }
        },
        404: {
            "description": "Item not found",
            "content": {
                "application/json": {
                    "example": {
                        "detail": "Item not found"
                    }
                }
            }
        }
    }
)
async def get_item(item_id: int):
    """Get item by ID with documented responses"""
    return {"id": item_id, "name": "Item", "price": 29.99}
```

---

## Advanced Documentation Features

### Tags for Organization

```python
from fastapi import FastAPI

app = FastAPI()

# Define tags with descriptions
tags_metadata = [
    {
        "name": "users",
        "description": "Operations with users. Authentication and user management.",
    },
    {
        "name": "items",
        "description": "Manage items. CRUD operations for items.",
        "externalDocs": {
            "description": "Items external docs",
            "url": "https://example.com/docs/items",
        },
    },
    {
        "name": "admin",
        "description": "Administrative operations (requires admin role)",
    }
]

app = FastAPI(openapi_tags=tags_metadata)

@app.get("/users", tags=["users"])
async def list_users():
    """List all users"""
    return {"users": []}

@app.post("/users", tags=["users"])
async def create_user():
    """Create new user"""
    return {"id": 1}

@app.get("/items", tags=["items"])
async def list_items():
    """List all items"""
    return {"items": []}

@app.get("/admin/stats", tags=["admin"])
async def admin_stats():
    """Get admin statistics"""
    return {"stats": {}}
```

### Deprecating Endpoints

```python
@app.get(
    "/old-endpoint",
    deprecated=True,
    tags=["legacy"],
    summary="Old endpoint (deprecated)"
)
async def old_endpoint():
    """
    This endpoint is deprecated and will be removed in v2.0.
    Use /new-endpoint instead.
    """
    return {"message": "Please use /new-endpoint"}

@app.get("/new-endpoint", tags=["current"])
async def new_endpoint():
    """New and improved endpoint"""
    return {"message": "This is the new endpoint"}
```

### Multiple Response Models

```python
from typing import Union
from pydantic import BaseModel

class ItemResponse(BaseModel):
    id: int
    name: str
    price: float

class ErrorResponse(BaseModel):
    error: str
    message: str

@app.get(
    "/items/{item_id}",
    response_model=Union[ItemResponse, ErrorResponse],
    responses={
        200: {
            "model": ItemResponse,
            "description": "Successfully retrieved item"
        },
        404: {
            "model": ErrorResponse,
            "description": "Item not found"
        }
    }
)
async def get_item(item_id: int):
    """Get item with multiple possible responses"""
    if item_id > 100:
        return ErrorResponse(
            error="not_found",
            message="Item not found"
        )
    return ItemResponse(id=item_id, name="Item", price=29.99)
```

---

## Customizing OpenAPI Schema

### Custom OpenAPI Function

```python
from fastapi import FastAPI
from fastapi.openapi.utils import get_openapi

app = FastAPI()

def custom_openapi():
    """Customize OpenAPI schema"""
    if app.openapi_schema:
        return app.openapi_schema
    
    openapi_schema = get_openapi(
        title="Custom API",
        version="2.5.0",
        description="This is a custom OpenAPI schema",
        routes=app.routes,
    )
    
    # Add custom fields
    openapi_schema["info"]["x-logo"] = {
        "url": "https://example.com/logo.png"
    }
    
    # Add security schemes
    openapi_schema["components"]["securitySchemes"] = {
        "Bearer": {
            "type": "http",
            "scheme": "bearer",
            "bearerFormat": "JWT"
        },
        "ApiKey": {
            "type": "apiKey",
            "in": "header",
            "name": "X-API-Key"
        }
    }
    
    # Add servers
    openapi_schema["servers"] = [
        {"url": "https://api.example.com", "description": "Production"},
        {"url": "https://staging.api.example.com", "description": "Staging"},
        {"url": "http://localhost:8000", "description": "Development"}
    ]
    
    app.openapi_schema = openapi_schema
    return app.openapi_schema

app.openapi = custom_openapi
```

### Adding Custom Fields to Schema

```python
from pydantic import BaseModel

class Item(BaseModel):
    name: str
    price: float
    
    model_config = {
        "json_schema_extra": {
            "x-custom-field": "custom value",
            "examples": [
                {"name": "Laptop", "price": 999.99}
            ]
        }
    }

@app.post(
    "/items",
    openapi_extra={
        "x-code-samples": [
            {
                "lang": "Python",
                "source": """
import requests
response = requests.post(
    "http://api.example.com/items",
    json={"name": "Laptop", "price": 999.99}
)
                """
            },
            {
                "lang": "JavaScript",
                "source": """
fetch('http://api.example.com/items', {
    method: 'POST',
    body: JSON.stringify({name: 'Laptop', price: 999.99})
})
                """
            }
        ]
    }
)
async def create_item(item: Item):
    """Create item with code samples"""
    return item
```

---

## Client Code Generation

### Generate TypeScript Client

```bash
# Install OpenAPI Generator
# Using npm:
npm install @openapitools/openapi-generator-cli -g

# Generate TypeScript client
openapi-generator-cli generate \
    -i http://localhost:8000/openapi.json \
    -g typescript-axios \
    -o ./client/typescript

# Generate Python client
openapi-generator-cli generate \
    -i http://localhost:8000/openapi.json \
    -g python \
    -o ./client/python
```

### Using Generated TypeScript Client

```typescript
// client/typescript/example.ts
import { Configuration, DefaultApi } from './generated';

const config = new Configuration({
    basePath: 'http://localhost:8000',
    apiKey: 'your-api-key'
});

const api = new DefaultApi(config);

// Use the client
async function getItems() {
    const response = await api.listItems();
    console.log(response.data);
}

// Create item
async function createItem() {
    const item = {
        name: 'New Item',
        price: 29.99
    };
    const response = await api.createItem(item);
    console.log(response.data);
}
```

### Generate with openapi-python-client

```bash
# Install
uv pip install openapi-python-client

# Generate Python client
openapi-python-client generate \
    --url http://localhost:8000/openapi.json \
    --output-path ./client

# Or from local file
openapi-python-client generate \
    --path ./openapi.json \
    --output-path ./client
```

### Using Generated Python Client

```python
# client/example.py
from my_api_client import Client
from my_api_client.api.items import list_items, create_item
from my_api_client.models import ItemCreate

# Create client
client = Client(base_url="http://localhost:8000")

# List items
items = list_items.sync(client=client)
print(items)

# Create item
new_item = ItemCreate(name="New Item", price=29.99)
created = create_item.sync(client=client, json_body=new_item)
print(created)

# Async usage
async def async_example():
    items = await list_items.asyncio(client=client)
    print(items)
```

---

## API Versioning in Documentation

### Multiple API Versions

```python
from fastapi import FastAPI, APIRouter

# V1 API
v1_router = APIRouter(prefix="/api/v1", tags=["v1"])

@v1_router.get("/items")
async def list_items_v1():
    """List items (v1)"""
    return {"items": [], "version": "1.0"}

# V2 API
v2_router = APIRouter(prefix="/api/v2", tags=["v2"])

@v2_router.get("/items")
async def list_items_v2():
    """List items (v2) - Enhanced with pagination"""
    return {"items": [], "version": "2.0", "total": 0, "page": 1}

# Main app
app = FastAPI(
    title="Versioned API",
    description="API with multiple versions",
    version="2.0.0"
)

app.include_router(v1_router)
app.include_router(v2_router)

# Separate OpenAPI schemas per version
@app.get("/openapi/v1.json", include_in_schema=False)
async def get_openapi_v1():
    from fastapi.openapi.utils import get_openapi
    return get_openapi(
        title="API v1",
        version="1.0.0",
        routes=[route for route in app.routes if "/api/v1" in str(route.path)]
    )

@app.get("/openapi/v2.json", include_in_schema=False)
async def get_openapi_v2():
    from fastapi.openapi.utils import get_openapi
    return get_openapi(
        title="API v2",
        version="2.0.0",
        routes=[route for route in app.routes if "/api/v2" in str(route.path)]
    )
```

---

## Documentation Best Practices

### Comprehensive Example Documentation

```python
from fastapi import FastAPI, HTTPException, Path, Query, Body
from pydantic import BaseModel, Field, EmailStr
from typing import Optional, List
from enum import Enum

app = FastAPI(
    title="User Management API",
    description="""
# User Management API

Complete user management system with authentication.

## Authentication

This API uses JWT Bearer tokens for authentication:

```
Authorization: Bearer <your_jwt_token>
```

Get your token by calling the `/auth/login` endpoint.

## Rate Limiting

- 100 requests per minute per IP
- 1000 requests per hour per authenticated user

## Error Codes

| Code | Description |
|------|-------------|
| 400  | Bad Request - Invalid input |
| 401  | Unauthorized - Missing or invalid token |
| 403  | Forbidden - Insufficient permissions |
| 404  | Not Found - Resource doesn't exist |
| 429  | Too Many Requests - Rate limit exceeded |
| 500  | Internal Server Error |
    """,
    version="1.0.0",
    contact={
        "name": "API Support",
        "email": "api@example.com",
        "url": "https://example.com/support"
    },
    license_info={
        "name": "Apache 2.0",
        "url": "https://www.apache.org/licenses/LICENSE-2.0.html"
    }
)

# Tags
tags_metadata = [
    {
        "name": "authentication",
        "description": "Login and token management"
    },
    {
        "name": "users",
        "description": "User CRUD operations"
    }
]

app = FastAPI(openapi_tags=tags_metadata, **app.init_kwargs)

class UserRole(str, Enum):
    """User role enum"""
    admin = "admin"
    user = "user"
    guest = "guest"

class UserCreate(BaseModel):
    """User creation schema"""
    username: str = Field(
        ...,
        min_length=3,
        max_length=50,
        pattern="^[a-zA-Z0-9_-]+$",
        example="john_doe",
        description="Unique username (alphanumeric, underscore, hyphen)"
    )
    email: EmailStr = Field(
        ...,
        example="john@example.com",
        description="Valid email address"
    )
    password: str = Field(
        ...,
        min_length=8,
        example="SecurePass123!",
        description="Strong password (min 8 chars, uppercase, lowercase, digit)"
    )
    full_name: Optional[str] = Field(
        None,
        example="John Doe",
        description="User's full name"
    )
    
    model_config = {
        "json_schema_extra": {
            "examples": [
                {
                    "username": "john_doe",
                    "email": "john@example.com",
                    "password": "SecurePass123!",
                    "full_name": "John Doe"
                }
            ]
        }
    }

class UserResponse(BaseModel):
    """User response schema"""
    id: int = Field(..., example=1)
    username: str = Field(..., example="john_doe")
    email: EmailStr = Field(..., example="john@example.com")
    full_name: Optional[str] = Field(None, example="John Doe")
    role: UserRole = Field(..., example=UserRole.user)
    is_active: bool = Field(..., example=True)

@app.post(
    "/users",
    response_model=UserResponse,
    status_code=201,
    tags=["users"],
    summary="Create a new user",
    description="""
Create a new user account with the provided information.

## Requirements

- Username must be unique
- Email must be unique and valid
- Password must meet security requirements

## Returns

The created user object without sensitive information.
    """,
    responses={
        201: {
            "description": "User successfully created",
            "content": {
                "application/json": {
                    "example": {
                        "id": 1,
                        "username": "john_doe",
                        "email": "john@example.com",
                        "full_name": "John Doe",
                        "role": "user",
                        "is_active": True
                    }
                }
            }
        },
        400: {
            "description": "Invalid input or user already exists",
            "content": {
                "application/json": {
                    "example": {
                        "detail": "Username already registered"
                    }
                }
            }
        },
        422: {
            "description": "Validation error",
            "content": {
                "application/json": {
                    "example": {
                        "detail": [
                            {
                                "loc": ["body", "email"],
                                "msg": "value is not a valid email address",
                                "type": "value_error.email"
                            }
                        ]
                    }
                }
            }
        }
    }
)
async def create_user(
    user: UserCreate = Body(
        ...,
        description="User creation data",
        example={
            "username": "john_doe",
            "email": "john@example.com",
            "password": "SecurePass123!",
            "full_name": "John Doe"
        }
    )
):
    """
    Create a new user account.
    
    This endpoint creates a new user with the provided credentials.
    The password will be securely hashed before storage.
    
    - **username**: Unique username (3-50 characters)
    - **email**: Valid email address
    - **password**: Strong password (min 8 characters)
    - **full_name**: Optional full name
    """
    # Implementation here
    return UserResponse(
        id=1,
        username=user.username,
        email=user.email,
        full_name=user.full_name,
        role=UserRole.user,
        is_active=True
    )

@app.get(
    "/users/{user_id}",
    response_model=UserResponse,
    tags=["users"],
    summary="Get user by ID",
    description="Retrieve detailed information about a specific user"
)
async def get_user(
    user_id: int = Path(
        ...,
        ge=1,
        example=1,
        description="The unique identifier of the user"
    )
):
    """
    Get user details by ID.
    
    Returns complete user information including:
    - Basic profile data
    - Account status
    - Role information
    """
    # Implementation
    pass

@app.get(
    "/users",
    response_model=List[UserResponse],
    tags=["users"],
    summary="List all users",
    description="Get a paginated list of users with optional filtering"
)
async def list_users(
    skip: int = Query(0, ge=0, description="Number of users to skip"),
    limit: int = Query(10, ge=1, le=100, description="Maximum number of users to return"),
    role: Optional[UserRole] = Query(None, description="Filter by user role"),
    is_active: Optional[bool] = Query(None, description="Filter by active status")
):
    """
    List users with pagination and filtering.
    
    ## Pagination
    
    Use `skip` and `limit` parameters for pagination:
    - skip: Number of records to skip (offset)
    - limit: Maximum records to return (max 100)
    
    ## Filtering
    
    Optional filters:
    - role: Filter by user role (admin, user, guest)
    - is_active: Filter by account status
    
    ## Example
    
    ```
    GET /users?skip=0&limit=20&role=admin&is_active=true
    ```
    """
    # Implementation
    pass
```

---

## Testing Documentation

### Validate OpenAPI Schema

```python
# test_openapi.py
import pytest
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

def test_openapi_schema():
    """Test OpenAPI schema is valid"""
    response = client.get("/openapi.json")
    assert response.status_code == 200
    
    schema = response.json()
    
    # Verify required fields
    assert "openapi" in schema
    assert "info" in schema
    assert "paths" in schema
    
    # Verify metadata
    assert schema["info"]["title"] == "My API"
    assert schema["info"]["version"] == "1.0.0"

def test_all_endpoints_documented():
    """Verify all endpoints have descriptions"""
    response = client.get("/openapi.json")
    schema = response.json()
    
    for path, methods in schema["paths"].items():
        for method, details in methods.items():
            if method in ["get", "post", "put", "delete", "patch"]:
                assert "summary" in details or "description" in details, \
                    f"Endpoint {method.upper()} {path} missing documentation"

def test_response_models_defined():
    """Verify response models are defined"""
    response = client.get("/openapi.json")
    schema = response.json()
    
    for path, methods in schema["paths"].items():
        for method, details in methods.items():
            if method in ["get", "post", "put", "delete", "patch"]:
                assert "responses" in details, \
                    f"Endpoint {method.upper()} {path} missing response definitions"
```

---

## Summary

In Chapter 12, you learned:
- Accessing and customizing automatic documentation
- Documenting endpoints with descriptions and examples
- Using tags for organization
- Multiple response models and error documentation
- Customizing OpenAPI schema
- Generating client code from OpenAPI spec
- API versioning in documentation
- Best practices for comprehensive documentation
- Testing documentation quality

**Documentation Checklist:**
- ✅ Add meaningful descriptions to all endpoints
- ✅ Include request/response examples
- ✅ Document all possible response codes
- ✅ Use tags to organize endpoints
- ✅ Add authentication documentation
- ✅ Include rate limiting information
- ✅ Provide code samples
- ✅ Version your API properly
- ✅ Test OpenAPI schema validity

**Next: Chapter 13 - Deployment & Production Concerns**